<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Planner</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          },
          boxShadow: {
            'card': '0 18px 40px rgba(15,23,42,0.25)'
          },
          borderRadius: {
            'xl2': '1.25rem'
          }
        }
      }
    }
  </script>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-gradient-to-b from-sky-200 via-slate-50 to-white min-h-screen">
  <div id="app" class="min-h-screen">
    <div class="max-w-md mx-auto relative pb-24 px-4 pt-4">
      <!-- Header -->
      <header class="flex items-start justify-between gap-3 mb-3">
        <div class="flex items-start gap-2">
          <!-- Hamburger -->
          <button
            class="w-9 h-9 rounded-full bg-white/80 shadow flex items-center justify-center mr-1"
            @click="sidebarOpen = true"
          >
            <div class="space-y-0.5">
              <span class="block w-4 h-0.5 bg-slate-800 rounded"></span>
              <span class="block w-4 h-0.5 bg-slate-800 rounded"></span>
              <span class="block w-4 h-0.5 bg-slate-800 rounded"></span>
            </div>
          </button>
          <div>
            <div class="text-lg font-bold text-slate-900 flex items-center gap-1">
              {{ currentTrip?.name || 'æœªå‘½åæ—…ç¨‹' }}
              <span class="px-2 py-0.5 rounded-full text-[10px] bg-primary-50 text-primary-700">
                {{ currentTrip?.destination || 'æœªè¨­å®šç›®çš„åœ°' }}
              </span>
            </div>
            <div class="text-xs text-slate-500 mt-0.5">
              {{ dateRangeText }}
            </div>
          </div>
        </div>

        <div class="text-right text-xs text-slate-500">
          <div v-if="rateDisplay">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-primary-50 text-primary-700">
              {{ rateDisplay }}
            </span>
          </div>
          <div v-else>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">
              {{ currencyNote }}
            </span>
          </div>
        </div>
      </header>

      <!-- Trip basic setting card -->
      <section class="bg-white/90 backdrop-blur rounded-xl2 shadow-card p-3 mb-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-slate-800">æ—…ç¨‹è¨­å®š</div>
          <button
            class="text-[11px] text-primary-600 px-2 py-1 rounded-full bg-primary-50"
            @click="tripSettingCollapsed = !tripSettingCollapsed"
          >
            {{ tripSettingCollapsed ? 'å±•é–‹è¨­å®š' : 'æ”¶åˆè¨­å®š' }}
          </button>
        </div>

        <div v-show="!tripSettingCollapsed" class="space-y-2">
          <!-- select trip / new / delete -->
          <div class="flex gap-2 items-center">
            <div class="flex-1">
              <div class="text-[11px] text-slate-500 mb-1">é¸æ“‡æ—…ç¨‹</div>
              <select
                v-model="root.activeTripId"
                @change="onTripSwitch"
                class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
              >
                <option
                  v-for="t in root.trips"
                  :key="t.id"
                  :value="t.id"
                >
                  {{ t.name || 'æœªå‘½åæ—…ç¨‹' }}
                </option>
              </select>
            </div>
            <button
              class="px-3 py-1.5 text-[12px] rounded-full bg-primary-50 text-primary-700 shrink-0"
              @click="createTrip"
            >
              ï¼‹ æ–°æ—…ç¨‹
            </button>
          </div>

          <div class="flex items-center gap-2 text-[11px] text-slate-500">
            <button
              class="px-3 py-1.5 rounded-full bg-rose-50 text-rose-600 text-[11px]"
              @click="deleteCurrentTrip"
            >
              åˆªé™¤ç›®å‰æ—…ç¨‹
            </button>
            <span>* åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œé©åˆåˆªé™¤æ¸¬è©¦ç”¨æ—…ç¨‹</span>
          </div>

          <div class="border-t border-slate-100 my-2"></div>

          <!-- name / dest / currency -->
          <div class="space-y-2">
            <div>
              <div class="text-[11px] text-slate-500 mb-1">æ—…ç¨‹åç¨±</div>
              <input
                v-model="currentTrip.name"
                placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥è‡ªç”±è¡Œ"
                class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
              />
            </div>
            <div class="flex gap-2">
              <div class="flex-1">
                <div class="text-[11px] text-slate-500 mb-1">ç›®çš„åœ°åŸå¸‚ / å€åŸŸ</div>
                <input
                  v-model="currentTrip.destination"
                  placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€æ­æ´²â€¦"
                  class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="w-28">
                <div class="text-[11px] text-slate-500 mb-1">ä¸»è¦è²¨å¹£</div>
                <select
                  v-model="currentTrip.currency"
                  class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                >
                  <option value="KRW">KRW éŸ“å…ƒ</option>
                  <option value="JPY">JPY æ—¥åœ“</option>
                  <option value="TWD">TWD æ–°å°å¹£</option>
                  <option value="HKD">HKD æ¸¯å¹£</option>
                  <option value="USD">USD ç¾å…ƒ</option>
                  <option value="EUR">EUR æ­å…ƒ</option>
                </select>
              </div>
            </div>
            <div class="flex gap-2">
              <div class="flex-1">
                <div class="text-[11px] text-slate-500 mb-1">å‡ºç™¼æ—¥æœŸ</div>
                <input
                  type="date"
                  v-model="currentTrip.startDate"
                  class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="w-24">
                <div class="text-[11px] text-slate-500 mb-1">å¤©æ•¸</div>
                <input
                  type="number"
                  min="1"
                  max="30"
                  v-model.number="currentTrip.daysCount"
                  class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
            </div>
            <div class="flex gap-2 justify-between items-center pt-1">
              <button
                class="flex-1 h-9 rounded-full bg-primary-600 text-white text-[13px]"
                @click="applyTripSetting"
              >
                å¥—ç”¨è®Šæ›´
              </button>
              <button
                class="h-9 px-3 rounded-full bg-slate-100 text-[12px] text-slate-600"
                @click="resetCurrentTrip"
              >
                æ¸…ç©ºæœ¬æ—…ç¨‹è³‡æ–™
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Main card by view -->
      <section class="mt-2">
        <!-- Itinerary -->
        <div v-if="currentView === 'itinerary'">
          <div class="bg-white/90 backdrop-blur rounded-xl2 shadow-card p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-semibold text-slate-800">æ¯æ—¥è¡Œç¨‹</div>
              <div class="flex items-center text-[11px] px-2 py-1 rounded-full bg-primary-50 text-primary-700">
                <span class="mr-1">ğŸ“</span>
                <span>{{ currentTrip.destination || 'ç›®çš„åœ°æœªè¨­å®š' }}</span>
              </div>
            </div>

            <!-- Day chips -->
            <div class="flex gap-2 overflow-x-auto pb-1 mb-2">
              <button
                class="min-w-[70px] px-2 py-1 rounded-2xl text-[11px] text-center"
                :class="currentTrip.activeDayId === 'prep'
                         ? 'bg-primary-600 text-white'
                         : 'bg-primary-50 text-primary-700'"
                @click="setActiveDay('prep')"
              >
                <div class="font-semibold text-xs">è¡Œå‰</div>
                <div class="opacity-80">å¾…è¾¦</div>
              </button>
              <button
                v-for="d in currentTrip.days"
                :key="d.id"
                class="min-w-[70px] px-2 py-1 rounded-2xl text-[11px] text-center"
                :class="currentTrip.activeDayId === d.id
                         ? 'bg-primary-600 text-white'
                         : 'bg-primary-50 text-primary-700'"
                @click="setActiveDay(d.id)"
              >
                <div class="font-semibold text-xs">{{ d.label }}</div>
                <div class="opacity-80">{{ formatDateMMDD(d.date) }}</div>
              </button>
            </div>

            <!-- Day content -->
            <div v-if="currentTrip.activeDayId === 'prep'">
              <!-- è¡Œå‰è¼¸å…¥ -->
              <div>
                <div class="text-[11px] text-slate-500 mb-1">æ–°å¢ä¸€é …è¡Œå‰æº–å‚™</div>
                <div class="flex gap-2">
                  <input
                    v-model="prepInput"
                    placeholder="ä¾‹å¦‚ï¼šè¾¦æ—…éŠä¿éšªã€æ›å¤–å¹£ã€è²·ç¶²å¡â€¦"
                    class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                  />
                  <button
                    class="w-9 h-9 rounded-full bg-primary-600 text-white text-lg flex items-center justify-center"
                    @click="addPrepItem"
                  >
                    ï¼‹
                  </button>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-[11px] text-slate-500 mb-1">è¡Œå‰æº–å‚™æ¸…å–®</div>
                <div v-if="!currentTrip.checklist.length" class="text-[12px] text-slate-400 text-center py-3">
                  ç›®å‰æ²’æœ‰è¡Œå‰å¾…è¾¦ï¼Œå¯ä»¥åœ¨ä¸Šæ–¹æ–°å¢ã€‚
                </div>
                <div v-else class="space-y-1">
                  <div
                    v-for="item in currentTrip.checklist"
                    :key="item.id"
                    class="flex items-center gap-2 text-[13px]"
                  >
                    <input
                      type="checkbox"
                      class="w-4 h-4 rounded border-slate-300"
                      v-model="item.done"
                      @change="saveRoot()"
                    />
                    <div
                      class="flex-1"
                      :class="item.done ? 'line-through text-slate-400' : 'text-slate-700'"
                    >
                      {{ item.text }}
                    </div>
                    <button
                      class="w-7 h-7 rounded-full bg-rose-50 text-rose-500 text-xs"
                      @click="removePrepItem(item.id)"
                    >
                      âœ•
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div v-else>
              <!-- æ–°å¢è¡Œç¨‹ -->
              <div>
                <div class="text-[11px] text-slate-500 mb-1">æ–°å¢è¡Œç¨‹é …ç›®</div>
                <div class="flex gap-2 mb-1.5">
                  <input
                    type="time"
                    v-model="itForm.time"
                    class="w-24 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                  />
                  <input
                    v-model="itForm.title"
                    placeholder="è¡Œç¨‹åç¨±ï¼ˆåœ°æ¨™/åœ°å€ï¼‰"
                    class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                  />
                </div>
                <textarea
                  v-model="itForm.note"
                  placeholder="å‚™è¨»ï¼ˆäº¤é€šæ–¹å¼ã€é–€ç¥¨ç­‰ï¼Œå¯ç•™ç™½ï¼‰"
                  rows="2"
                  class="w-full rounded-2xl border border-slate-200 text-[13px] px-3 py-2 bg-slate-50"
                ></textarea>
                <div class="mt-2 flex justify-end">
                  <button
                    class="px-4 h-9 rounded-full bg-primary-600 text-white text-[13px]"
                    @click="submitItinerary"
                  >
                    {{ editingItId ? 'å„²å­˜è¡Œç¨‹' : 'ï¼‹ æ–°å¢è¡Œç¨‹' }}
                  </button>
                </div>
              </div>

              <!-- è¡Œç¨‹åˆ—è¡¨ -->
              <div class="mt-3">
                <div v-if="!currentDayItinerary.length" class="text-[12px] text-slate-400 text-center py-3">
                  é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œä¸‹æ–¹å¯ä»¥æ–°å¢ä¸€ç­†ï½
                </div>
                <div v-else class="space-y-2">
                  <div
                    v-for="item in currentDayItinerarySorted"
                    :key="item.id"
                    class="flex items-start gap-2 bg-slate-50 rounded-2xl px-3 py-2"
                  >
                    <div class="flex-1">
                      <div class="text-[11px] text-slate-500">
                        {{ item.time || 'æ™‚é–“æœªå¡«å¯«' }}
                      </div>
                      <div class="flex items-center gap-1">
                        <div class="font-semibold text-[13px] text-slate-800">
                          {{ item.title || 'æœªå‘½åè¡Œç¨‹' }}
                        </div>
                        <button
                          class="text-[11px] text-primary-700 px-2 py-0.5 rounded-full bg-primary-50"
                          @click="openMap(item)"
                        >
                          åœ°åœ–
                        </button>
                      </div>
                      <div v-if="item.note" class="text-[12px] text-slate-600 mt-0.5">
                        {{ item.note }}
                      </div>
                    </div>
                    <div class="flex flex-col gap-1 items-end">
                      <button
                        class="text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-600"
                        @click="editItinerary(item)"
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        class="w-7 h-7 rounded-full bg-rose-50 text-rose-500 text-xs"
                        @click="removeItinerary(item.id)"
                      >
                        âœ•
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Flights -->
        <div v-if="currentView === 'flights'">
          <div class="bg-white/90 backdrop-blur rounded-xl2 shadow-card p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-semibold text-slate-800">èˆªç­è³‡è¨Š</div>
            </div>

            <!-- Flight list -->
            <div class="space-y-2 mb-3">
              <div v-if="!currentTrip.flights.length" class="text-[12px] text-slate-400 text-center py-3">
                ç›®å‰å°šæœªæ–°å¢èˆªç­ã€‚
              </div>
              <div
                v-for="f in flightsSorted"
                :key="f.id"
                class="rounded-2xl bg-gradient-to-r from-primary-600 to-sky-500 text-white px-3 py-3 relative shadow"
              >
                <button
                  class="absolute top-1.5 right-1.5 w-6 h-6 rounded-full bg-rose-500 text-xs flex items-center justify-center text-rose-50"
                  @click="removeFlight(f.id)"
                >
                  âœ•
                </button>
                <div class="flex justify-between text-[11px] opacity-90 mb-1">
                  <div>{{ formatDateMMDD(f.date) }}{{ f.time ? ' Â· ' + f.time : '' }}</div>
                  <div>{{ f.note }}</div>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold tracking-[0.2em]">{{ f.from || '???' }}</div>
                    <div class="text-[10px] opacity-80">FROM</div>
                  </div>
                  <div class="text-2xl">âœˆï¸</div>
                  <div class="text-right">
                    <div class="text-2xl font-bold tracking-[0.2em]">{{ f.to || '???' }}</div>
                    <div class="text-[10px] opacity-80">TO</div>
                  </div>
                </div>
                <div class="text-[11px] opacity-90 mt-1">
                  ç­æ©Ÿï¼š{{ f.flightNo || 'æœªå¡«å¯«' }}
                </div>
              </div>
            </div>

            <!-- Add flight -->
            <div class="space-y-2 border-t border-slate-100 pt-2">
              <div class="text-[11px] text-slate-500">æ–°å¢èˆªç­</div>
              <div class="flex gap-2">
                <input
                  type="date"
                  v-model="flightForm.date"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <input
                  v-model="flightForm.flightNo"
                  placeholder="ç­æ©Ÿè™Ÿï¼ˆä¾‹å¦‚ï¼šBR87ï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="flex gap-2">
                <input
                  v-model="flightForm.from"
                  placeholder="å‡ºç™¼åœ°ï¼ˆTPEï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <input
                  v-model="flightForm.to"
                  placeholder="æŠµé”åœ°ï¼ˆCDGï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="flex gap-2">
                <input
                  type="time"
                  v-model="flightForm.time"
                  class="w-28 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <input
                  v-model="flightForm.note"
                  placeholder="å‚™è¨»ï¼ˆå»ç¨‹ï¼å›ç¨‹â€¦ï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="flex justify-end">
                <button
                  class="px-4 h-9 rounded-full bg-primary-600 text-white text-[13px]"
                  @click="addFlight"
                >
                  ï¼‹ æ–°å¢èˆªç­
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Expenses -->
        <div v-if="currentView === 'expenses'">
          <div class="bg-white/90 backdrop-blur rounded-xl2 shadow-card p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-semibold text-slate-800">æ—…è²»ç®¡ç†</div>
            </div>

            <!-- Rate setting -->
            <div class="space-y-1 mb-2">
              <div class="text-[11px] text-slate-500">åŒ¯ç‡è¨­å®šï¼ˆ{{ currentCurrency }} âœ TWDï¼‰</div>
              <div class="flex gap-2">
                <input
                  v-model.number="rateInput"
                  type="number"
                  step="0.0001"
                  placeholder="1 {{ currentCurrency }} = ? TWD"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <button
                  class="px-3 h-9 rounded-full bg-slate-100 text-[12px] text-slate-600"
                  @click="fetchRate"
                  :disabled="currentCurrency === 'TWD'"
                >
                  æŸ¥è©¢åŒ¯ç‡
                </button>
                <button
                  class="px-3 h-9 rounded-full bg-primary-600 text-white text-[12px]"
                  @click="saveRateInput"
                >
                  å„²å­˜åŒ¯ç‡
                </button>
              </div>
              <div class="text-[11px] text-slate-500">
                {{ rateInfoText }}
              </div>
            </div>

            <!-- Summary -->
            <div class="rounded-2xl bg-gradient-to-r from-primary-600 to-sky-500 text-white px-3 py-3 mb-2 shadow">
              <div class="text-[11px] opacity-85">ç¸½æ”¯å‡ºï¼ˆ{{ currentCurrency }}ï¼‰</div>
              <div class="text-2xl font-bold">{{ totalAmount.toFixed(2).replace(/\.?0+$/,'') }}</div>
              <div class="text-[11px] opacity-90 mt-0.5">
                ç´„ TWD {{ totalTwd.toFixed(0) }}
              </div>
              <div class="flex justify-between text-[11px] mt-2">
                <div class="text-center flex-1">
                  <div class="opacity-85">ç¾é‡‘</div>
                  <div class="text-base font-semibold">
                    {{ cashAmount.toFixed(2).replace(/\.?0+$/,'') }}
                  </div>
                  <div class="opacity-90">ç´„ TWD {{ cashTwd.toFixed(0) }}</div>
                </div>
                <div class="w-px bg-white/40 mx-3"></div>
                <div class="text-center flex-1">
                  <div class="opacity-85">ä¿¡ç”¨å¡</div>
                  <div class="text-base font-semibold">
                    {{ cardAmount.toFixed(2).replace(/\.?0+$/,'') }}
                  </div>
                  <div class="opacity-90">ç´„ TWD {{ cardTwd.toFixed(0) }}</div>
                </div>
              </div>
            </div>

            <!-- Filter -->
            <div class="flex bg-slate-100 rounded-full p-1 text-[12px] mb-2">
              <button
                class="flex-1 py-1 rounded-full"
                :class="expenseFilter === 'all' ? 'bg-slate-900 text-white' : 'text-slate-600'"
                @click="expenseFilter = 'all'"
              >
                å…¨éƒ¨
              </button>
              <button
                class="flex-1 py-1 rounded-full"
                :class="expenseFilter === 'cash' ? 'bg-slate-900 text-white' : 'text-slate-600'"
                @click="expenseFilter = 'cash'"
              >
                ç¾é‡‘
              </button>
              <button
                class="flex-1 py-1 rounded-full"
                :class="expenseFilter === 'card' ? 'bg-slate-900 text-white' : 'text-slate-600'"
                @click="expenseFilter = 'card'"
              >
                ä¿¡ç”¨å¡
              </button>
            </div>

            <!-- Add / edit expense -->
            <div class="space-y-1 mb-2 border-t border-slate-100 pt-2">
              <div class="text-[11px] text-slate-500">æ–°å¢ / ç·¨è¼¯æ”¯å‡º</div>
              <div class="flex gap-2">
                <input
                  type="date"
                  v-model="expForm.date"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <select
                  v-model="expForm.method"
                  class="w-28 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                >
                  <option value="cash">ç¾é‡‘</option>
                  <option value="card">ä¿¡ç”¨å¡</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
              <div class="flex gap-2">
                <input
                  type="number"
                  v-model.number="expForm.amount"
                  step="0.01"
                  :placeholder="'é‡‘é¡ï¼ˆ' + currentCurrency + 'ï¼‰'"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <input
                  v-model="expForm.category"
                  placeholder="åˆ†é¡ï¼ˆé¤é£²ã€äº¤é€šâ€¦ï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="flex gap-2">
                <input
                  type="number"
                  v-model.number="expForm.approxTwd"
                  step="1"
                  placeholder="ç´„ç•¶ TWDï¼Œå¯æ‰‹å‹•è¼¸å…¥"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <input
                  v-model="expForm.note"
                  placeholder="å‚™è¨»ï¼ˆåº—åã€åˆ·å“ªå¼µå¡â€¦ï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="text-[11px] text-slate-500">
                è‹¥æœªå¡«ç´„ç•¶ TWDï¼Œæœƒä¾åŒ¯ç‡è‡ªå‹•è¨ˆç®—ï¼›è²¨å¹£æ˜¯ TWD å‰‡ç›´æ¥ç”¨åŸé‡‘é¡ã€‚
              </div>
              <div class="flex justify-end pt-1">
                <button
                  class="px-4 h-9 rounded-full bg-primary-600 text-white text-[13px]"
                  @click="submitExpense"
                >
                  {{ editingExpId ? 'å„²å­˜æ”¯å‡º' : 'ï¼‹ æ–°å¢æ”¯å‡º' }}
                </button>
              </div>
            </div>

            <!-- Expense list -->
            <div class="mt-1">
              <div v-if="!filteredExpenses.length" class="text-[12px] text-slate-400 text-center py-3">
                ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„ã€‚
              </div>
              <div v-else class="space-y-2">
                <div
                  v-for="e in filteredExpensesSorted"
                  :key="e.id"
                  class="flex items-start gap-2 bg-slate-50 rounded-2xl px-3 py-2"
                >
                  <div class="flex-1">
                    <div class="text-[11px] text-slate-500">
                      {{ formatDateMMDD(e.date) }}
                    </div>
                    <div class="text-[13px] font-semibold text-slate-800 flex flex-wrap gap-1 items-center">
                      <span>{{ e.category || 'æœªåˆ†é¡' }}</span>
                      <span class="px-2 py-0.5 rounded-full bg-slate-200 text-[10px] text-slate-700">
                        {{ methodLabel(e.method) }}
                      </span>
                      <span class="px-2 py-0.5 rounded-full bg-slate-900 text-[10px] text-white">
                        {{ formatMoney(e.amount, currentCurrency) }}
                      </span>
                      <span
                        v-if="expenseApproxTwd(e) !== null"
                        class="px-2 py-0.5 rounded-full bg-amber-50 text-[10px] text-amber-700"
                      >
                        ç´„ TWD {{ expenseApproxTwd(e)?.toFixed(0) }}
                      </span>
                    </div>
                    <div v-if="e.note" class="text-[12px] text-slate-600 mt-0.5">
                      {{ e.note }}
                    </div>
                  </div>
                  <div class="flex flex-col gap-1 items-end">
                    <button
                      class="px-2 py-0.5 rounded-full bg-slate-100 text-[11px] text-slate-600"
                      @click="editExpense(e)"
                    >
                      ç·¨è¼¯
                    </button>
                    <button
                      class="w-7 h-7 rounded-full bg-rose-50 text-rose-500 text-xs"
                      @click="removeExpense(e.id)"
                    >
                      âœ•
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Shopping -->
        <div v-if="currentView === 'shopping'">
          <div class="bg-white/90 backdrop-blur rounded-xl2 shadow-card p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-semibold text-slate-800">è³¼ç‰©æ¸…å–®</div>
            </div>

            <div class="mb-2 text-[12px] text-slate-600">
              <div class="flex justify-between">
                <span>è¨ˆç•«è³¼ç‰©ç¸½é¡</span>
                <span class="font-semibold">
                  {{ formatMoney(shoppingTotal, currentCurrency) }}
                </span>
              </div>
              <div class="flex justify-between">
                <span>å·²è³¼è²·é‡‘é¡</span>
                <span class="font-semibold">
                  {{ formatMoney(shoppingBought, currentCurrency) }}
                </span>
              </div>
            </div>

            <!-- Add shopping -->
            <div class="space-y-1 border-t border-slate-100 pt-2 mb-2">
              <div class="text-[11px] text-slate-500">æ–°å¢è³¼ç‰©é …ç›®</div>
              <input
                v-model="shopForm.name"
                placeholder="å“é …åç¨±ï¼ˆä¾‹å¦‚ï¼šCEZANNE 101 è™Ÿå”‡è†ï¼‰"
                class="w-full h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
              />
              <div class="flex gap-2">
                <input
                  type="number"
                  step="0.01"
                  v-model.number="shopForm.price"
                  :placeholder="'åƒ¹æ ¼ï¼ˆ' + currentCurrency + 'ï¼‰å¯ç•™ç™½'"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
                <input
                  v-model="shopForm.note"
                  placeholder="å‚™è¨»ï¼ˆåº—å®¶ã€è‰²è™Ÿâ€¦ï¼‰"
                  class="flex-1 h-9 rounded-full border border-slate-200 text-[13px] px-3 bg-slate-50"
                />
              </div>
              <div class="flex justify-end">
                <button
                  class="px-4 h-9 rounded-full bg-primary-600 text-white text-[13px]"
                  @click="addShopping"
                >
                  ï¼‹ æ–°å¢å“é …
                </button>
              </div>
            </div>

            <!-- List -->
            <div>
              <div v-if="!currentTrip.shopping.length" class="text-[12px] text-slate-400 text-center py-3">
                ç›®å‰æ²’æœ‰è³¼ç‰©å“é …ã€‚
              </div>
              <div v-else class="space-y-2">
                <div
                  v-for="item in currentTrip.shopping"
                  :key="item.id"
                  class="flex items-start gap-2 bg-slate-50 rounded-2xl px-3 py-2"
                >
                  <div class="flex-1">
                    <div class="flex flex-wrap gap-1 items-center">
                      <span class="font-semibold text-[13px] text-slate-800">{{ item.name }}</span>
                      <span
                        v-if="item.bought"
                        class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-[10px]"
                      >
                        å·²è³¼è²·
                      </span>
                      <span
                        v-if="item.price"
                        class="px-2 py-0.5 rounded-full bg-slate-900 text-white text-[10px]"
                      >
                        {{ formatMoney(item.price, currentCurrency) }}
                      </span>
                    </div>
                    <div v-if="item.note" class="text-[12px] text-slate-600 mt-0.5">
                      {{ item.note }}
                    </div>
                  </div>
                  <div class="flex flex-col gap-1 items-end">
                    <button
                      class="px-2 py-0.5 rounded-full bg-slate-100 text-[11px] text-slate-600"
                      @click="toggleShoppingBought(item)"
                    >
                      {{ item.bought ? 'å–æ¶ˆå·²è²·' : 'æ¨™è¨˜å·²è²·' }}
                    </button>
                    <button
                      class="w-7 h-7 rounded-full bg-rose-50 text-rose-500 text-xs"
                      @click="removeShopping(item.id)"
                    >
                      âœ•
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- Bottom nav -->
      <nav class="fixed inset-x-0 bottom-0">
        <div class="max-w-md mx-auto px-4 pb-3 pt-1 bg-white/90 backdrop-blur border-t border-slate-200">
          <div class="flex bg-slate-100 rounded-full p-1 text-[11px]">
            <button
              class="flex-1 flex flex-col items-center py-1 rounded-full"
              :class="currentView==='itinerary' ? 'bg-slate-900 text-white' : 'text-slate-600'"
              @click="currentView='itinerary'"
            >
              <span class="text-base mb-0.5">ğŸ—º</span>
              è¡Œç¨‹
            </button>
            <button
              class="flex-1 flex flex-col items-center py-1 rounded-full"
              :class="currentView==='flights' ? 'bg-slate-900 text-white' : 'text-slate-600'"
              @click="currentView='flights'"
            >
              <span class="text-base mb-0.5">âœˆï¸</span>
              èˆªç­
            </button>
            <button
              class="flex-1 flex flex-col items-center py-1 rounded-full"
              :class="currentView==='expenses' ? 'bg-slate-900 text-white' : 'text-slate-600'"
              @click="currentView='expenses'"
            >
              <span class="text-base mb-0.5">ğŸ’°</span>
              è¨˜å¸³
            </button>
            <button
              class="flex-1 flex flex-col items-center py-1 rounded-full"
              :class="currentView==='shopping' ? 'bg-slate-900 text-white' : 'text-slate-600'"
              @click="currentView='shopping'"
            >
              <span class="text-base mb-0.5">ğŸ›</span>
              è³¼ç‰©
            </button>
          </div>
        </div>
      </nav>

      <!-- Sidebar (trip list) -->
      <div
        v-if="sidebarOpen"
        class="fixed inset-0 bg-black/30 backdrop-blur-sm flex justify-start z-20"
        @click.self="sidebarOpen=false"
      >
        <div class="w-72 max-w-full h-full bg-white rounded-r-3xl shadow-xl p-4 flex flex-col">
          <div class="flex items-center justify-between mb-3">
            <div class="text-base font-semibold text-slate-800">æˆ‘çš„æ—…ç¨‹</div>
            <button
              class="w-7 h-7 rounded-full bg-slate-100 flex items-center justify-center text-slate-600"
              @click="sidebarOpen=false"
            >
              âœ•
            </button>
          </div>

          <button
            class="border-2 border-dashed border-primary-300 rounded-2xl px-3 py-2 text-sm text-primary-700 flex items-center justify-between mb-3"
            @click="createTripFromSidebar"
          >
            <span>ï¼‹ å»ºç«‹æ–°æ—…ç¨‹</span>
            <span class="text-xs text-primary-400">è‡ªå‹•å¡«å…¥ä»Šæ—¥æ—¥æœŸ</span>
          </button>

          <div class="flex-1 overflow-y-auto space-y-2">
            <button
              v-for="t in root.trips"
              :key="t.id"
              class="w-full text-left rounded-2xl px-3 py-2 border"
              :class="t.id === root.activeTripId
                       ? 'border-primary-500 bg-primary-50'
                       : 'border-slate-200 bg-slate-50'"
              @click="selectTripFromSidebar(t.id)"
            >
              <div class="text-sm font-semibold text-slate-800">{{ t.name || 'æœªå‘½åæ—…ç¨‹' }}</div>
              <div class="text-[11px] text-slate-500 flex items-center justify-between">
                <span>
                  {{ t.destination || 'æœªè¨­å®šç›®çš„åœ°' }}
                </span>
                <span>
                  {{ t.daysCount || 0 }} å¤©
                </span>
              </div>
              <div class="text-[11px] text-slate-400">
                {{ formatDateMMDD(t.startDate) }}
              </div>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const STORAGE_KEY = 'tripPlanner_multi_v2';

    const IATA_TO_CITY_ZH = {
      TPE: "å°åŒ—", TSA: "å°åŒ—", KHH: "é«˜é›„",
      NRT: "æ±äº¬", HND: "æ±äº¬", KIX: "å¤§é˜ª", FUK: "ç¦å²¡",
      CDG: "å·´é»", ORY: "å·´é»",
      AMS: "é˜¿å§†æ–¯ç‰¹ä¸¹", BRU: "å¸ƒé­¯å¡çˆ¾",
      ICN: "é¦–çˆ¾", GMP: "é¦–çˆ¾",
      HKG: "é¦™æ¸¯",
      LHR: "å€«æ•¦", LGW: "å€«æ•¦"
    };

    function createEmptyTrip(name) {
      return {
        id: 'trip_' + Math.random().toString(36).slice(2, 9),
        name: name || 'æ–°æ—…ç¨‹',
        destination: '',
        currency: 'JPY',
        startDate: '',
        daysCount: 4,
        days: [],
        activeDayId: null,
        flights: [],
        checklist: [],
        itinerary: {},
        expenses: [],
        shopping: [],
        exchangeRate: {
          base: 'JPY',
          target: 'TWD',
          rate: null,
          updatedAt: ''
        }
      };
    }

    function ensureTripShape(trip) {
      if (!trip.itinerary) trip.itinerary = {};
      if (!trip.flights) trip.flights = [];
      if (!trip.checklist) trip.checklist = [];
      if (!trip.expenses) trip.expenses = [];
      if (!trip.shopping) trip.shopping = [];
      if (!trip.exchangeRate) {
        trip.exchangeRate = {
          base: trip.currency || 'JPY',
          target: 'TWD',
          rate: null,
          updatedAt: ''
        };
      }
    }

    function regenerateDays(trip) {
      const start = trip.startDate ? new Date(trip.startDate) : null;
      const days = [];
      const n = trip.daysCount || 1;
      for (let i = 0; i < n; i++) {
        let dateStr = '';
        if (start && !isNaN(start)) {
          const d = new Date(start);
          d.setDate(d.getDate() + i);
          dateStr = d.toISOString().slice(0, 10);
        }
        const id = 'day' + (i + 1);
        days.push({ id, label: 'Day ' + (i + 1), date: dateStr });
        if (!trip.itinerary[id]) trip.itinerary[id] = [];
      }
      trip.days = days;
      if (!trip.activeDayId) {
        trip.activeDayId = days[0] ? days[0].id : 'prep';
      }
    }

    function formatDateMMDD(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return '';
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${m}/${day}`;
    }

    function formatMoney(amount, currency) {
      if (amount == null || isNaN(amount)) return '-';
      const str = Number(amount).toFixed(2).replace(/\.?0+$/, '');
      return `${currency} ${str}`;
    }

    const app = {
      data() {
        return {
          root: { trips: [], activeTripId: null },
          currentView: 'itinerary',
          sidebarOpen: false,
          tripSettingCollapsed: false,

          // itinerary form
          itForm: { time: '', title: '', note: '' },
          editingItId: null,
          prepInput: '',

          // flights
          flightForm: { date: '', flightNo: '', from: '', to: '', time: '', note: '' },

          // expenses
          expenseFilter: 'all',
          expForm: { id: null, date: '', method: 'cash', amount: null, category: '', approxTwd: null, note: '' },
          editingExpId: null,
          rateInput: null,

          // shopping
          shopForm: { name: '', price: null, note: '' }
        };
      },
      computed: {
        currentTrip() {
          if (!this.root.trips.length) return null;
          let t = this.root.trips.find(t => t.id === this.root.activeTripId);
          if (!t) {
            t = this.root.trips[0];
            this.root.activeTripId = t.id;
          }
          ensureTripShape(t);
          return t;
        },
        currentCurrency() {
          return (this.currentTrip?.currency || 'JPY').toUpperCase();
        },
        dateRangeText() {
          const t = this.currentTrip;
          if (!t || !t.startDate || !t.daysCount) return 'è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸';
          const start = new Date(t.startDate);
          if (isNaN(start)) return 'è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸';
          const end = new Date(start);
          end.setDate(end.getDate() + t.daysCount - 1);
          const endStr = end.toISOString().slice(0, 10);
          return `${t.daysCount} å¤©è¡Œç¨‹ï½œ${formatDateMMDD(t.startDate)} - ${formatDateMMDD(endStr)}`;
        },
        rateDisplay() {
          const t = this.currentTrip;
          if (!t) return '';
          const ex = t.exchangeRate;
          if (!ex || typeof ex.rate !== 'number' || !ex.rate || ex.base !== this.currentCurrency || ex.target !== 'TWD') {
            return '';
          }
          return `1 ${ex.base} â‰ˆ ${ex.rate.toFixed(2)} TWD`;
        },
        currencyNote() {
          if (this.currentCurrency === 'TWD') {
            return 'ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€åŒ¯ç‡';
          }
          return 'åŒ¯ç‡å°šæœªè¨­å®š';
        },
        currentDayItinerary() {
          const t = this.currentTrip;
          if (!t) return [];
          const id = t.activeDayId;
          if (!id || id === 'prep') return [];
          return t.itinerary[id] || [];
        },
        currentDayItinerarySorted() {
          return [...this.currentDayItinerary].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
        },
        flightsSorted() {
          const t = this.currentTrip;
          if (!t) return [];
          return [...t.flights].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
        },
        // expenses summary
        totalAmount() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.expenses.reduce((s, e) => s + (e.amount || 0), 0);
        },
        cashAmount() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.expenses.filter(e => e.method === 'cash').reduce((s, e) => s + (e.amount || 0), 0);
        },
        cardAmount() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.expenses.filter(e => e.method === 'card').reduce((s, e) => s + (e.amount || 0), 0);
        },
        useableRate() {
          const t = this.currentTrip;
          if (!t) return null;
          const ex = t.exchangeRate;
          if (!ex || typeof ex.rate !== 'number' || !ex.rate) return null;
          if (ex.base !== this.currentCurrency || ex.target !== 'TWD') return null;
          return ex.rate;
        },
        totalTwd() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.expenses.reduce((s, e) => s + (this.expenseApproxTwd(e) || 0), 0);
        },
        cashTwd() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.expenses
            .filter(e => e.method === 'cash')
            .reduce((s, e) => s + (this.expenseApproxTwd(e) || 0), 0);
        },
        cardTwd() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.expenses
            .filter(e => e.method === 'card')
            .reduce((s, e) => s + (this.expenseApproxTwd(e) || 0), 0);
        },
        rateInfoText() {
          if (this.currentCurrency === 'TWD') {
            return 'ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç¸½è¨ˆå³ç‚º TWD é‡‘é¡ï¼Œå¯é¸æ“‡æ˜¯å¦å¡«å¯«ç´„ç•¶æ¬„ä½ã€‚';
          }
          if (this.useableRate) {
            return `ç›®å‰åŒ¯ç‡ï¼š1 ${this.currentCurrency} â‰ˆ ${this.useableRate.toFixed(2)} TWD`;
          }
          return 'ç›®å‰å°šæœªè¨­å®šåŒ¯ç‡ï¼ˆè‹¥ä¸»è¦è²¨å¹£ç‚º TWD å‰‡ä¸éœ€è¨­å®šï¼‰ã€‚';
        },
        filteredExpenses() {
          const t = this.currentTrip;
          if (!t) return [];
          if (this.expenseFilter === 'all') return t.expenses;
          return t.expenses.filter(e => e.method === this.expenseFilter);
        },
        filteredExpensesSorted() {
          return [...this.filteredExpenses].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
        },
        // shopping
        shoppingTotal() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.shopping.reduce((s, i) => s + (i.price || 0), 0);
        },
        shoppingBought() {
          const t = this.currentTrip;
          if (!t) return 0;
          return t.shopping.filter(i => i.bought).reduce((s, i) => s + (i.price || 0), 0);
        }
      },
      methods: {
        loadRoot() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) throw new Error('no data');
            const obj = JSON.parse(raw);
            if (!obj.trips || !obj.trips.length) throw new Error('bad data');
            obj.trips.forEach(ensureTripShape);
            this.root = obj;
          } catch (e) {
            const trip = createEmptyTrip('æ–°æ—…ç¨‹ 1');
            regenerateDays(trip);
            this.root = { trips: [trip], activeTripId: trip.id };
            this.saveRoot();
          }
          if (this.currentTrip && (!this.currentTrip.days || !this.currentTrip.days.length)) {
            regenerateDays(this.currentTrip);
            this.saveRoot();
          }
          this.syncRateInput();
        },
        saveRoot() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(this.root));
        },
        onTripSwitch() {
          if (!this.currentTrip.days || !this.currentTrip.days.length) {
            regenerateDays(this.currentTrip);
          }
          this.syncRateInput();
          this.saveRoot();
        },
        createTrip() {
          const name = 'æ–°æ—…ç¨‹ ' + (this.root.trips.length + 1);
          const trip = createEmptyTrip(name);
          regenerateDays(trip);
          this.root.trips.push(trip);
          this.root.activeTripId = trip.id;
          this.saveRoot();
          this.syncRateInput();
        },
        deleteCurrentTrip() {
          if (this.root.trips.length <= 1) {
            alert('è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹ï¼Œç„¡æ³•å…¨éƒ¨åˆªå…‰ã€‚');
            return;
          }
          if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${this.currentTrip.name}ã€é€™å€‹æ—…ç¨‹å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) return;
          this.root.trips = this.root.trips.filter(t => t.id !== this.currentTrip.id);
          this.root.activeTripId = this.root.trips[0].id;
          this.saveRoot();
          this.syncRateInput();
        },
        applyTripSetting() {
          const t = this.currentTrip;
          if (!t) return;
          if (!t.daysCount || t.daysCount < 1) t.daysCount = 1;
          if (t.daysCount > 30) t.daysCount = 30;
          const oldCurrency = (t.exchangeRate?.base || t.currency || 'JPY').toUpperCase();
          const newCurrency = this.currentCurrency;
          regenerateDays(t);

          if (!t.exchangeRate) {
            t.exchangeRate = { base: newCurrency, target: 'TWD', rate: null, updatedAt: '' };
          } else {
            t.exchangeRate.base = newCurrency;
            t.exchangeRate.target = 'TWD';
          }

          // è‹¥å¹£åˆ¥æ”¹è®Šå°±æ¸…ç©º rateï¼Œç”±ä½¿ç”¨è€…åœ¨è¨˜å¸³é å†æŸ¥ä¸€æ¬¡
          if (oldCurrency !== newCurrency) {
            t.exchangeRate.rate = null;
            t.exchangeRate.updatedAt = '';
          }

          this.saveRoot();
          this.syncRateInput();
        },
        resetCurrentTrip() {
          if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬æ—…ç¨‹çš„è¡Œç¨‹ã€èˆªç­ã€è¨˜å¸³èˆ‡è³¼ç‰©è³‡æ–™å—ï¼Ÿ')) return;
          const t = this.currentTrip;
          t.itinerary = {};
          t.flights = [];
          t.checklist = [];
          t.expenses = [];
          t.shopping = [];
          regenerateDays(t);
          this.saveRoot();
        },
        setActiveDay(id) {
          this.currentTrip.activeDayId = id;
          this.saveRoot();
        },
        addPrepItem() {
          const text = this.prepInput.trim();
          if (!text) return;
          this.currentTrip.checklist.push({
            id: 'prep_' + Math.random().toString(36).slice(2, 9),
            text,
            done: false
          });
          this.prepInput = '';
          this.saveRoot();
        },
        removePrepItem(id) {
          this.currentTrip.checklist = this.currentTrip.checklist.filter(i => i.id !== id);
          this.saveRoot();
        },
        submitItinerary() {
          const t = this.currentTrip;
          const dayId = t.activeDayId;
          if (!dayId || dayId === 'prep') return;
          const list = t.itinerary[dayId] || [];
          const time = this.itForm.time || '';
          const title = (this.itForm.title || '').trim();
          const note = (this.itForm.note || '').trim();
          if (!time && !title && !note) return;

          if (this.editingItId) {
            const target = list.find(i => i.id === this.editingItId);
            if (target) {
              target.time = time;
              target.title = title || 'æœªå‘½åè¡Œç¨‹';
              target.note = note;
            }
          } else {
            list.push({
              id: 'it_' + Math.random().toString(36).slice(2, 9),
              time,
              title: title || 'æœªå‘½åè¡Œç¨‹',
              note
            });
          }
          t.itinerary[dayId] = list;
          this.itForm = { time: '', title: '', note: '' };
          this.editingItId = null;
          this.saveRoot();
        },
        editItinerary(item) {
          this.itForm = { time: item.time || '', title: item.title || '', note: item.note || '' };
          this.editingItId = item.id;
        },
        removeItinerary(id) {
          const t = this.currentTrip;
          const dayId = t.activeDayId;
          if (!dayId || dayId === 'prep') return;
          t.itinerary[dayId] = (t.itinerary[dayId] || []).filter(i => i.id !== id);
          this.saveRoot();
        },
        openMap(item) {
          const t = this.currentTrip;
          const q = encodeURIComponent(item.title || t.destination || 'æ™¯é»');
          const url = `https://www.google.com/maps/search/?api=1&query=${q}`;
          window.open(url, '_blank');
        },
        // flights
        addFlight() {
          const f = this.flightForm;
          if (!f.flightNo && !f.from && !f.to && !f.time && !f.date && !f.note) return;
          this.currentTrip.flights.push({
            id: 'fl_' + Math.random().toString(36).slice(2, 9),
            date: f.date,
            flightNo: f.flightNo.trim(),
            from: f.from.trim(),
            to: f.to.trim(),
            time: f.time,
            note: f.note.trim()
          });
          this.flightForm = { date: '', flightNo: '', from: '', to: '', time: '', note: '' };
          this.saveRoot();
        },
        removeFlight(id) {
          this.currentTrip.flights = this.currentTrip.flights.filter(f => f.id !== id);
          this.saveRoot();
        },
        // rate
        syncRateInput() {
          const r = this.currentTrip?.exchangeRate;
          if (r && typeof r.rate === 'number' && r.base === this.currentCurrency && r.target === 'TWD') {
            this.rateInput = Number(r.rate.toFixed(4));
          } else {
            this.rateInput = null;
          }
        },
        async fetchRate() {
          if (this.currentCurrency === 'TWD') {
            alert('ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æŸ¥è©¢åŒ¯ç‡ã€‚');
            return;
          }
          try {
            const res = await fetch(`https://open.er-api.com/v6/latest/${encodeURIComponent(this.currentCurrency)}`);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (!data || data.result !== 'success' || !data.rates || typeof data.rates.TWD !== 'number') {
              throw new Error('API å›å‚³ç•°å¸¸');
            }
            this.rateInput = Number(data.rates.TWD.toFixed(4));
            this.currentTrip.exchangeRate = {
              base: this.currentCurrency,
              target: 'TWD',
              rate: this.rateInput,
              updatedAt: data.time_last_update_utc || ''
            };
            this.saveRoot();
          } catch (e) {
            alert('åŒ¯ç‡æŸ¥è©¢å¤±æ•—ï¼š' + e.message);
          }
        },
        saveRateInput() {
          const v = Number(this.rateInput);
          if (!v || isNaN(v) || v <= 0) {
            alert('è«‹è¼¸å…¥æ­£ç¢ºçš„åŒ¯ç‡æ•¸å­—ï¼ˆ>0ï¼‰ã€‚');
            return;
          }
          this.currentTrip.exchangeRate = {
            base: this.currentCurrency,
            target: 'TWD',
            rate: v,
            updatedAt: ''
          };
          this.saveRoot();
        },
        // expense helpers
        expenseApproxTwd(e) {
          if (e.approxTwd != null && !isNaN(e.approxTwd)) {
            return Number(e.approxTwd);
          }
          if (this.currentCurrency === 'TWD') {
            return e.amount || 0;
          }
          if (this.useableRate) {
            return (e.amount || 0) * this.useableRate;
          }
          return null;
        },
        methodLabel(m) {
          if (m === 'cash') return 'ç¾é‡‘';
          if (m === 'card') return 'ä¿¡ç”¨å¡';
          return 'å…¶ä»–';
        },
        submitExpense() {
          const f = this.expForm;
          if (f.amount == null || isNaN(f.amount)) return;
          let approx = f.approxTwd;
          if (approx == null || isNaN(approx)) {
            if (this.currentCurrency === 'TWD') {
              approx = f.amount;
            } else if (this.useableRate) {
              approx = f.amount * this.useableRate;
            } else {
              approx = null;
            }
          }
          if (this.editingExpId) {
            const target = this.currentTrip.expenses.find(e => e.id === this.editingExpId);
            if (target) {
              target.date = f.date;
              target.method = f.method;
              target.amount = f.amount;
              target.category = f.category;
              target.approxTwd = approx;
              target.note = f.note;
            }
          } else {
            this.currentTrip.expenses.push({
              id: 'exp_' + Math.random().toString(36).slice(2, 9),
              date: f.date,
              method: f.method,
              amount: f.amount,
              category: f.category,
              approxTwd: approx,
              note: f.note
            });
          }
          this.expForm = { id: null, date: '', method: 'cash', amount: null, category: '', approxTwd: null, note: '' };
          this.editingExpId = null;
          this.saveRoot();
        },
        editExpense(e) {
          this.expForm = {
            id: e.id,
            date: e.date || '',
            method: e.method || 'cash',
            amount: e.amount || null,
            category: e.category || '',
            approxTwd: e.approxTwd != null ? e.approxTwd : null,
            note: e.note || ''
          };
          this.editingExpId = e.id;
        },
        removeExpense(id) {
          this.currentTrip.expenses = this.currentTrip.expenses.filter(e => e.id !== id);
          this.saveRoot();
        },
        // shopping
        addShopping() {
          const f = this.shopForm;
          if (!f.name && !f.note) return;
          this.currentTrip.shopping.push({
            id: 'shop_' + Math.random().toString(36).slice(2, 9),
            name: f.name || 'æœªå‘½åå“é …',
            price: f.price != null && !isNaN(f.price) ? f.price : 0,
            note: f.note || '',
            bought: false
          });
          this.shopForm = { name: '', price: null, note: '' };
          this.saveRoot();
        },
        toggleShoppingBought(item) {
          item.bought = !item.bought;
          this.saveRoot();
        },
        removeShopping(id) {
          this.currentTrip.shopping = this.currentTrip.shopping.filter(i => i.id !== id);
          this.saveRoot();
        },
        // sidebar
        createTripFromSidebar() {
          const t = new Date();
          const dateStr = t.toISOString().slice(0, 10);
          const trip = createEmptyTrip('æ–°æ—…ç¨‹ ' + (this.root.trips.length + 1));
          trip.startDate = dateStr;
          regenerateDays(trip);
          this.root.trips.push(trip);
          this.root.activeTripId = trip.id;
          this.sidebarOpen = false;
          this.saveRoot();
          this.syncRateInput();
        },
        selectTripFromSidebar(id) {
          this.root.activeTripId = id;
          this.sidebarOpen = false;
          if (!this.currentTrip.days || !this.currentTrip.days.length) {
            regenerateDays(this.currentTrip);
          }
          this.saveRoot();
          this.syncRateInput();
        },
        formatDateMMDD,
        formatMoney
      },
      mounted() {
        this.loadRoot();
      }
    };

    Vue.createApp(app).mount('#app');
  </script>
</body>
</html>
