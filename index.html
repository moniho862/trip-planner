<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Planner</title>

  <!-- Leaflet åœ°åœ– CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#e9f3ff;
      --primary:#3b82f6;
      --primary-soft:#dbeafe;
      --card-bg:#ffffff;
      --text-main:#111827;
      --text-sub:#6b7280;
      --radius-lg:20px;
      --radius-md:14px;
    }
    *{
      box-sizing:border-box;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
    }
    body{
      margin:0;
      background:linear-gradient(180deg,#c5e0ff 0%,#f5f7ff 40%,#ffffff 100%);
      color:var(--text-main);
      -webkit-text-size-adjust:100%;
    }
    .app{
      max-width:480px;
      margin:0 auto;
      min-height:100vh;
      padding:16px 16px 72px;
      position:relative;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .title{
      font-size:20px;
      font-weight:700;
    }
    .subtitle{
      font-size:12px;
      color:var(--text-sub);
    }
    .tag{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(59,130,246,.1);
      color:#1d4ed8;
      margin-left:6px;
    }
    .top-info{
      text-align:right;
      font-size:11px;
      color:var(--text-sub);
    }
    .top-info-rate{
      margin-top:2px;
      font-size:11px;
      color:#1d4ed8;
    }
    .top-info-rate span{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(59,130,246,0.08);
    }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:12px 14px;
      box-shadow:0 12px 30px rgba(15,23,42,0.08);
      margin-bottom:12px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:14px;
      font-weight:600;
    }
    .small-label{
      font-size:11px;
      color:var(--text-sub);
      margin-bottom:4px;
      display:block;
    }

    input,select,textarea{
      width:100%;
      font-size:16px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      outline:none;
      background:#f9fafb;
      box-sizing:border-box;
      height:40px;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      background:#ffffff;
    }
    textarea{
      border-radius:12px;
      resize:vertical;
      min-height:52px;
      height:auto;
    }

    input[type="date"].compact-date,
    input[type="time"].compact-time{
      -webkit-appearance:none;
      appearance:none;
      font-size:16px;
      height:40px;
      padding:7px 9px;
      border-radius:999px;
    }

    .row{display:flex;gap:8px;margin-bottom:6px;}
    .row>.col{flex:1;}

    .btn{
      border-radius:999px;
      border:none;
      font-size:13px;
      padding:7px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-ghost{background:#eef2ff;color:#4f46e5;}
    .btn-danger{background:#fee2e2;color:#b91c1c;}
    .btn-icon{width:28px;height:28px;padding:0;justify-content:center;}
    .btn-sm{font-size:12px;padding:5px 10px;}

    .day-chips{
      display:flex;
      overflow-x:auto;
      gap:8px;
      padding-bottom:4px;
      margin-bottom:8px;
    }
    .chip{
      min-width:68px;
      padding:6px 8px;
      border-radius:16px;
      background:#eff6ff;
      font-size:11px;
      text-align:center;
      cursor:pointer;
      color:#1d4ed8;
      flex-shrink:0;
    }
    .chip strong{display:block;font-size:13px;margin-bottom:2px;}
    .chip.active{background:#1d4ed8;color:#eff6ff;}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#eff6ff;
      font-size:11px;
      color:#1d4ed8;
    }

    .list{margin-top:6px;}
    .list-item{
      background:#f9fafb;
      border-radius:var(--radius-md);
      padding:8px 10px;
      font-size:13px;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
    }
    .list-main{flex:1;}
    .list-title{font-weight:600;margin-bottom:2px;}
    .list-meta{font-size:11px;color:var(--text-sub);margin-bottom:2px;}
    .list-note{font-size:12px;color:#4b5563;}
    .badge{
      display:inline-block;
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      margin-left:4px;
    }
    .empty{
      font-size:12px;
      color:var(--text-sub);
      text-align:center;
      padding:12px 4px 4px;
    }

    .check-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;}
    .check-row input[type="checkbox"]{width:18px;height:18px;flex-shrink:0;}
    .check-text.done{text-decoration:line-through;color:#9ca3af;}

    .bottom-nav{
      position:fixed;
      left:0;right:0;bottom:0;
      max-width:480px;
      margin:0 auto;
      padding:8px 16px 12px;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(18px);
      border-top:1px solid rgba(209,213,219,.8);
      z-index:999;
    }
    .bottom-tabs{
      display:flex;
      background:#f3f4f6;
      border-radius:999px;
      padding:4px;
      gap:4px;
    }
    .bottom-tab{
      flex:1;
      text-align:center;
      font-size:11px;
      padding:6px 0 4px;
      border-radius:999px;
      color:#6b7280;
      cursor:pointer;
      user-select:none;
    }
    .bottom-tab span{display:block;font-size:16px;margin-bottom:2px;}
    .bottom-tab.active{background:#111827;color:#f9fafb;}

    /* ===== èˆªç­å¡ç‰‡ ===== */
    .flight-card-wrap{margin-top:8px;}
    .flight-card{
      position:relative;
      border-radius:22px;
      padding:12px 14px;
      background:linear-gradient(135deg,#2563eb,#0ea5e9);
      color:#f9fafb;
      box-shadow:0 14px 32px rgba(15,23,42,0.35);
      overflow:hidden;
    }
    .flight-card-top{display:flex;justify-content:space-between;align-items:center;font-size:12px;opacity:.9;}
    .flight-card-top-left{font-weight:600;}
    .flight-card-main{display:flex;align-items:center;justify-content:space-between;margin-top:8px;}
    .flight-airport{font-size:22px;font-weight:700;letter-spacing:2px;}
    .flight-airport-label{font-size:11px;opacity:.9;}
    .flight-plane-icon{font-size:22px;padding:0 10px;}
    .flight-card-bottom{margin-top:6px;font-size:12px;opacity:.95;}
    .flight-extra-line{margin-top:4px;font-size:11px;opacity:.9;}
    .flight-extra-line strong{font-weight:600;}
    .flight-delete-btn{
      position:absolute;top:8px;right:8px;
      width:26px;height:26px;border-radius:999px;border:none;
      background:rgba(248,113,113,.9);
      color:#fee2e2;
      font-size:16px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }

    /* ===== è¨˜å¸³ï¼šä½ è¦çš„æ¨¡æ¿ï¼ˆåœ–ç¤ºé‚£ç¨®ï¼‰ ===== */
    .expense-hero{
      margin:6px 0 10px;
      padding:14px 14px 12px;
      border-radius:18px;
      background:linear-gradient(135deg,#4f46e5,#0ea5e9);
      color:#f9fafb;
      box-shadow:0 12px 26px rgba(15,23,42,.22);
      text-align:center;
    }
    .expense-hero-title{
      font-size:12px;
      opacity:.9;
      letter-spacing:.5px;
      margin-bottom:6px;
    }
    .expense-hero-amount{
      font-size:34px;
      font-weight:800;
      line-height:1.05;
      margin-bottom:2px;
    }
    .expense-hero-sub{
      font-size:12px;
      opacity:.92;
      margin-bottom:10px;
    }
    .expense-hero-split{
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }
    .expense-hero-col{
      flex:1;
      text-align:center;
    }
    .expense-hero-col-label{
      font-size:12px;
      opacity:.92;
      margin-bottom:2px;
    }
    .expense-hero-col-amount{
      font-size:18px;
      font-weight:700;
      margin-bottom:2px;
    }
    .expense-hero-col-sub{
      font-size:11px;
      opacity:.9;
    }
    .expense-hero-divider{
      width:1px;
      background:rgba(248,250,252,.35);
      border-radius:999px;
    }

    /* ç¯©é¸è† å›Šï¼šè·Ÿä½ åœ–ä¸€æ¨£ï¼ˆå…¨å¯¬ã€åœ“è§’ã€é»‘è‰² activeï¼‰ */
    .expense-seg{
      display:flex;
      width:100%;
      background:#e5e7eb;
      border-radius:999px;
      padding:4px;
      gap:4px;
      margin:8px 0 10px;
    }
    .expense-seg-btn{
      flex:1;
      text-align:center;
      font-size:12px;
      padding:7px 0;
      border-radius:999px;
      cursor:pointer;
      color:#4b5563;
      user-select:none;
    }
    .expense-seg-btn.active{
      background:#111827;
      color:#f9fafb;
      box-shadow:0 8px 18px rgba(17,24,39,.18);
    }

    /* ===== ä¸‰ç·šé¸å–® & æŠ½å±œ ===== */
    .menu-btn{
      border:none;background:transparent;font-size:24px;cursor:pointer;
      padding:4px 6px;margin-right:4px;color:#111827;
    }
    .drawer-backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.4);
      display:none;z-index:40;
    }
    .drawer-backdrop.show{display:block;}
    .drawer{
      position:fixed;top:0;left:0;bottom:0;
      width:280px;max-width:80%;
      background:#ffffff;
      box-shadow:10px 0 30px rgba(15,23,42,.35);
      transform:translateX(-100%);
      transition:transform .25s ease-out;
      z-index:50;
      padding:16px 14px 24px;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform:translateX(0);}
    .drawer-title{font-size:16px;font-weight:600;margin-bottom:12px;}
    .drawer-trip-list{flex:1;overflow-y:auto;padding-right:4px;}
    .drawer-trip{
      border-radius:12px;
      padding:8px 10px;
      margin-bottom:6px;
      background:#f3f4f6;
      cursor:pointer;
      font-size:13px;
    }
    .drawer-trip.active{background:#dbeafe;border:1px solid #3b82f6;}
    .drawer-trip-name{font-weight:600;}
    .drawer-trip-sub{font-size:11px;color:var(--text-sub);margin-top:2px;}
    .drawer-footer{margin-top:8px;font-size:11px;color:var(--text-sub);}
    .drawer-close{
      position:absolute;right:12px;top:10px;
      border:none;background:transparent;font-size:20px;cursor:pointer;color:#6b7280;
    }

    .trip-selector-row{display:none;}

    /* åœ°åœ–å®¹å™¨ */
    .map-container{
      width:100%;
      height:260px;
      border-radius:16px;
      overflow:hidden;
      background:#e5e7eb;
      margin-bottom:8px;
    }

    /* è‡ªå‹•å®Œæˆ */
    .autocomplete-wrap{position:relative;}
    .autocomplete-list{
      position:absolute;
      top:100%;
      left:0;right:0;
      margin-top:4px;
      background:#ffffff;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(15,23,42,0.18);
      max-height:220px;
      overflow-y:auto;
      font-size:13px;
      z-index:60;
      display:none;
    }
    .autocomplete-item{padding:8px 10px;cursor:pointer;}
    .autocomplete-item:hover{background:#eff6ff;}
    .autocomplete-item-main{display:block;font-weight:600;}
    .autocomplete-item-sub{display:block;font-size:11px;color:#6b7280;margin-top:2px;}

    /* å¤©æ°£ */
    .weather-box{
      width:100%;
      border-radius:16px;
      padding:8px 10px;
      background:#eff6ff;
      margin-bottom:8px;
      font-size:13px;
      color:#1f2933;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .weather-main{display:flex;align-items:center;gap:8px;}
    .weather-emoji{font-size:22px;}
    .weather-temp{font-size:16px;font-weight:600;}
    .weather-sub{font-size:11px;color:#6b7280;}
    .weather-loading{font-size:12px;color:#6b7280;}
  </style>
</head>

<body>
  <div class="app">
    <!-- æŠ½å±œ -->
    <div id="drawerBackdrop" class="drawer-backdrop"></div>
    <div id="tripDrawer" class="drawer">
      <button class="drawer-close" id="drawerCloseBtn">âœ•</button>
      <div class="drawer-title">æˆ‘çš„æ—…ç¨‹</div>
      <div id="drawerTripList" class="drawer-trip-list"></div>
      <button class="btn btn-ghost btn-sm" id="drawerNewTripBtn">ï¼‹ å»ºç«‹æ–°æ—…ç¨‹</button>
      <button class="btn btn-danger btn-sm" id="drawerDeleteTripBtn" style="margin-top:6px;">åˆªé™¤ç›®å‰æ—…ç¨‹</button>
      <div class="drawer-footer">åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œé©åˆåˆªé™¤æ¸¬è©¦ç”¨æ—…ç¨‹</div>
    </div>

    <header>
      <div style="display:flex;align-items:flex-start;gap:6px;">
        <button id="menuButton" class="menu-btn" aria-label="åˆ‡æ›æ—…ç¨‹">â˜°</button>
        <div>
          <div class="title">
            Trip Planner
            <span class="tag" id="destinationTag">æœªè¨­å®šç›®çš„åœ°</span>
          </div>
          <div class="subtitle" id="tripNameText">æœªå‘½åæ—…ç¨‹</div>
        </div>
      </div>
      <div class="top-info">
        <div id="dateInfoText">è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸</div>
        <div class="top-info-rate" id="rateInfoText"></div>
      </div>
    </header>

    <!-- æ—…ç¨‹è¨­å®šï¼ˆä¿ç•™ï¼Œé¿å…ä½ è³‡æ–™å£æ‰ï¼‰ -->
    <section class="card" id="tripSettingCard">
      <div class="card-header">
        <div class="card-title">æ—…ç¨‹è¨­å®š</div>
        <button class="btn btn-ghost btn-sm" id="toggleTripSettingBtn">æ”¶åˆè¨­å®š</button>
      </div>

      <div id="tripSettingContent">
        <div class="row trip-selector-row">
          <div class="col">
            <label class="small-label">é¸æ“‡æ—…ç¨‹</label>
            <select id="tripSelect"></select>
          </div>
          <button class="btn btn-ghost btn-sm" id="newTripBtn">ï¼‹ æ–°æ—…ç¨‹</button>
        </div>
        <div class="row trip-selector-row" style="margin-bottom:2px;">
          <button class="btn btn-danger btn-sm" id="deleteTripBtn">åˆªé™¤ç›®å‰æ—…ç¨‹</button>
          <div style="font-size:11px;color:var(--text-sub);">
            * åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œé©åˆåˆªé™¤æ¸¬è©¦ç”¨æ—…ç¨‹
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0 10px;">

        <div class="row">
          <div class="col">
            <label class="small-label">æ—…ç¨‹åç¨±</label>
            <input id="tripNameInput" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥è‡ªç”±è¡Œ" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="small-label">ç›®çš„åœ°åŸå¸‚ / å€åŸŸ</label>
            <input id="destinationInput" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€æ­æ´²â€¦" />
          </div>
          <div class="col">
            <label class="small-label">ä¸»è¦è²¨å¹£</label>
            <select id="currencyInput">
              <option value="KRW">KRW éŸ“å…ƒ</option>
              <option value="JPY">JPY æ—¥åœ“</option>
              <option value="TWD">TWD æ–°å°å¹£</option>
              <option value="HKD">HKD æ¸¯å¹£</option>
              <option value="USD">USD ç¾å…ƒ</option>
              <option value="EUR">EUR æ­å…ƒ</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label class="small-label">å‡ºç™¼æ—¥æœŸ</label>
            <input type="date" id="startDateInput" class="compact-date" />
          </div>
          <div class="col">
            <label class="small-label">å¤©æ•¸</label>
            <input type="number" id="daysInput" min="1" max="30" value="4" />
          </div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <button class="btn btn-primary" id="applyTripBtn">å¥—ç”¨è®Šæ›´</button>
          <button class="btn btn-ghost" id="resetBtn">æ¸…ç©ºæœ¬æ—…ç¨‹è³‡æ–™</button>
        </div>
      </div>
    </section>

    <div id="mainView"></div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <nav class="bottom-nav">
    <div class="bottom-tabs">
      <div class="bottom-tab active" data-tab="itinerary"><span>ğŸ—º</span>è¡Œç¨‹</div>
      <div class="bottom-tab" data-tab="flights"><span>âœˆï¸</span>èˆªç­</div>
      <div class="bottom-tab" data-tab="expenses"><span>ğŸ’°</span>è¨˜å¸³</div>
      <div class="bottom-tab" data-tab="shopping"><span>ğŸ›</span>è³¼ç‰©</div>
    </div>
  </nav>

  <script>
    // ===== åŒ¯ç‡ API =====
    async function fetchRateToTWD(baseCurrency) {
      const base = (baseCurrency || "").toUpperCase();
      if (!base) throw new Error("å°šæœªè¨­å®šä¸»è¦è²¨å¹£");
      if (base === "TWD") throw new Error("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æ›ç®—");

      const url = "https://open.er-api.com/v6/latest/" + encodeURIComponent(base);
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data || data.result !== "success") throw new Error("API result=" + (data?.result || "unknown"));
      if (!data.rates || typeof data.rates.TWD !== "number") throw new Error("API ç„¡ TWD åŒ¯ç‡");

      return { rate: data.rates.TWD, updatedAt: data.time_last_update_utc || "" };
    }

    // ===== è³‡æ–™çµæ§‹ =====
    const STORAGE_KEY = "tripPlanner_multi_v2";

    let editingItineraryId = null;
    let editingExpenseId = null;

    function createEmptyTrip(name) {
      return {
        id: "trip_" + Math.random().toString(36).slice(2, 9),
        name: name || "æ–°æ—…ç¨‹",
        destination: "",
        currency: "JPY",
        startDate: "",
        daysCount: 4,
        days: [],
        activeDayId: null,
        flights: [],
        checklist: [],
        itinerary: {},
        expenses: [],              // èˆŠè³‡æ–™å…¼å®¹
        expensesByDay: {},         // æ–°ç‰ˆï¼šä¾ dayId å­˜
        activeExpenseDayId: null,  // è¨˜å¸³ç›®å‰é¸åˆ°çš„ dayId
        shopping: [],
        exchangeRate: { base: "JPY", target: "TWD", rate: null, updatedAt: "" },
        geo: null,
        placeCache: {}
      };
    }

    function ensureTripShape(trip) {
      if (!trip.itinerary) trip.itinerary = {};
      if (!trip.flights) trip.flights = [];
      if (!trip.checklist) trip.checklist = [];
      if (!trip.expenses) trip.expenses = []; // èˆŠè³‡æ–™å…¼å®¹
      if (!trip.expensesByDay) trip.expensesByDay = {};
      if (!trip.shopping) trip.shopping = [];
      if (!trip.exchangeRate) trip.exchangeRate = { base: trip.currency || "JPY", target: "TWD", rate: null, updatedAt: "" };
      if (!trip.placeCache) trip.placeCache = {};
      if (!trip.activeExpenseDayId) {
        trip.activeExpenseDayId = (trip.days && trip.days[0]) ? trip.days[0].id : "day1";
      }
    }

    function loadRoot() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(trip);
          return { trips: [trip], activeTripId: trip.id };
        }
        const obj = JSON.parse(raw);
        if (!obj.trips || !Array.isArray(obj.trips) || obj.trips.length === 0) {
          const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(trip);
          return { trips: [trip], activeTripId: trip.id };
        }
        obj.trips.forEach(ensureTripShape);
        return obj;
      } catch (e) {
        console.error(e);
        const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
        regenerateDays(trip);
        return { trips: [trip], activeTripId: trip.id };
      }
    }

    let root = loadRoot();

    function saveRoot() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(root));
      renderHeader();
      renderTripSelector();
    }

    function getCurrentTrip() {
      let t = root.trips.find(trip => trip.id === root.activeTripId);
      if (!t) {
        t = root.trips[0];
        root.activeTripId = t.id;
      }
      ensureTripShape(t);
      return t;
    }

    function regenerateDays(trip) {
      const start = trip.startDate ? new Date(trip.startDate) : null;
      const days = [];
      if (!trip.expensesByDay) trip.expensesByDay = {};

      for (let i = 0; i < trip.daysCount; i++) {
        let dStr = "";
        if (start) {
          const d = new Date(start);
          d.setDate(d.getDate() + i);
          dStr = d.toISOString().substring(0, 10);
        }
        const id = "day" + (i + 1);
        days.push({ id, label: "Day " + (i + 1), date: dStr });

        if (!trip.itinerary[id]) trip.itinerary[id] = [];
        if (!trip.expensesByDay[id]) trip.expensesByDay[id] = [];
      }

      trip.days = days;
      if (!trip.activeDayId) trip.activeDayId = days[0]?.id || "day1";
      if (!trip.activeExpenseDayId) trip.activeExpenseDayId = trip.activeDayId;
    }

    // ===== å°å·¥å…· =====
    function formatDateMMDD(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return String(m).padStart(2, "0") + "/" + String(day).padStart(2, "0");
    }
    function generateId(prefix) {
      return prefix + "_" + Math.random().toString(36).slice(2, 9);
    }
    function formatAmount(amount, currency) {
      if (amount == null || isNaN(amount)) return "-";
      const str = amount.toFixed(2).replace(/\.?0+$/, "");
      return currency + " " + str;
    }
    function parseTimeString(str) {
      if (!str) return "";
      let s = str.trim();
      if (/^\d{1,2}:\d{2}$/.test(s)) return s;
      s = s.replace(/[^\d]/g, "");
      if (!s) return "";
      if (s.length <= 2) {
        const hh = Math.min(parseInt(s, 10), 23);
        return String(hh).padStart(2, "0") + ":00";
      }
      if (s.length === 3) {
        const hh = Math.min(parseInt(s.slice(0, 1), 10), 23);
        const mm = Math.min(parseInt(s.slice(1), 10), 59);
        return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
      }
      const hh = Math.min(parseInt(s.slice(0, 2), 10), 23);
      const mm = Math.min(parseInt(s.slice(2, 4), 10), 59);
      return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
    }

    // ===== Nominatim åœ°é»æœå°‹ï¼ˆè¡Œç¨‹è‡ªå‹•å®Œæˆ + é‡˜é¸ï¼‰=====
    async function geocodePlace(place, cityHint) {
      const q = (cityHint ? `${place} ${cityHint}` : place).trim();
      if (!q) return null;
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept-Language": "zh-TW,en;q=0.8" } });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data || !data.length) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    async function searchPlaceSuggestions(query, cityHint) {
      const q = (cityHint ? `${query} ${cityHint}` : query).trim();
      if (!q) return [];
      const url =
        "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&q=" +
        encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept-Language": "zh-TW,en;q=0.8" } });
      if (!res.ok) return [];
      const data = await res.json();
      if (!Array.isArray(data)) return [];
      return data.map(item => {
        const full = item.display_name || "";
        const parts = full.split(",");
        const main = parts[0] ? parts[0].trim() : full;
        const sub = parts.slice(1).join(",").trim();
        return {
          name: main,
          fullName: full,
          lat: parseFloat(item.lat),
          lon: parseFloat(item.lon),
          sub
        };
      });
    }

    function setupItineraryTitleAutocomplete(inputEl, listEl, trip) {
      if (!inputEl || !listEl) return;
      let timer = null;
      let currentSuggestions = [];

      function hideList() {
        listEl.style.display = "none";
        listEl.innerHTML = "";
      }

      inputEl.addEventListener("input", () => {
        const q = inputEl.value.trim();
        delete inputEl.dataset.lat;
        delete inputEl.dataset.lon;

        if (timer) clearTimeout(timer);
        if (q.length < 2) { hideList(); return; }

        timer = setTimeout(async () => {
          try {
            const suggestions = await searchPlaceSuggestions(q, trip.destination);
            currentSuggestions = suggestions;
            if (!suggestions.length) { hideList(); return; }

            listEl.innerHTML = suggestions.map((s, idx) => `
              <div class="autocomplete-item" data-idx="${idx}">
                <span class="autocomplete-item-main">${s.name}</span>
                ${s.sub ? `<span class="autocomplete-item-sub">${s.sub}</span>` : ""}
              </div>
            `).join("");
            listEl.style.display = "block";

            listEl.querySelectorAll(".autocomplete-item").forEach(itemEl => {
              itemEl.addEventListener("click", () => {
                const idx = parseInt(itemEl.getAttribute("data-idx"), 10);
                const s = currentSuggestions[idx];
                if (!s) return;

                inputEl.value = s.name;
                inputEl.dataset.lat = s.lat;
                inputEl.dataset.lon = s.lon;

                if (!trip.placeCache) trip.placeCache = {};
                trip.placeCache[s.name] = { lat: s.lat, lon: s.lon };
                saveRoot();

                hideList();
              });
            });
          } catch (e) {
            console.error("autoComplete error", e);
            hideList();
          }
        }, 260);
      });

      document.addEventListener("click", (e) => {
        if (!listEl.contains(e.target) && e.target !== inputEl) hideList();
      });
    }

    async function getTripLatLon(trip) {
      if (trip.geo && typeof trip.geo.lat === "number" && typeof trip.geo.lon === "number") return trip.geo;
      const dest = (trip.destination || "").trim();
      if (!dest) return null;
      const geo = await geocodePlace(dest);
      if (!geo) return null;
      trip.geo = geo;
      saveRoot();
      return geo;
    }

    // ===== å¤©æ°£ï¼ˆOpen-Meteoï¼‰=====
    const WEATHER_CODE_MAP = {
      0:{emoji:"â˜€ï¸",text:"æ™´æœ—"},1:{emoji:"ğŸŒ¤",text:"å¤§è‡´æ™´æœ—"},2:{emoji:"â›…ï¸",text:"å¤šé›²æ™‚æ™´"},3:{emoji:"â˜ï¸",text:"å¤šé›²"},
      45:{emoji:"ğŸŒ«",text:"æœ‰éœ§"},48:{emoji:"ğŸŒ«",text:"æœ‰éœ§"},
      51:{emoji:"ğŸŒ¦",text:"æ¯›æ¯›é›¨"},53:{emoji:"ğŸŒ¦",text:"æ¯›æ¯›é›¨"},55:{emoji:"ğŸŒ§",text:"æ¯›æ¯›é›¨"},
      61:{emoji:"ğŸŒ§",text:"å°é›¨"},63:{emoji:"ğŸŒ§",text:"ä¸­é›¨"},65:{emoji:"ğŸŒ§",text:"å¤§é›¨"},
      71:{emoji:"â„ï¸",text:"å°é›ª"},73:{emoji:"â„ï¸",text:"ä¸­é›ª"},75:{emoji:"â„ï¸",text:"å¤§é›ª"},
      80:{emoji:"ğŸŒ§",text:"çŸ­æš«é™£é›¨"},81:{emoji:"ğŸŒ§",text:"é™£é›¨"},82:{emoji:"ğŸŒ§",text:"å¤§é›·é›¨"},
      95:{emoji:"â›ˆ",text:"é›·é™£é›¨"}
    };

    async function updateDayWeather(trip, dayId) {
      const box = document.getElementById("dayWeatherBox");
      if (!box) return;

      const dayInfo = trip.days.find(d => d.id === dayId);
      if (!dayInfo || !dayInfo.date) {
        box.innerHTML = `<div class="weather-loading">æ­¤æ—¥å°šæœªè¨­å®šæ—¥æœŸï¼Œç„¡æ³•æŸ¥è©¢å¤©æ°£ã€‚</div>`;
        return;
      }
      if (!trip.destination || !trip.destination.trim()) {
        box.innerHTML = `<div class="weather-loading">è«‹å…ˆåœ¨ã€Œæ—…ç¨‹è¨­å®šã€è¼¸å…¥ç›®çš„åœ°åŸå¸‚ï¼Œæ‰èƒ½å–å¾—å¤©æ°£è³‡è¨Šã€‚</div>`;
        return;
      }
      box.innerHTML = `<div class="weather-loading">è®€å–å¤©æ°£ä¸­â€¦</div>`;

      try {
        const geo = await getTripLatLon(trip);
        if (!geo) { box.innerHTML = `<div class="weather-loading">æ‰¾ä¸åˆ°ç›®çš„åœ°ä½ç½®ï¼Œè«‹ç¢ºèªç›®çš„åœ°åç¨±æ˜¯å¦æ­£ç¢ºã€‚</div>`; return; }

        const url =
          "https://api.open-meteo.com/v1/forecast" +
          `?latitude=${geo.lat}&longitude=${geo.lon}` +
          "&daily=temperature_2m_max,temperature_2m_min,weathercode" +
          "&timezone=auto" +
          `&start_date=${dayInfo.date}&end_date=${dayInfo.date}`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if (!data.daily || !data.daily.time || data.daily.time.length === 0) {
          box.innerHTML = `<div class="weather-loading">æŸ¥ä¸åˆ°é€™ä¸€å¤©çš„å¤©æ°£ï¼ˆå¯èƒ½è¶…å‡ºå¯é å ±ç¯„åœï¼‰ã€‚</div>`;
          return;
        }

        const maxT = data.daily.temperature_2m_max[0];
        const minT = data.daily.temperature_2m_min[0];
        const code = data.daily.weathercode ? data.daily.weathercode[0] : null;
        const info = WEATHER_CODE_MAP[code] || { emoji: "ğŸŒ¡", text: "å¤©æ°£è³‡è¨Š" };

        box.innerHTML = `
          <div class="weather-main">
            <div class="weather-emoji">${info.emoji}</div>
            <div>
              <div class="weather-temp">${Math.round(minT)}Â° / ${Math.round(maxT)}Â°</div>
              <div class="weather-sub">${trip.destination} Â· ${info.text}</div>
            </div>
          </div>
          <div class="weather-sub">è³‡æ–™ä¾†æºï¼šOpen-Meteoï¼ˆæ¯æ—¥æ•´é«”é«˜ / ä½æº«ï¼‰</div>
        `;
      } catch (e) {
        console.error(e);
        box.innerHTML = `<div class="weather-loading">å–å¾—å¤©æ°£å¤±æ•—ï¼Œå¯ä»¥ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚</div>`;
      }
    }

    // ===== Leaflet åœ°åœ–ï¼ˆè¡Œç¨‹é é€™ç‰ˆå…ˆä¿ç•™ï¼šé‡˜é¸ç•¶æ—¥è¡Œç¨‹ï¼‰=====
    let dayLeafletMap = null;
    let dayMarkerLayer = null;

    function initLeafletMap() {
      const mapEl = document.getElementById("dayMap");
      if (!mapEl) return null;

      if (dayLeafletMap) {
        if (dayLeafletMap._container !== mapEl) {
          dayLeafletMap.remove();
          dayLeafletMap = null;
          dayMarkerLayer = null;
        } else {
          return dayLeafletMap;
        }
      }

      dayLeafletMap = L.map(mapEl, { zoomControl: false });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap"
      }).addTo(dayLeafletMap);

      dayMarkerLayer = L.layerGroup().addTo(dayLeafletMap);
      return dayLeafletMap;
    }

    async function updateDayMap(trip, dayId) {
      const container = document.getElementById("dayMap");
      if (!container) return;

      const map = initLeafletMap();
      if (!map) return;

      setTimeout(() => map.invalidateSize(), 60);

      if (!dayMarkerLayer) return;
      dayMarkerLayer.clearLayers();

      const items = (trip.itinerary[dayId] || []).filter(i => i.title && i.title.trim());
      if (!trip.placeCache) trip.placeCache = {};
      const boundsPoints = [];

      for (const item of items) {
        let geo = null;

        if (typeof item.lat === "number" && typeof item.lon === "number") {
          geo = { lat: item.lat, lon: item.lon };
        } else {
          const key = item.title.trim();
          if (trip.placeCache[key]) {
            geo = trip.placeCache[key];
          } else {
            try {
              geo = await geocodePlace(key, trip.destination);
            } catch (e) {
              console.error("geocode å¤±æ•—:", key, e);
            }
            if (geo) {
              trip.placeCache[key] = geo;
              saveRoot();
            }
          }
        }

        if (geo) {
          const m = L.marker([geo.lat, geo.lon]).bindPopup(item.title);
          dayMarkerLayer.addLayer(m);
          boundsPoints.push([geo.lat, geo.lon]);
        }
      }

      if (boundsPoints.length) {
        map.fitBounds(boundsPoints, { padding: [30, 30] });
        return;
      }

      const tripGeo = await getTripLatLon(trip);
      if (tripGeo) {
        const m = L.marker([tripGeo.lat, tripGeo.lon]).bindPopup(trip.destination || "ç›®çš„åœ°");
        dayMarkerLayer.addLayer(m);
        map.setView([tripGeo.lat, tripGeo.lon], 11);
      } else {
        map.setView([23.5, 121], 6);
      }
    }

    // ===== èˆªç­ï¼ˆä¿ç•™ã€Œç”±èˆªç­è³‡æ–™åº«å¸¶å…¥ã€æŒ‰éˆ•ï¼‰=====
    const IATA_TO_CITY_ZH = {
      TPE:"å°åŒ—",TSA:"å°åŒ—",KHH:"é«˜é›„",
      NRT:"æ±äº¬",HND:"æ±äº¬",KIX:"å¤§é˜ª",FUK:"ç¦å²¡",
      CDG:"å·´é»",ORY:"å·´é»",AMS:"é˜¿å§†æ–¯ç‰¹ä¸¹",BRU:"å¸ƒé­¯å¡çˆ¾",
      ICN:"é¦–çˆ¾",GMP:"é¦–çˆ¾",HKG:"é¦™æ¸¯",
      LHR:"å€«æ•¦",LGW:"å€«æ•¦"
    };
    const AVIATIONSTACK_KEY = "f9e92bf4a1ac9571bb2f08a7050e0503";

    async function fetchFlightInfoByNumber(flightNo) {
      if (!AVIATIONSTACK_KEY || AVIATIONSTACK_KEY === "YOUR_ACCESS_KEY_HERE") {
        throw new Error("å°šæœªè¨­å®š Aviationstack API Key");
      }
      const cleanNo = flightNo.trim().toUpperCase().replace(/\s+/g, "");
      if (!cleanNo) throw new Error("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿ");

      const url =
        "https://api.aviationstack.com/v1/flights" +
        "?access_key=" + encodeURIComponent(AVIATIONSTACK_KEY) +
        "&flight_iata=" + encodeURIComponent(cleanNo) +
        "&limit=1";

      const res = await fetch(url);
      if (!res.ok) throw new Error("æŸ¥è©¢å¤±æ•—ï¼ŒHTTP " + res.status);

      const data = await res.json();
      if (!data || !data.data || data.data.length === 0) {
        throw new Error("æŸ¥ç„¡æ­¤èˆªç­ï¼ˆå¯èƒ½æ˜¯æ—¥æœŸä¸ç¬¦æˆ–å…è²»æ–¹æ¡ˆè³‡æ–™æœ‰é™ï¼‰");
      }

      const f = data.data[0];
      const dep = f.departure || {};
      const arr = f.arrival || {};

      let depDate = "";
      let depTime = "";
      if (dep.scheduled) {
        depDate = dep.scheduled.substring(0, 10);
        depTime = dep.scheduled.substring(11, 16);
      }

      return {
        from: dep.iata || dep.airport || "",
        to: arr.iata || arr.airport || "",
        date: depDate,
        time: depTime,
        status: f.flight_status || ""
      };
    }

    // ===== DOM =====
    const tripNameInput = document.getElementById("tripNameInput");
    const destinationInput = document.getElementById("destinationInput");
    const currencyInput = document.getElementById("currencyInput");
    const startDateInput = document.getElementById("startDateInput");
    const daysInput = document.getElementById("daysInput");
    const applyTripBtn = document.getElementById("applyTripBtn");
    const resetBtn = document.getElementById("resetBtn");
    const tripSelect = document.getElementById("tripSelect");
    const newTripBtn = document.getElementById("newTripBtn");
    const deleteTripBtn = document.getElementById("deleteTripBtn");

    const destinationTag = document.getElementById("destinationTag");
    const tripNameText = document.getElementById("tripNameText");
    const dateInfoText = document.getElementById("dateInfoText");
    const rateInfoText = document.getElementById("rateInfoText");
    const mainView = document.getElementById("mainView");

    const toggleTripSettingBtn = document.getElementById("toggleTripSettingBtn");
    const tripSettingContent = document.getElementById("tripSettingContent");

    const menuButton = document.getElementById("menuButton");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const tripDrawer = document.getElementById("tripDrawer");
    const drawerTripList = document.getElementById("drawerTripList");
    const drawerNewTripBtn = document.getElementById("drawerNewTripBtn");
    const drawerDeleteTripBtn = document.getElementById("drawerDeleteTripBtn");
    const drawerCloseBtn = document.getElementById("drawerCloseBtn");

    // æ”¶åˆè¨­å®š
    let tripSettingCollapsed = false;
    toggleTripSettingBtn.addEventListener("click", () => {
      tripSettingCollapsed = !tripSettingCollapsed;
      tripSettingContent.style.display = tripSettingCollapsed ? "none" : "block";
      toggleTripSettingBtn.textContent = tripSettingCollapsed ? "å±•é–‹è¨­å®š" : "æ”¶åˆè¨­å®š";
    });

    function renderHeader() {
      const trip = getCurrentTrip();
      tripNameText.textContent = trip.name || "æœªå‘½åæ—…ç¨‹";
      destinationTag.textContent = trip.destination || "æœªè¨­å®šç›®çš„åœ°";

      if (trip.startDate && trip.daysCount) {
        const start = new Date(trip.startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + trip.daysCount - 1);
        const info = `${trip.daysCount} å¤©è¡Œç¨‹ï½œ${formatDateMMDD(trip.startDate)} - ${formatDateMMDD(end.toISOString().substring(0, 10))}`;
        dateInfoText.textContent = info;
      } else {
        dateInfoText.textContent = "è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸";
      }

      const cur = (trip.currency || "").toUpperCase();
      const ex = trip.exchangeRate;
      if (ex && ex.rate && typeof ex.rate === "number" && (ex.base || "").toUpperCase() === cur && ex.target === "TWD") {
        rateInfoText.innerHTML = `<span>åŒ¯ç‡ï¼š1 ${ex.base} â‰ˆ ${ex.rate.toFixed(2)} TWD</span>`;
      } else {
        if (cur === "TWD") rateInfoText.innerHTML = `<span>åŒ¯ç‡ï¼šä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æ›ç®—</span>`;
        else rateInfoText.innerHTML = `<span>åŒ¯ç‡å°šæœªè¨­å®š</span>`;
      }
    }

    function initTripInputs() {
      const trip = getCurrentTrip();
      tripNameInput.value = trip.name || "";
      destinationInput.value = trip.destination || "";
      currencyInput.value = trip.currency || "JPY";
      startDateInput.value = trip.startDate || "";
      daysInput.value = trip.daysCount || 4;
    }

    function renderTripSelector() {
      const current = getCurrentTrip();
      tripSelect.innerHTML = "";
      root.trips.forEach(trip => {
        const opt = document.createElement("option");
        opt.value = trip.id;
        opt.textContent = trip.name || "æœªå‘½åæ—…ç¨‹";
        if (trip.id === current.id) opt.selected = true;
        tripSelect.appendChild(opt);
      });
    }

    // æŠ½å±œ
    function openDrawer() {
      tripDrawer.classList.add("open");
      drawerBackdrop.classList.add("show");
      renderDrawerTrips();
    }
    function closeDrawer() {
      tripDrawer.classList.remove("open");
      drawerBackdrop.classList.remove("show");
    }
    menuButton.addEventListener("click", openDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);
    drawerCloseBtn.addEventListener("click", closeDrawer);

    function renderDrawerTrips() {
      const currentId = root.activeTripId;
      drawerTripList.innerHTML = "";
      root.trips.forEach(t => {
        const div = document.createElement("div");
        div.className = "drawer-trip" + (t.id === currentId ? " active" : "");
        div.innerHTML = `
          <div class="drawer-trip-name">${t.name || "æœªå‘½åæ—…ç¨‹"}</div>
          <div class="drawer-trip-sub">${t.daysCount || 0} å¤© Â· ${t.startDate ? formatDateMMDD(t.startDate) : "æ—¥æœŸæœªè¨­å®š"}</div>
        `;
        div.addEventListener("click", () => {
          root.activeTripId = t.id;
          saveRoot();
          initTripInputs();
          renderHeader();
          renderTripSelector();
          renderCurrentMainView();
          closeDrawer();
        });
        drawerTripList.appendChild(div);
      });
    }

    drawerNewTripBtn.addEventListener("click", () => {
      const name = "æ–°æ—…ç¨‹ " + (root.trips.length + 1);
      const trip = createEmptyTrip(name);
      regenerateDays(trip);
      root.trips.push(trip);
      root.activeTripId = trip.id;
      saveRoot();
      initTripInputs();
      renderTripSelector();
      renderCurrentMainView();
      renderDrawerTrips();
    });

    drawerDeleteTripBtn.addEventListener("click", () => {
      if (root.trips.length <= 1) { alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹ï¼Œç„¡æ³•å…¨éƒ¨åˆªå…‰ã€‚"); return; }
      const trip = getCurrentTrip();
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${trip.name}ã€é€™å€‹æ—…ç¨‹å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) return;
      root.trips = root.trips.filter(t => t.id !== trip.id);
      root.activeTripId = root.trips[0].id;
      saveRoot();
      initTripInputs();
      renderTripSelector();
      renderCurrentMainView();
      renderDrawerTrips();
    });

    // å¥—ç”¨è®Šæ›´
    applyTripBtn.addEventListener("click", async () => {
      const trip = getCurrentTrip();
      const oldCurrency = trip.currency || "JPY";

      trip.name = tripNameInput.value.trim() || "æœªå‘½åæ—…ç¨‹";
      trip.destination = destinationInput.value.trim();
      const newCurrency = currencyInput.value;
      trip.currency = newCurrency;
      trip.startDate = startDateInput.value;

      let n = parseInt(daysInput.value, 10);
      if (isNaN(n)) n = 1;
      trip.daysCount = Math.max(1, Math.min(30, n));

      regenerateDays(trip);

      if (oldCurrency !== newCurrency) {
        trip.exchangeRate = { base: newCurrency, target: "TWD", rate: null, updatedAt: "" };
        if (newCurrency !== "TWD") {
          try {
            const result = await fetchRateToTWD(newCurrency);
            trip.exchangeRate = { base: newCurrency, target: "TWD", rate: result.rate, updatedAt: result.updatedAt };
          } catch (err) {
            console.error(err);
            alert("å·²å¥—ç”¨åŸºæœ¬è¨­å®šï¼Œä½†è‡ªå‹•æŠ“åŒ¯ç‡å¤±æ•—ã€‚\n\nåŸå› ï¼š" + err.message);
          }
        }
      } else {
        if (!trip.exchangeRate) trip.exchangeRate = { base: newCurrency, target: "TWD", rate: null, updatedAt: "" };
        trip.exchangeRate.base = newCurrency;
        trip.exchangeRate.target = "TWD";
      }

      trip.geo = null;
      trip.placeCache = {};

      saveRoot();
      renderCurrentMainView();
    });

    resetBtn.addEventListener("click", () => {
      const trip = getCurrentTrip();
      if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ—…ç¨‹çš„è¡Œç¨‹ã€èˆªç­ã€è¨˜å¸³èˆ‡è³¼ç‰©è³‡æ–™å—ï¼Ÿ")) return;
      trip.itinerary = {};
      trip.flights = [];
      trip.checklist = [];
      trip.expenses = [];
      trip.expensesByDay = {};
      trip.shopping = [];
      trip.placeCache = {};
      regenerateDays(trip);
      saveRoot();
      renderCurrentMainView();
    });

    // ===== åº•éƒ¨ Tab =====
    let currentTab = "itinerary";
    const bottomTabs = document.querySelectorAll(".bottom-tab");
    bottomTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const t = tab.getAttribute("data-tab");
        if (t === currentTab) return;
        currentTab = t;
        bottomTabs.forEach(tb => tb.classList.toggle("active", tb === tab));
        renderCurrentMainView();
      });
    });

    // ===== è¡Œç¨‹ Tab =====
    function renderItineraryView() {
      const trip = getCurrentTrip();

      if (!trip.days || trip.days.length === 0) {
        mainView.innerHTML = `<section class="card"><div class="empty">è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šæ—…ç¨‹æ—¥æœŸèˆ‡å¤©æ•¸</div></section>`;
        return;
      }

      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">æ¯æ—¥è¡Œç¨‹</div>
            <div class="pill"><span>ğŸ“</span><span>${trip.destination || "ç›®çš„åœ°æœªè¨­å®š"}</span></div>
          </div>

          <div class="day-chips">
            <div class="chip ${trip.activeDayId === "prep" ? "active" : ""}" data-day-id="prep">
              <strong>è¡Œå‰</strong><span>å¾…è¾¦æ¸…å–®</span>
            </div>
            ${trip.days.map(d => `
              <div class="chip ${d.id === trip.activeDayId ? "active" : ""}" data-day-id="${d.id}">
                <strong>${d.label}</strong><span>${formatDateMMDD(d.date)}</span>
              </div>
            `).join("")}
          </div>

          <div id="dayContent"></div>
        </section>
      `;

      mainView.innerHTML = html;

      document.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const id = chip.getAttribute("data-day-id");
          trip.activeDayId = id;
          saveRoot();
          renderItineraryView();
        });
      });

      renderDayContent(trip);
    }

    function renderPrepList(trip) {
      const container = document.getElementById("prepList");
      if (!container) return;

      if (!trip.checklist || trip.checklist.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è¡Œå‰å¾…è¾¦ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹æ–°å¢ã€‚</div>`;
        return;
      }

      container.innerHTML = trip.checklist.map(item => `
        <div class="check-row">
          <input type="checkbox" data-prep-id="${item.id}" ${item.done ? "checked" : ""}/>
          <div class="check-text ${item.done ? "done" : ""}">${item.text}</div>
          <button class="btn btn-danger btn-icon" data-prep-del="${item.id}">âœ•</button>
        </div>
      `).join("");

      container.querySelectorAll("[data-prep-id]").forEach(cb => {
        cb.addEventListener("change", () => {
          const id = cb.getAttribute("data-prep-id");
          const target = trip.checklist.find(i => i.id === id);
          if (target) {
            target.done = cb.checked;
            saveRoot();
            renderPrepList(trip);
          }
        });
      });

      container.querySelectorAll("[data-prep-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-prep-del");
          trip.checklist = trip.checklist.filter(i => i.id !== id);
          saveRoot();
          renderPrepList(trip);
        });
      });
    }

    function renderDayContent(trip) {
      const container = document.getElementById("dayContent");
      let dayId = trip.activeDayId;

      if (!dayId || (dayId !== "prep" && !trip.days.some(d => d.id === dayId))) {
        dayId = trip.days[0]?.id || "day1";
        trip.activeDayId = dayId;
      }

      if (dayId === "prep") {
        container.innerHTML = `
          <div>
            <div class="small-label">æ–°å¢ä¸€é …è¡Œå‰æº–å‚™</div>
            <div class="row">
              <div class="col">
                <input id="prepInput" placeholder="ä¾‹å¦‚ï¼šè¾¦æ—…éŠä¿éšªã€æ›å¤–å¹£ã€è²·ç¶²å¡â€¦" />
              </div>
              <button class="btn btn-primary btn-icon" id="addPrepBtn">ï¼‹</button>
            </div>

            <div style="margin-top:10px;">
              <div class="small-label">è¡Œå‰æº–å‚™æ¸…å–®</div>
              <div id="prepList"></div>
            </div>
          </div>
        `;

        renderPrepList(trip);

        document.getElementById("addPrepBtn").addEventListener("click", () => {
          const input = document.getElementById("prepInput");
          const text = input.value.trim();
          if (!text) return;
          trip.checklist.push({ id: generateId("prep"), text, done: false });
          input.value = "";
          saveRoot();
          renderPrepList(trip);
        });

        return;
      }

      const list = (trip.itinerary[dayId] || []).slice().sort((a, b) => (a.time || "").localeCompare(b.time || ""));

      const listHtml = list.length === 0
        ? `<div class="empty">é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œä¸‹æ–¹å¯ä»¥æ–°å¢ä¸€ç­†ï½</div>`
        : `<div class="list">${list.map(item => `
            <div class="list-item">
              <div class="list-main">
                <div class="list-meta">${item.time || "æ™‚é–“æœªå¡«å¯«"}</div>
                <div class="list-title">${item.title || "æœªå‘½åè¡Œç¨‹"}</div>
                ${item.note ? `<div class="list-note">${item.note}</div>` : ""}
              </div>
              <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
                <button class="btn btn-ghost btn-sm" data-open-map="${item.id}">å°èˆª</button>
                <button class="btn btn-ghost btn-sm" data-edit-itinerary="${item.id}">ç·¨è¼¯</button>
                <button class="btn btn-danger btn-icon" data-del-itinerary="${item.id}">âœ•</button>
              </div>
            </div>
          `).join("")}</div>`;

      container.innerHTML = `
        <div>
          <div class="small-label">ç•¶æ—¥å¤©æ°£</div>
          <div id="dayWeatherBox" class="weather-box"><div class="weather-loading">è®€å–å¤©æ°£ä¸­â€¦</div></div>

          <div class="small-label">ç•¶æ—¥è¡Œç¨‹åœ°åœ–ï¼ˆä¾è¡Œç¨‹è‡ªå‹•é‡˜é¸ï¼‰</div>
          <div id="dayMap" class="map-container"></div>

          <div style="margin-top:6px;">
            <div class="small-label">æ–°å¢è¡Œç¨‹é …ç›®</div>
            <div class="row">
              <div class="col">
                <input id="itTime" class="compact-time" type="time" placeholder="æ™‚é–“ï¼ˆä¾‹å¦‚ 09:00ï¼‰" />
              </div>
              <div class="col autocomplete-wrap">
                <input id="itTitle" placeholder="è¡Œç¨‹åç¨±ï¼ˆåœ°æ¨™/åœ°å€ï¼‰" autocomplete="off" />
                <div id="itTitleSuggest" class="autocomplete-list"></div>
              </div>
            </div>
            <textarea id="itNote" placeholder="å‚™è¨»ï¼ˆäº¤é€šæ–¹å¼ã€é–€ç¥¨ç­‰ï¼Œå¯ç•™ç™½ï¼‰"></textarea>
            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addItineraryBtn">ï¼‹ æ–°å¢è¡Œç¨‹</button>
            </div>
          </div>
        </div>
        ${listHtml}
      `;

      const timeInput = document.getElementById("itTime");
      const titleInput = document.getElementById("itTitle");
      const noteInput = document.getElementById("itNote");
      const addBtn = document.getElementById("addItineraryBtn");
      const titleSuggestBox = document.getElementById("itTitleSuggest");

      setupItineraryTitleAutocomplete(titleInput, titleSuggestBox, trip);

      timeInput.addEventListener("blur", () => {
        if (!timeInput.value) return;
        timeInput.value = parseTimeString(timeInput.value);
      });

      addBtn.onclick = () => {
        const time = parseTimeString(timeInput.value);
        const title = titleInput.value.trim();
        const note = noteInput.value.trim();
        if (!time && !title && !note) return;

        let lat = null, lon = null;
        if (titleInput.dataset.lat && titleInput.dataset.lon) {
          lat = parseFloat(titleInput.dataset.lat);
          lon = parseFloat(titleInput.dataset.lon);
          if (isNaN(lat) || isNaN(lon)) { lat = null; lon = null; }
        }

        if (editingItineraryId) {
          const target = (trip.itinerary[dayId] || []).find(i => i.id === editingItineraryId);
          if (target) {
            target.time = time;
            target.title = title || "æœªå‘½åè¡Œç¨‹";
            target.note = note;
            if (lat != null && lon != null) { target.lat = lat; target.lon = lon; }
          }
        } else {
          const item = { id: generateId("it"), time, title: title || "æœªå‘½åè¡Œç¨‹", note };
          if (lat != null && lon != null) { item.lat = lat; item.lon = lon; }
          if (!trip.itinerary[dayId]) trip.itinerary[dayId] = [];
          trip.itinerary[dayId].push(item);
        }

        if (lat != null && lon != null) {
          if (!trip.placeCache) trip.placeCache = {};
          trip.placeCache[title || "æœªå‘½åè¡Œç¨‹"] = { lat, lon };
        }

        editingItineraryId = null;
        addBtn.textContent = "ï¼‹ æ–°å¢è¡Œç¨‹";
        timeInput.value = "";
        titleInput.value = "";
        noteInput.value = "";
        delete titleInput.dataset.lat;
        delete titleInput.dataset.lon;

        saveRoot();
        renderDayContent(trip);
      };

      container.querySelectorAll("[data-del-itinerary]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del-itinerary");
          trip.itinerary[dayId] = (trip.itinerary[dayId] || []).filter(i => i.id !== id);
          saveRoot();
          renderDayContent(trip);
        });
      });

      container.querySelectorAll("[data-open-map]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-open-map");
          const item = (trip.itinerary[dayId] || []).find(i => i.id === id);
          const q = encodeURIComponent(item?.title || trip.destination || "æ™¯é»");
          window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
        });
      });

      container.querySelectorAll("[data-edit-itinerary]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit-itinerary");
          const item = (trip.itinerary[dayId] || []).find(i => i.id === id);
          if (!item) return;
          timeInput.value = item.time || "";
          titleInput.value = item.title || "";
          noteInput.value = item.note || "";
          if (typeof item.lat === "number" && typeof item.lon === "number") {
            titleInput.dataset.lat = item.lat;
            titleInput.dataset.lon = item.lon;
          } else {
            delete titleInput.dataset.lat;
            delete titleInput.dataset.lon;
          }
          editingItineraryId = id;
          addBtn.textContent = "å„²å­˜è¡Œç¨‹";
        });
      });

      updateDayMap(trip, dayId);
      updateDayWeather(trip, dayId);
    }

    // ===== èˆªç­ Tab =====
    function renderFlightsView() {
      const trip = getCurrentTrip();

      mainView.innerHTML = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">èˆªç­è³‡è¨Š</div>
          </div>

          <div id="flightList"></div>

          <div style="margin-top:10px;">
            <div class="small-label">æ–°å¢èˆªç­</div>
            <div class="row">
              <div class="col">
                <input type="date" id="flightDate" class="compact-date" />
              </div>
              <div class="col">
                <input id="flightNo" placeholder="ç­æ©Ÿè™Ÿï¼ˆä¾‹å¦‚ï¼šBR87ï¼‰" />
              </div>
            </div>

            <div style="margin:4px 0 8px; text-align:right;">
              <button class="btn btn-ghost btn-sm" id="fillFlightFromApiBtn">ç”±èˆªç­è³‡æ–™åº«å¸¶å…¥</button>
            </div>

            <div class="row">
              <div class="col"><input id="flightFrom" placeholder="å‡ºç™¼åœ°ï¼ˆä¾‹å¦‚ï¼šTPEï¼‰" /></div>
              <div class="col"><input id="flightTo" placeholder="æŠµé”åœ°ï¼ˆä¾‹å¦‚ï¼šCDGï¼‰" /></div>
            </div>

            <div class="row">
              <div class="col"><input id="flightTime" class="compact-time" type="time" placeholder="èµ·é£›æ™‚é–“ï¼ˆä¾‹å¦‚ï¼š23:40ï¼‰" /></div>
              <div class="col"><input id="flightNote" placeholder="å‚™è¨»ï¼ˆå»ç¨‹ï¼å›ç¨‹â€¦ï¼‰" /></div>
            </div>

            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addFlightBtn">ï¼‹ æ–°å¢èˆªç­</button>
            </div>
          </div>
        </section>
      `;

      renderFlightList(trip);

      const timeInput = document.getElementById("flightTime");
      timeInput.addEventListener("blur", () => {
        if (!timeInput.value) return;
        timeInput.value = parseTimeString(timeInput.value);
      });

      const fillBtn = document.getElementById("fillFlightFromApiBtn");
      fillBtn.addEventListener("click", async () => {
        const noInput = document.getElementById("flightNo");
        const fromInput = document.getElementById("flightFrom");
        const toInput = document.getElementById("flightTo");
        const timeInput = document.getElementById("flightTime");
        const noteInput = document.getElementById("flightNote");
        const dateInput = document.getElementById("flightDate");

        const flightNo = noInput.value;
        if (!flightNo.trim()) { alert("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿï¼Œä¾‹å¦‚ BR87"); return; }

        fillBtn.disabled = true;
        const originalText = fillBtn.textContent;
        fillBtn.textContent = "æŸ¥è©¢ä¸­â€¦";

        try {
          const info = await fetchFlightInfoByNumber(flightNo);
          if (info.from) fromInput.value = info.from;
          if (info.to) toInput.value = info.to;
          if (info.time) timeInput.value = info.time;
          if (info.date && !dateInput.value) dateInput.value = info.date;

          if (info.status) {
            if (!noteInput.value) noteInput.value = "ç‹€æ…‹ï¼š" + info.status;
            else if (!noteInput.value.includes("ç‹€æ…‹ï¼š")) noteInput.value += "ï¼ˆç‹€æ…‹ï¼š" + info.status + "ï¼‰";
          }
        } catch (err) {
          console.error(err);
          alert("æŸ¥è©¢å¤±æ•—ï¼šã€Œ" + err.message + "ã€\n\nå¯èƒ½åŸå› ï¼šç­æ©Ÿè™ŸéŒ¯èª¤ã€æ—¥æœŸä¸ç¬¦ã€æˆ–è¶…éå…è²»é¡åº¦ã€‚");
        } finally {
          fillBtn.disabled = false;
          fillBtn.textContent = originalText;
        }
      });

      document.getElementById("addFlightBtn").addEventListener("click", () => {
        const date = document.getElementById("flightDate").value;
        const no = document.getElementById("flightNo").value.trim();
        const from = document.getElementById("flightFrom").value.trim();
        const to = document.getElementById("flightTo").value.trim();
        const time = parseTimeString(document.getElementById("flightTime").value.trim());
        const note = document.getElementById("flightNote").value.trim();
        if (!no && !from && !to && !time && !note) return;

        trip.flights.push({ id: generateId("fl"), date, flightNo: no || "", from, to, time, note });
        saveRoot();
        renderFlightsView();
      });
    }

    function renderFlightList(trip) {
      const container = document.getElementById("flightList");
      if (!trip.flights || trip.flights.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰å°šæœªæ–°å¢èˆªç­ã€‚</div>`;
        return;
      }

      const html = trip.flights.slice().sort((a, b) => (a.date || "").localeCompare(b.date || "")).map(f => {
        const dateText = f.date ? formatDateMMDD(f.date) : "";
        const timeText = f.time || "";
        const fromCode = f.from || "???";
        const toCode = f.to || "???";
        const note = f.note || "";
        const toCityZh = IATA_TO_CITY_ZH[toCode.toUpperCase()] || toCode;

        return `
          <div class="flight-card-wrap">
            <div class="flight-card">
              <button class="flight-delete-btn" data-fl-del="${f.id}">âœ•</button>
              <div class="flight-card-top">
                <div class="flight-card-top-left">${dateText ? dateText : ""}${timeText ? " Â· " + timeText : ""}</div>
                <div style="font-size:11px;opacity:0.9;">${note ? note : ""}</div>
              </div>
              <div class="flight-card-main">
                <div>
                  <div class="flight-airport">${fromCode}</div>
                  <div class="flight-airport-label">FROM</div>
                </div>
                <div class="flight-plane-icon">âœˆï¸</div>
                <div style="text-align:right;">
                  <div class="flight-airport">${toCode}</div>
                  <div class="flight-airport-label">TO</div>
                </div>
              </div>
              <div class="flight-card-bottom">
                <div class="flight-extra-line">
                  <strong>ç­æ©Ÿï¼š</strong>${f.flightNo || "æœªå¡«å¯«"} Â· èˆªç­å‰å¾€${toCityZh}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      container.innerHTML = html;

      container.querySelectorAll("[data-fl-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-fl-del");
          trip.flights = trip.flights.filter(f => f.id !== id);
          saveRoot();
          renderFlightsView();
        });
      });
    }

    // ===== è¨˜å¸³ Tabï¼šä¾ Day åˆ†é  + ä½ è¦çš„æ¨¡æ¿ =====
    let expenseFilter = "all";

    function getActiveExpenseDayId(trip) {
      if (trip.activeExpenseDayId) return trip.activeExpenseDayId;
      if (trip.activeDayId && trip.activeDayId !== "prep") return trip.activeDayId;
      return (trip.days && trip.days[0]) ? trip.days[0].id : "day1";
    }

    function renderExpensesView() {
      const trip = getCurrentTrip();
      const cur = trip.currency || "JPY";

      if (!trip.days || trip.days.length === 0) {
        mainView.innerHTML = `<section class="card"><div class="empty">è«‹å…ˆè¨­å®šæ—…ç¨‹æ—¥æœŸèˆ‡å¤©æ•¸</div></section>`;
        return;
      }

      if (!trip.expensesByDay) trip.expensesByDay = {};
      trip.days.forEach(d => { if (!trip.expensesByDay[d.id]) trip.expensesByDay[d.id] = []; });

      const dayId = getActiveExpenseDayId(trip);
      trip.activeExpenseDayId = dayId;

      const dayList = trip.expensesByDay[dayId] || [];

      const total = dayList.reduce((sum, e) => sum + (e.amount || 0), 0);
      const cash = dayList.filter(e => e.method === "cash").reduce((s, e) => s + (e.amount || 0), 0);
      const card = dayList.filter(e => e.method === "card").reduce((s, e) => s + (e.amount || 0), 0);

      const rateObj = trip.exchangeRate;
      const useableRate =
        rateObj &&
        typeof rateObj.rate === "number" &&
        rateObj.rate > 0 &&
        (rateObj.base || "").toUpperCase() === (cur || "").toUpperCase() &&
        rateObj.target === "TWD"
          ? rateObj.rate
          : null;

      const calcTwd = (amount) => {
        if (cur === "TWD") return amount || 0;
        if (useableRate) return (amount || 0) * useableRate;
        return 0;
      };

      const totalTWD = calcTwd(total);
      const cashTWD = calcTwd(cash);
      const cardTWD = calcTwd(card);

      mainView.innerHTML = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">è¨˜å¸³</div>
          </div>

          <!-- Day åˆ†é ï¼ˆå›ºå®šï¼‰ -->
          <div style="position:sticky;top:0;z-index:20;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);padding-top:6px;">
            <div class="day-chips" style="margin-bottom:10px;">
              ${trip.days.map(d => `
                <div class="chip ${d.id === dayId ? "active" : ""}" data-exp-day-id="${d.id}">
                  <strong>${d.label}</strong>
                  <span>${formatDateMMDD(d.date)}</span>
                </div>
              `).join("")}
            </div>
          </div>

          <!-- ä½ è¦çš„ã€Œå¤§è—è‰²ç¸½è¦½å¡ã€æ¨¡æ¿ -->
          <div class="expense-hero">
            <div class="expense-hero-title">ç¸½æ”¯å‡ºï¼ˆ${cur}ï¼‰</div>
            <div class="expense-hero-amount">${total.toFixed(0)}</div>
            <div class="expense-hero-sub">
              ${useableRate || cur === "TWD" ? `ç´„ TWD ${totalTWD.toFixed(0)}` : `ç´„ TWD 0ï¼ˆå°šæœªè¨­å®šåŒ¯ç‡ï¼‰`}
            </div>

            <div class="expense-hero-split">
              <div class="expense-hero-col">
                <div class="expense-hero-col-label">ç¾é‡‘</div>
                <div class="expense-hero-col-amount">${cash.toFixed(0)}</div>
                <div class="expense-hero-col-sub">${useableRate || cur === "TWD" ? `ç´„ TWD ${cashTWD.toFixed(0)}` : `ç´„ TWD 0`}</div>
              </div>

              <div class="expense-hero-divider"></div>

              <div class="expense-hero-col">
                <div class="expense-hero-col-label">ä¿¡ç”¨å¡</div>
                <div class="expense-hero-col-amount">${card.toFixed(0)}</div>
                <div class="expense-hero-col-sub">${useableRate || cur === "TWD" ? `ç´„ TWD ${cardTWD.toFixed(0)}` : `ç´„ TWD 0`}</div>
              </div>
            </div>
          </div>

          <!-- ç¯©é¸ï¼šä½ åœ–é‚£ç¨® -->
          <div class="expense-seg">
            <div class="expense-seg-btn ${expenseFilter === "all" ? "active" : ""}" data-exp-filter="all">å…¨éƒ¨</div>
            <div class="expense-seg-btn ${expenseFilter === "cash" ? "active" : ""}" data-exp-filter="cash">ç¾é‡‘</div>
            <div class="expense-seg-btn ${expenseFilter === "card" ? "active" : ""}" data-exp-filter="card">ä¿¡ç”¨å¡</div>
          </div>

          <!-- åŒ¯ç‡ï¼ˆä¿ç•™åŠŸèƒ½ï¼Œæ”¾åœ¨ä¸‹é¢ä¸å¹²æ“¾ç‰ˆé¢ï¼‰ -->
          <div style="margin:6px 0 10px;">
            <div class="small-label">åŒ¯ç‡è¨­å®šï¼ˆ${cur} âœ TWDï¼‰</div>
            <div class="row">
              <div class="col">
                <input id="rateInput" placeholder="1 ${cur} = ? TWD" />
              </div>
              <button class="btn btn-ghost btn-sm" id="fetchRateBtn">æŸ¥è©¢</button>
              <button class="btn btn-primary btn-sm" id="saveRateBtn">å„²å­˜</button>
            </div>
            <div style="font-size:11px;color:var(--text-sub);" id="rateStatusText"></div>
          </div>

          <!-- æ–°å¢ / ç·¨è¼¯ï¼ˆç¶­æŒä½ åŸæœ¬æ¬„ä½æ¦‚å¿µï¼‰ -->
          <div style="margin-top:10px;">
            <div class="small-label">æ–°å¢ / ç·¨è¼¯æ”¯å‡ºï¼ˆ${trip.days.find(d=>d.id===dayId)?.label || ""}ï¼‰</div>

            <div class="row">
              <div class="col">
                <select id="expMethod">
                  <option value="cash">ç¾é‡‘</option>
                  <option value="card">ä¿¡ç”¨å¡</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
              <div class="col">
                <input id="expAmount" type="number" placeholder="é‡‘é¡ï¼ˆ${cur}ï¼‰" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <input id="expCategory" placeholder="åˆ†é¡ï¼ˆé¤é£²ã€äº¤é€šâ€¦ï¼‰" />
              </div>
              <div class="col">
                <input id="expApproxTwd" type="number" placeholder="ç´„ç•¶ TWDï¼ˆå¯ç•™ç™½ï¼‰" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <input id="expNote" placeholder="å‚™è¨»ï¼ˆåº—åã€åˆ·å“ªå¼µå¡â€¦ï¼‰" />
              </div>
            </div>

            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addExpenseBtn">${editingExpenseId ? "å„²å­˜æ”¯å‡º" : "ï¼‹ æ–°å¢æ”¯å‡º"}</button>
            </div>
          </div>

          <div style="margin-top:10px;" id="expenseList"></div>
        </section>
      `;

      // Day chips åˆ‡æ›
      document.querySelectorAll("[data-exp-day-id]").forEach(chip => {
        chip.addEventListener("click", () => {
          const id = chip.getAttribute("data-exp-day-id");
          trip.activeExpenseDayId = id;
          saveRoot();
          renderExpensesView();
        });
      });

      // ç¯©é¸åˆ‡æ›
      document.querySelectorAll("[data-exp-filter]").forEach(btn => {
        btn.addEventListener("click", () => {
          expenseFilter = btn.getAttribute("data-exp-filter");
          renderExpensesView();
        });
      });

      // åŒ¯ç‡ç‹€æ…‹
      const rateStatusTextEl = document.getElementById("rateStatusText");
      const rateInput = document.getElementById("rateInput");
      const fetchBtn = document.getElementById("fetchRateBtn");
      const saveBtn = document.getElementById("saveRateBtn");

      if (cur === "TWD") {
        rateStatusTextEl.textContent = "ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€è¨­å®šåŒ¯ç‡ã€‚";
        rateInput.value = "";
      } else if (useableRate) {
        rateStatusTextEl.textContent = `ç›®å‰åŒ¯ç‡ï¼š1 ${cur} â‰ˆ ${useableRate.toFixed(2)} TWD`;
        rateInput.value = useableRate.toFixed(2);
      } else {
        rateStatusTextEl.textContent = "å°šæœªè¨­å®šåŒ¯ç‡ï¼Œå¯æŸ¥è©¢æˆ–æ‰‹å‹•è¼¸å…¥å¾Œå„²å­˜ã€‚";
        rateInput.value = "";
      }

      fetchBtn.addEventListener("click", async () => {
        if (cur === "TWD") { alert("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æŸ¥è©¢åŒ¯ç‡ã€‚"); return; }
        fetchBtn.disabled = true;
        const original = fetchBtn.textContent;
        fetchBtn.textContent = "æŸ¥è©¢ä¸­â€¦";
        try {
          const result = await fetchRateToTWD(cur);
          trip.exchangeRate = { base: cur, target: "TWD", rate: result.rate, updatedAt: result.updatedAt };
          saveRoot();
          renderExpensesView();
        } catch (err) {
          console.error(err);
          alert("åŒ¯ç‡æŸ¥è©¢å¤±æ•—ï¼šã€" + err.message + "ã€\n\nä½ ä»å¯æ‰‹å‹•è¼¸å…¥å¾Œå„²å­˜ã€‚");
        } finally {
          fetchBtn.disabled = false;
          fetchBtn.textContent = original;
        }
      });

      saveBtn.addEventListener("click", () => {
        if (cur === "TWD") return;
        const v = parseFloat(rateInput.value);
        if (isNaN(v) || v <= 0) { alert("è«‹è¼¸å…¥æ­£ç¢ºçš„åŒ¯ç‡æ•¸å­—ï¼ˆ> 0ï¼‰ã€‚"); return; }
        trip.exchangeRate = { base: cur, target: "TWD", rate: v, updatedAt: "" };
        saveRoot();
        renderExpensesView();
      });

      // æ–°å¢ / ç·¨è¼¯
      const expMethod = document.getElementById("expMethod");
      const expAmount = document.getElementById("expAmount");
      const expCategory = document.getElementById("expCategory");
      const expApproxTwd = document.getElementById("expApproxTwd");
      const expNote = document.getElementById("expNote");
      const addBtn = document.getElementById("addExpenseBtn");

      addBtn.onclick = () => {
        const method = expMethod.value;
        const amount = parseFloat(expAmount.value);
        const category = expCategory.value.trim();
        const note = expNote.value.trim();
        const approxTwdVal = parseFloat(expApproxTwd.value);

        if (isNaN(amount)) return;

        const approxTwd =
          !isNaN(approxTwdVal) ? approxTwdVal :
          (cur === "TWD" ? amount : (useableRate ? amount * useableRate : null));

        if (!trip.expensesByDay[dayId]) trip.expensesByDay[dayId] = [];

        if (editingExpenseId) {
          const target = trip.expensesByDay[dayId].find(e => e.id === editingExpenseId);
          if (target) {
            target.method = method;
            target.amount = amount;
            target.category = category;
            target.note = note;
            target.approxTwd = approxTwd;
          }
        } else {
          trip.expensesByDay[dayId].push({
            id: generateId("exp"),
            method, amount, category, note,
            approxTwd
          });
        }

        editingExpenseId = null;
        saveRoot();
        renderExpensesView();
      };

      renderExpenseList(trip, dayId, useableRate);
    }

    function renderExpenseList(trip, dayId, rateForCalc) {
      const container = document.getElementById("expenseList");
      const cur = trip.currency || "JPY";
      const all = (trip.expensesByDay && trip.expensesByDay[dayId]) ? trip.expensesByDay[dayId].slice() : [];

      let list = all;
      if (expenseFilter === "cash") list = list.filter(e => e.method === "cash");
      if (expenseFilter === "card") list = list.filter(e => e.method === "card");

      if (!list.length) {
        container.innerHTML = `<div class="empty">æ­¤æ—¥å°šç„¡æ”¯å‡ºç´€éŒ„ã€‚</div>`;
        return;
      }

      // è®“æ¸…å–®ç©©å®šæ’åºï¼šå…ˆåˆ†é¡å†é‡‘é¡
      list.sort((a, b) => (a.category || "").localeCompare(b.category || "") || ((b.amount || 0) - (a.amount || 0)));

      const approxText = (e) => {
        if (typeof e.approxTwd === "number" && !isNaN(e.approxTwd)) return `ç´„ TWD ${e.approxTwd.toFixed(0)}`;
        if (cur === "TWD") return `ç´„ TWD ${(e.amount || 0).toFixed(0)}`;
        if (rateForCalc && typeof e.amount === "number") return `ç´„ TWD ${(e.amount * rateForCalc).toFixed(0)}`;
        return "";
      };

      container.innerHTML = `
        <div class="list">
          ${list.map(e => {
            let methodLabel = "å…¶ä»–";
            if (e.method === "cash") methodLabel = "ç¾é‡‘";
            if (e.method === "card") methodLabel = "ä¿¡ç”¨å¡";
            const approx = approxText(e);

            return `
              <div class="list-item">
                <div class="list-main">
                  <div class="list-title">
                    ${e.category || "æœªåˆ†é¡"}
                    <span class="badge">${methodLabel}</span>
                    <span class="badge">${formatAmount(e.amount, cur)}</span>
                    ${approx ? `<span class="badge">${approx}</span>` : ""}
                  </div>
                  ${e.note ? `<div class="list-note">${e.note}</div>` : ""}
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
                  <button class="btn btn-ghost btn-sm" data-exp-edit="${e.id}">ç·¨è¼¯</button>
                  <button class="btn btn-danger btn-icon" data-exp-del="${e.id}">âœ•</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      container.querySelectorAll("[data-exp-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-exp-del");
          trip.expensesByDay[dayId] = (trip.expensesByDay[dayId] || []).filter(e => e.id !== id);
          saveRoot();
          renderExpensesView();
        });
      });

      container.querySelectorAll("[data-exp-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-exp-edit");
          const target = (trip.expensesByDay[dayId] || []).find(e => e.id === id);
          if (!target) return;

          document.getElementById("expMethod").value = target.method || "cash";
          document.getElementById("expAmount").value = target.amount != null ? target.amount : "";
          document.getElementById("expCategory").value = target.category || "";
          document.getElementById("expApproxTwd").value = (target.approxTwd != null) ? String(Math.round(target.approxTwd)) : "";
          document.getElementById("expNote").value = target.note || "";

          editingExpenseId = id;
          document.getElementById("addExpenseBtn").textContent = "å„²å­˜æ”¯å‡º";
        });
      });
    }

    // ===== è³¼ç‰© Tab =====
    function renderShoppingView() {
      const trip = getCurrentTrip();
      const cur = trip.currency || "JPY";
      const totalPlan = trip.shopping.reduce((s, i) => s + (i.price || 0), 0);
      const totalBought = trip.shopping.filter(i => i.bought).reduce((s, i) => s + (i.price || 0), 0);

      mainView.innerHTML = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">è³¼ç‰©æ¸…å–®</div>
          </div>

          <div style="font-size:12px;color:var(--text-sub);">
            <div style="display:flex;justify-content:space-between;margin-top:4px;">
              <span>è¨ˆç•«è³¼ç‰©ç¸½é¡</span><strong style="color:#111827;">${formatAmount(totalPlan, cur)}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:4px;">
              <span>å·²è³¼è²·é‡‘é¡</span><strong style="color:#111827;">${formatAmount(totalBought, cur)}</strong>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="small-label">æ–°å¢è³¼ç‰©é …ç›®</div>
            <input id="shopName" placeholder="å“é …åç¨±ï¼ˆä¾‹å¦‚ï¼šå”‡è†ã€é¦™æ°´â€¦ï¼‰" />
            <div class="row" style="margin-top:4px;">
              <div class="col"><input id="shopPrice" type="number" placeholder="åƒ¹æ ¼ï¼ˆ${cur}ï¼‰å¯ç•™ç™½" /></div>
              <div class="col"><input id="shopNote" placeholder="å‚™è¨»ï¼ˆåº—å®¶ã€è‰²è™Ÿâ€¦ï¼‰" /></div>
            </div>
            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addShopBtn">ï¼‹ æ–°å¢å“é …</button>
            </div>
          </div>

          <div style="margin-top:10px;" id="shopList"></div>
        </section>
      `;

      renderShopList(trip);

      document.getElementById("addShopBtn").addEventListener("click", () => {
        const name = document.getElementById("shopName").value.trim();
        const priceRaw = document.getElementById("shopPrice").value;
        const note = document.getElementById("shopNote").value.trim();
        if (!name && !note) return;
        const price = parseFloat(priceRaw);

        trip.shopping.push({
          id: generateId("shop"),
          name: name || "æœªå‘½åå“é …",
          price: isNaN(price) ? 0 : price,
          note,
          bought: false
        });

        saveRoot();
        renderShoppingView();
      });
    }

    function renderShopList(trip) {
      const container = document.getElementById("shopList");
      if (!trip.shopping || trip.shopping.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è³¼ç‰©å“é …ã€‚</div>`;
        return;
      }
      const cur = trip.currency || "JPY";

      container.innerHTML = `
        <div class="list">
          ${trip.shopping.map(item => `
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">
                  ${item.name}
                  ${item.bought ? `<span class="badge">å·²è³¼è²·</span>` : ""}
                  ${item.price ? `<span class="badge">${formatAmount(item.price, cur)}</span>` : ""}
                </div>
                ${item.note ? `<div class="list-note">${item.note}</div>` : ""}
              </div>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <button class="btn btn-ghost btn-sm" data-shop-toggle="${item.id}">${item.bought ? "å–æ¶ˆå·²è²·" : "æ¨™è¨˜å·²è²·"}</button>
                <button class="btn btn-danger btn-icon" data-shop-del="${item.id}">âœ•</button>
              </div>
            </div>
          `).join("")}
        </div>
      `;

      container.querySelectorAll("[data-shop-toggle]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-shop-toggle");
          const target = trip.shopping.find(i => i.id === id);
          if (target) {
            target.bought = !target.bought;
            saveRoot();
            renderShoppingView();
          }
        });
      });

      container.querySelectorAll("[data-shop-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-shop-del");
          trip.shopping = trip.shopping.filter(i => i.id !== id);
          saveRoot();
          renderShoppingView();
        });
      });
    }

    // ===== ä¸»ç•«é¢åˆ‡æ› =====
    function renderCurrentMainView() {
      if (currentTab === "itinerary") renderItineraryView();
      else if (currentTab === "flights") renderFlightsView();
      else if (currentTab === "expenses") renderExpensesView();
      else if (currentTab === "shopping") renderShoppingView();
    }

    // ===== æ—…ç¨‹é¸æ“‡ï¼ˆä¿ç•™ï¼‰=====
    tripSelect.addEventListener("change", () => {
      root.activeTripId = tripSelect.value;
      initTripInputs();
      renderHeader();
      renderCurrentMainView();
      saveRoot();
    });
    newTripBtn.addEventListener("click", () => {
      const name = "æ–°æ—…ç¨‹ " + (root.trips.length + 1);
      const trip = createEmptyTrip(name);
      regenerateDays(trip);
      root.trips.push(trip);
      root.activeTripId = trip.id;
      saveRoot();
      initTripInputs();
      renderTripSelector();
      renderCurrentMainView();
    });
    deleteTripBtn.addEventListener("click", () => {
      if (root.trips.length <= 1) { alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹ï¼Œç„¡æ³•å…¨éƒ¨åˆªå…‰ã€‚"); return; }
      const trip = getCurrentTrip();
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${trip.name}ã€é€™å€‹æ—…ç¨‹å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) return;
      root.trips = root.trips.filter(t => t.id !== trip.id);
      root.activeTripId = root.trips[0].id;
      saveRoot();
      initTripInputs();
      renderTripSelector();
      renderCurrentMainView();
    });

    // ===== åˆå§‹åŒ– =====
    (function init() {
      const trip = getCurrentTrip();
      if (!trip.days || trip.days.length === 0) regenerateDays(trip);
      renderTripSelector();
      initTripInputs();
      renderHeader();
      renderCurrentMainView();
    })();
  </script>
</body>
</html>
