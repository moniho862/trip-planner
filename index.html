<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Trip Planner</title>

  <!-- Leaflet åœ°åœ– CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg-top:#c5e0ff;
      --bg-mid:#f5f7ff;
      --bg:#ffffff;

      --card:#ffffff;
      --text:#111827;
      --sub:#6b7280;

      --primary:#3b82f6;
      --primarySoft:rgba(59,130,246,.10);
      --danger:#ef4444;

      --radius-lg:20px;
      --radius-md:14px;

      --maxw:480px;
      --bottomSafe: env(safe-area-inset-bottom, 0px);
      --topSafe: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif; }
    body{
      margin:0;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 40%, var(--bg) 100%);
      -webkit-text-size-adjust:100%;
    }

    .app{
      max-width:var(--maxw);
      margin:0 auto;
      min-height:100vh;
      padding: calc(16px + var(--topSafe)) 16px calc(92px + var(--bottomSafe));
      position:relative;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:12px;
    }

    .leftHead{ display:flex; align-items:flex-start; gap:8px; }
    .titleRow{ display:flex; align-items:center; gap:8px; }
    .title{
      font-size:20px;
      font-weight:800;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .subtitle{
      font-size:12px;
      color:var(--sub);
      margin-top:2px;
    }

    .tag{
      font-size:11px;
      padding: 4px 10px;
      border-radius:999px;
      background: var(--primarySoft);
      color: #1d4ed8;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .iconBtn{
      width:34px;
      height:34px;
      border-radius:12px;
      border:none;
      background: rgba(59,130,246,.12);
      color:#1d4ed8;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .iconBtn:active{ transform: scale(.98); }

    .topInfo{
      text-align:right;
      font-size:11px;
      color:var(--sub);
      line-height:1.35;
    }
    .ratePill{
      margin-top:4px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 3px 10px;
      border-radius:999px;
      background: rgba(59,130,246,.08);
      color:#1d4ed8;
      font-size:11px;
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius-lg);
      padding: 12px 14px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08);
      margin-bottom:12px;
    }

    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .cardTitle{
      font-size:14px;
      font-weight:700;
    }

    .smallLabel{
      font-size:11px;
      color:var(--sub);
      margin-bottom:6px;
      display:block;
    }

    input, select, textarea{
      width:100%;
      font-size:16px;
      padding: 8px 10px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      outline:none;
      background:#f9fafb;
      height:40px;
    }
    textarea{
      border-radius:14px;
      height:auto;
      min-height:56px;
      resize:vertical;
      padding:10px 10px;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--primary);
      background:#ffffff;
    }
    input[type="date"], input[type="time"]{
      -webkit-appearance:none;
      appearance:none;
    }

    .row{ display:flex; gap:8px; margin-bottom:8px; }
    .col{ flex:1; }

    .btn{
      border:none;
      border-radius:999px;
      padding: 8px 14px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.99); }
    .btnPrimary{ background:var(--primary); color:#fff; }
    .btnGhost{ background:#eef2ff; color:#4f46e5; }
    .btnDanger{ background:#fee2e2; color:#b91c1c; }

    .btnIcon{
      width:32px;
      height:32px;
      padding:0;
      border-radius:999px;
      justify-content:center;
    }

    /* ===== å›ºå®šçš„ã€Œæ¯æ—¥è¡Œç¨‹ã€ä¸Šæ–¹æ¬„ä½ ===== */
    .stickyWrap{
      position: sticky;
      top: calc(0px + var(--topSafe));
      z-index: 20;
      margin-bottom:10px;
    }

    .stickyCard{
      background: rgba(255,255,255,.92);
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(229,231,235,.8);
    }

    .dayTopRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      font-size:11px;
      white-space:nowrap;
    }

    .dayChips{
      display:flex;
      overflow-x:auto;
      gap:8px;
      padding-bottom:4px;
      -webkit-overflow-scrolling: touch;
    }
    .chip{
      min-width:78px;
      padding:8px 10px;
      border-radius:16px;
      background:#eff6ff;
      color:#1d4ed8;
      font-size:11px;
      text-align:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .chip strong{ display:block; font-size:13px; margin-bottom:2px; }
    .chip.active{
      background:#1d4ed8;
      color:#eff6ff;
    }
    .chip.prepChip{ min-width:86px; }

    /* è¡Œç¨‹/åœ°åœ– åˆ†é  */
    .segTabs{
      display:flex;
      background:#f3f4f6;
      border-radius:999px;
      padding:4px;
      gap:4px;
      margin-top:10px;
    }
    .segTab{
      flex:1;
      text-align:center;
      font-size:13px;
      padding:8px 0;
      border-radius:999px;
      cursor:pointer;
      color:var(--sub);
      user-select:none;
    }
    .segTab.active{
      background:#111827;
      color:#f9fafb;
    }

    /* åˆ—è¡¨ */
    .list{ margin-top:8px; }
    .listItem{
      background:#f9fafb;
      border-radius:var(--radius-md);
      padding:10px 10px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .listMain{ flex:1; min-width:0; }
    .meta{ font-size:11px; color:var(--sub); margin-bottom:4px; }
    .itemTitle{ font-size:13px; font-weight:700; margin-bottom:4px; word-break:break-word; }
    .note{ font-size:12px; color:#4b5563; word-break:break-word; }

    .badge{
      display:inline-block;
      font-size:10px;
      padding: 2px 7px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      margin-left:4px;
      white-space:nowrap;
    }

    .empty{
      font-size:12px;
      color:var(--sub);
      text-align:center;
      padding: 12px 4px;
    }

    /* åœ°åœ–å®¹å™¨ */
    .mapContainer{
      width:100%;
      height: 300px;
      border-radius:16px;
      overflow:hidden;
      background:#e5e7eb;
    }

    /* Autocomplete */
    .autocompleteWrap{ position:relative; }
    .autocompleteList{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:6px;
      background:#fff;
      border-radius:14px;
      box-shadow: 0 14px 30px rgba(15,23,42,.18);
      max-height: 240px;
      overflow:auto;
      display:none;
      z-index: 3000;
    }
    .acItem{
      padding: 10px 10px;
      cursor:pointer;
      border-bottom:1px solid #f3f4f6;
    }
    .acItem:last-child{ border-bottom:none; }
    .acItem:hover{ background:#eff6ff; }
    .acMain{ display:block; font-size:13px; font-weight:600; }
    .acSub{ display:block; font-size:11px; color:var(--sub); margin-top:3px; }

    /* å¤©æ°£ */
    .weatherBox{
      width:100%;
      border-radius:16px;
      padding: 10px 10px;
      background:#eff6ff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .weatherLeft{ display:flex; gap:10px; align-items:center; }
    .wEmoji{ font-size:22px; }
    .wTemp{ font-size:16px; font-weight:800; }
    .wSub{ font-size:11px; color:var(--sub); margin-top:2px; }
    .wLoading{ font-size:12px; color:var(--sub); }

    /* èˆªç­å¡ */
    .flightCard{
      border-radius:22px;
      padding:12px 14px;
      background: linear-gradient(135deg, #2563eb, #0ea5e9);
      color:#f9fafb;
      box-shadow: 0 14px 32px rgba(15,23,42,.35);
      position:relative;
      overflow:hidden;
      margin-bottom:10px;
    }
    .flightTop{ display:flex; justify-content:space-between; align-items:center; font-size:12px; opacity:.92; gap:10px; }
    .flightMain{ display:flex; justify-content:space-between; align-items:center; margin-top:10px; }
    .airport{ font-size:22px; font-weight:900; letter-spacing:2px; }
    .airportLbl{ font-size:11px; opacity:.9; }
    .plane{ font-size:22px; padding:0 10px; }
    .flightBottom{ margin-top:8px; font-size:12px; opacity:.95; }
    .flightDel{
      position:absolute; top:8px; right:8px;
      width:28px; height:28px;
      border-radius:999px;
      border:none;
      background: rgba(248,113,113,.95);
      color:#fff;
      font-size:16px;
      cursor:pointer;
    }

    /* ===== è¨˜å¸³ï¼šåœ–äºŒæ¨£å¼ï¼ˆç¸½æ”¯å‡º + ç¾é‡‘/ä¿¡ç”¨å¡æ‹†åˆ†ï¼‰ ===== */
    .expenseSummaryCard{
      border-radius:22px;
      padding:14px 14px;
      background: linear-gradient(135deg, #4f46e5, #0ea5e9);
      color:#f9fafb;
      box-shadow: 0 14px 32px rgba(15,23,42,.25);
      overflow:hidden;
      margin-top:10px;
    }
    .expenseSumTop{
      text-align:center;
      font-size:12px;
      opacity:.92;
      letter-spacing:.2px;
    }
    .expenseSumMain{
      text-align:center;
      font-size:34px;
      font-weight:900;
      line-height:1.05;
      margin-top:6px;
    }
    .expenseSumSub{
      text-align:center;
      font-size:12px;
      opacity:.9;
      margin-top:4px;
    }
    .expenseSplit{
      display:flex;
      margin-top:12px;
      border-top: 1px solid rgba(255,255,255,.22);
      padding-top:12px;
    }
    .expenseCol{
      flex:1;
      text-align:center;
      padding: 0 8px;
    }
    .expenseColTitle{
      font-size:12px;
      opacity:.92;
      margin-bottom:6px;
    }
    .expenseColVal{
      font-size:22px;
      font-weight:900;
      line-height:1.05;
    }
    .expenseColSub{
      font-size:12px;
      opacity:.88;
      margin-top:4px;
    }
    .expenseDivider{
      width:1px;
      background: rgba(255,255,255,.28);
      margin: 0 6px;
      border-radius:1px;
    }

    /* è¡Œå‰å¾…è¾¦ */
    .prepAddRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:8px;
    }
    .prepAddRow input{
      height:44px;
      border-radius:999px;
      background:#f9fafb;
    }
    .prepAddBtn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:none;
      background: var(--primary);
      color:#fff;
      font-size:22px;
      cursor:pointer;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 22px rgba(37,99,235,.25);
    }
    .prepAddBtn:active{ transform:scale(.98); }
    .todoItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 10px;
      border-radius:16px;
      background:#f9fafb;
      margin-bottom:8px;
    }
    .todoCheck{
      width:22px;height:22px;border-radius:8px;
      border:1px solid #d1d5db;background:#fff;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer; flex:0 0 auto;
      margin-top:2px;
    }
    .todoCheck.done{
      background:#111827;
      border-color:#111827;
      color:#fff;
    }
    .todoText{
      flex:1; min-width:0;
      font-size:13px; font-weight:700;
      word-break:break-word;
    }
    .todoText.done{ text-decoration: line-through; color:#6b7280; font-weight:600; }
    .todoDel{
      width:34px;height:34px;border-radius:999px;
      border:none;background:#fee2e2;color:#b91c1c;
      cursor:pointer; flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
    }

    /* ===== åº•éƒ¨å°èˆª ===== */
    .bottomNav{
      position:fixed;
      left:0; right:0; bottom:0;
      max-width:var(--maxw);
      margin:0 auto;
      padding: 10px 16px calc(14px + var(--bottomSafe));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(18px);
      border-top: 1px solid rgba(209,213,219,.8);
      z-index: 9999;
    }
    .bottomTabs{
      display:flex;
      background:#f3f4f6;
      border-radius:999px;
      padding:4px;
      gap:4px;
    }
    .bottomTab{
      flex:1;
      text-align:center;
      font-size:11px;
      padding: 7px 0 6px;
      border-radius:999px;
      color:#6b7280;
      cursor:pointer;
      user-select:none;
    }
    .bottomTab span{ display:block; font-size:16px; margin-bottom:2px; }
    .bottomTab.active{ background:#111827; color:#f9fafb; }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      z-index: 10000;
      padding: 16px;
      padding-top: calc(16px + var(--topSafe));
      padding-bottom: calc(16px + var(--bottomSafe));
    }
    .modalBackdrop.show{ display:flex; align-items:flex-end; justify-content:center; }
    .modal{
      width:min(var(--maxw), 100%);
      background:#fff;
      border-radius:24px;
      box-shadow: 0 30px 80px rgba(15,23,42,.35);
      overflow:hidden;
      max-height: 86vh;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #f3f4f6;
    }
    .modalHeadTitle{ font-weight:800; font-size:14px; }
    .modalClose{
      width:34px; height:34px;
      border-radius:12px;
      border:none;
      background:#f3f4f6;
      cursor:pointer;
      font-size:18px;
      color:#111827;
    }
    .modalBody{ padding: 12px 14px; overflow:auto; }
    .modalFoot{
      padding: 12px 14px;
      border-top:1px solid #f3f4f6;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(10px);
    }

    /* Drawer */
    .drawerBackdrop{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,.4);
      display:none;
      z-index: 9000;
    }
    .drawerBackdrop.show{ display:block; }
    .drawer{
      position:fixed;
      top:0; left:0; bottom:0;
      width:280px;
      max-width:80%;
      background:#fff;
      transform: translateX(-100%);
      transition: transform .25s ease-out;
      z-index: 9001;
      padding: 16px 14px calc(18px + var(--bottomSafe));
      box-shadow: 12px 0 32px rgba(15,23,42,.35);
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerTitle{ font-size:16px; font-weight:800; margin-bottom:12px; }
    .drawerClose{
      position:absolute;
      top:12px; right:12px;
      width:34px; height:34px;
      border:none;
      background:#f3f4f6;
      border-radius:12px;
      cursor:pointer;
      font-size:18px;
    }
    .drawerList{ flex:1; overflow:auto; padding-right:4px; }
    .drawerTrip{
      border-radius:14px;
      padding: 10px 10px;
      background:#f3f4f6;
      margin-bottom:8px;
      cursor:pointer;
    }
    .drawerTrip.active{
      background:#dbeafe;
      border:1px solid #3b82f6;
    }
    .drawerTripName{ font-weight:800; font-size:13px; }
    .drawerTripSub{ font-size:11px; color:var(--sub); margin-top:2px; }

    /* Leaflet z-index ä¿®æ­£ */
    .leaflet-control-container{ z-index: 2000; }
    .leaflet-pane{ z-index: 1000; }

    @media (min-width: 768px){
      .app{ margin-top:12px; }
      .modalBackdrop.show{ align-items:center; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- æŠ½å±œ -->
    <div id="drawerBackdrop" class="drawerBackdrop"></div>
    <aside id="drawer" class="drawer" aria-label="æ—…ç¨‹æŠ½å±œ">
      <button id="drawerClose" class="drawerClose" aria-label="é—œé–‰">âœ•</button>
      <div class="drawerTitle">æˆ‘çš„æ—…ç¨‹</div>
      <div id="drawerList" class="drawerList"></div>
      <button id="drawerNewTrip" class="btn btnGhost" style="margin-top:8px;">ï¼‹ å»ºç«‹æ–°æ—…ç¨‹</button>
      <button id="drawerDeleteTrip" class="btn btnDanger" style="margin-top:8px;">åˆªé™¤ç›®å‰æ—…ç¨‹</button>
      <div style="margin-top:8px;font-size:11px;color:var(--sub);">åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œé©åˆåˆªé™¤æ¸¬è©¦ç”¨æ—…ç¨‹</div>
    </aside>

    <!-- Header -->
    <header>
      <div class="leftHead">
        <button id="menuBtn" class="iconBtn" aria-label="åˆ‡æ›æ—…ç¨‹">â˜°</button>
        <div>
          <div class="titleRow">
            <div class="title">Trip Planner</div>
            <div class="tag" id="destTag">æœªè¨­å®šç›®çš„åœ°</div>
            <button id="editTripBtn" class="iconBtn" aria-label="ç·¨è¼¯æ—…ç¨‹">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 20h9" stroke="#1d4ed8" stroke-width="2" stroke-linecap="round"/>
                <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                      stroke="#1d4ed8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="subtitle" id="tripNameText">æœªå‘½åæ—…ç¨‹</div>
        </div>
      </div>

      <div class="topInfo">
        <div id="dateInfoText">è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸</div>
        <div class="ratePill" id="rateInfoText">åŒ¯ç‡å°šæœªè¨­å®š</div>
      </div>
    </header>

    <!-- å›ºå®šçš„æ¯æ—¥è¡Œç¨‹æ¬„ä½ -->
    <div class="stickyWrap">
      <div class="stickyCard">
        <div class="dayTopRow">
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="font-weight:900;">æ¯æ—¥è¡Œç¨‹</div>
          </div>
          <div class="pill"><span>ğŸ“</span><span id="destPillText">æœªè¨­å®šç›®çš„åœ°</span></div>
        </div>

        <div class="dayChips" id="dayChips"></div>

        <!-- è¡Œç¨‹ / åœ°åœ–é ç±¤ï¼ˆåªåœ¨åº•éƒ¨ tab = è¡Œç¨‹ æ™‚é¡¯ç¤ºï¼‰ -->
        <div class="segTabs" id="itinerarySegTabs" style="display:none;">
          <div class="segTab active" data-seg="schedule">è¡Œç¨‹</div>
          <div class="segTab" data-seg="map">åœ°åœ–</div>
        </div>
      </div>
    </div>

    <!-- ä¸»å…§å®¹ -->
    <div id="mainView"></div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <nav class="bottomNav" aria-label="åº•éƒ¨å°è¦½">
    <div class="bottomTabs">
      <div class="bottomTab active" data-tab="itinerary"><span>ğŸ—º</span>è¡Œç¨‹</div>
      <div class="bottomTab" data-tab="expenses"><span>ğŸ’°</span>è¨˜å¸³</div>
      <div class="bottomTab" data-tab="shopping"><span>ğŸ›</span>è³¼ç‰©</div>
      <div class="bottomTab" data-tab="flights"><span>âœˆï¸</span>èˆªç­</div>
    </div>
  </nav>

  <!-- Modalï¼šæ—…ç¨‹è¨­å®š -->
  <div id="tripModalBackdrop" class="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="æ—…ç¨‹è¨­å®š">
      <div class="modalHead">
        <div class="modalHeadTitle">æ—…ç¨‹è¨­å®š</div>
        <button class="modalClose" id="tripModalClose" aria-label="é—œé–‰">âœ•</button>
      </div>
      <div class="modalBody" id="tripModalBody"></div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="tripModalCancel">å–æ¶ˆ</button>
        <button class="btn btnPrimary" id="tripModalSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- Modalï¼šæ–°å¢/ç·¨è¼¯è¡Œç¨‹ -->
  <div id="itModalBackdrop" class="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="è¡Œç¨‹é …ç›®">
      <div class="modalHead">
        <div class="modalHeadTitle" id="itModalTitle">æ–°å¢è¡Œç¨‹</div>
        <button class="modalClose" id="itModalClose" aria-label="é—œé–‰">âœ•</button>
      </div>
      <div class="modalBody" id="itModalBody"></div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="itModalCancel">å–æ¶ˆ</button>
        <button class="btn btnPrimary" id="itModalSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- Modalï¼šæ–°å¢/ç·¨è¼¯èˆªç­ -->
  <div id="flModalBackdrop" class="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="èˆªç­è³‡è¨Š">
      <div class="modalHead">
        <div class="modalHeadTitle" id="flModalTitle">æ–°å¢èˆªç­</div>
        <button class="modalClose" id="flModalClose" aria-label="é—œé–‰">âœ•</button>
      </div>
      <div class="modalBody" id="flModalBody"></div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="flModalCancel">å–æ¶ˆ</button>
        <button class="btn btnPrimary" id="flModalSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    /********************
     * 0) åŸºç¤å·¥å…·
     ********************/
    const STORAGE_KEY = "tripPlanner_full_v1";
    const PREP_DAY_ID = "prep";

    function generateId(prefix){ return prefix + "_" + Math.random().toString(36).slice(2,9); }

    function formatDateMMDD(dateStr){
      if(!dateStr) return "";
      const d = new Date(dateStr);
      if(isNaN(d)) return "";
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${m}/${day}`;
    }

    function parseTimeString(str){
      if(!str) return "";
      const s0 = String(str).trim();
      if(/^\d{2}:\d{2}$/.test(s0)) return s0;
      let s = s0.replace(/[^\d]/g,"");
      if(!s) return "";
      if(s.length <= 2){
        const hh = Math.min(parseInt(s,10),23);
        return String(hh).padStart(2,"0")+":00";
      }
      if(s.length === 3){
        const hh = Math.min(parseInt(s.slice(0,1),10),23);
        const mm = Math.min(parseInt(s.slice(1),10),59);
        return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
      }
      const hh = Math.min(parseInt(s.slice(0,2),10),23);
      const mm = Math.min(parseInt(s.slice(2,4),10),59);
      return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
    }

    function safeText(s){ return (s ?? "").toString().replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }

    /********************
     * 1) åŒ¯ç‡
     ********************/
    async function fetchRateToTWD(baseCurrency){
      const base = (baseCurrency||"").toUpperCase();
      if(!base) throw new Error("å°šæœªè¨­å®šä¸»è¦è²¨å¹£");
      if(base === "TWD") throw new Error("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æ›ç®—");
      const url = "https://open.er-api.com/v6/latest/" + encodeURIComponent(base);
      const res = await fetch(url);
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if(!data || data.result !== "success") throw new Error("API result=" + (data?.result || "unknown"));
      if(!data.rates || typeof data.rates.TWD !== "number") throw new Error("API ç„¡ TWD åŒ¯ç‡");
      return { rate: data.rates.TWD, updatedAt: data.time_last_update_utc || "" };
    }

    /********************
     * 2) åœ°é»æœå°‹ï¼ˆNominatimï¼‰
     ********************/
    async function searchPlaceSuggestions(query, cityHint){
      const q = (cityHint ? `${query} ${cityHint}` : query).trim();
      if(!q) return [];
      const url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&q=" + encodeURIComponent(q);
      try{
        const res = await fetch(url, { headers: { "Accept-Language": "zh-TW,zh;q=0.9,en;q=0.7" } });
        if(!res.ok) return [];
        const data = await res.json();
        if(!Array.isArray(data)) return [];
        return data.map(item=>{
          const full = item.display_name || "";
          const parts = full.split(",");
          const main = (parts[0]||full).trim();
          const sub = parts.slice(1).join(",").trim();
          return {
            name: main,
            fullName: full,
            lat: parseFloat(item.lat),
            lon: parseFloat(item.lon),
            sub
          };
        });
      }catch(e){
        console.error(e);
        return [];
      }
    }

    async function geocodePlace(place, cityHint){
      const q = (cityHint ? `${place} ${cityHint}` : place).trim();
      if(!q) return null;
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept-Language": "zh-TW,zh;q=0.9,en;q=0.7" } });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if(!data || !data.length) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    function bindAutocomplete(inputEl, listEl, trip, onPicked){
      if(!inputEl || !listEl) return;

      let timer = null;
      let suggestions = [];

      function hide(){
        listEl.style.display = "none";
        listEl.innerHTML = "";
      }

      inputEl.addEventListener("input", ()=>{
        const q = inputEl.value.trim();
        if(timer) clearTimeout(timer);
        if(q.length < 2){ hide(); return; }

        timer = setTimeout(async ()=>{
          suggestions = await searchPlaceSuggestions(q, trip.destination);
          if(!suggestions.length){ hide(); return; }
          listEl.innerHTML = suggestions.map((s,idx)=>`
            <div class="acItem" data-idx="${idx}">
              <span class="acMain">${safeText(s.name)}</span>
              ${s.sub ? `<span class="acSub">${safeText(s.sub)}</span>` : ""}
            </div>
          `).join("");
          listEl.style.display = "block";

          listEl.querySelectorAll(".acItem").forEach(el=>{
            el.addEventListener("click", ()=>{
              const idx = parseInt(el.getAttribute("data-idx"),10);
              const s = suggestions[idx];
              if(!s) return;
              inputEl.value = s.name;
              hide();
              onPicked?.(s);
            });
          });
        }, 260);
      });

      document.addEventListener("click", (e)=>{
        if(e.target === inputEl) return;
        if(listEl.contains(e.target)) return;
        hide();
      });
    }

    /********************
     * 3) å¤©æ°£ï¼ˆOpen-Meteoï¼‰
     ********************/
    const WEATHER_CODE_MAP = {
      0:{emoji:"â˜€ï¸", text:"æ™´æœ—"},
      1:{emoji:"ğŸŒ¤", text:"å¤§è‡´æ™´æœ—"},
      2:{emoji:"â›…ï¸", text:"å¤šé›²æ™‚æ™´"},
      3:{emoji:"â˜ï¸", text:"å¤šé›²"},
      45:{emoji:"ğŸŒ«", text:"æœ‰éœ§"},
      48:{emoji:"ğŸŒ«", text:"æœ‰éœ§"},
      51:{emoji:"ğŸŒ¦", text:"æ¯›æ¯›é›¨"},
      53:{emoji:"ğŸŒ¦", text:"æ¯›æ¯›é›¨"},
      55:{emoji:"ğŸŒ§", text:"æ¯›æ¯›é›¨"},
      61:{emoji:"ğŸŒ§", text:"å°é›¨"},
      63:{emoji:"ğŸŒ§", text:"ä¸­é›¨"},
      65:{emoji:"ğŸŒ§", text:"å¤§é›¨"},
      71:{emoji:"â„ï¸", text:"å°é›ª"},
      73:{emoji:"â„ï¸", text:"ä¸­é›ª"},
      75:{emoji:"â„ï¸", text:"å¤§é›ª"},
      80:{emoji:"ğŸŒ§", text:"çŸ­æš«é™£é›¨"},
      81:{emoji:"ğŸŒ§", text:"é™£é›¨"},
      82:{emoji:"ğŸŒ§", text:"å¤§é›·é›¨"},
      95:{emoji:"â›ˆ", text:"é›·é™£é›¨"}
    };

    async function getTripLatLon(trip){
      if(trip.geo && typeof trip.geo.lat === "number" && typeof trip.geo.lon === "number") return trip.geo;
      const dest = (trip.destination||"").trim();
      if(!dest) return null;
      const geo = await geocodePlace(dest);
      if(!geo) return null;
      trip.geo = geo;
      saveRoot();
      return geo;
    }

    async function updateWeatherBox(trip, dayId){
      const box = document.getElementById("dayWeatherBox");
      if(!box) return;

      if(dayId === PREP_DAY_ID){
        box.innerHTML = `<div class="wLoading">è¡Œå‰å¾…è¾¦ä¸æä¾›å¤©æ°£é¡¯ç¤ºã€‚</div>`;
        return;
      }

      const dayInfo = trip.days.find(d=>d.id === dayId);
      if(!dayInfo?.date){
        box.innerHTML = `<div class="wLoading">æ­¤æ—¥å°šæœªè¨­å®šæ—¥æœŸï¼Œç„¡æ³•æŸ¥è©¢å¤©æ°£ã€‚</div>`;
        return;
      }
      if(!trip.destination?.trim()){
        box.innerHTML = `<div class="wLoading">è«‹å…ˆåœ¨æ—…ç¨‹è¨­å®šè¼¸å…¥ç›®çš„åœ°ï¼Œæ‰èƒ½å–å¾—å¤©æ°£è³‡è¨Šã€‚</div>`;
        return;
      }

      box.innerHTML = `<div class="wLoading">è®€å–å¤©æ°£ä¸­â€¦</div>`;
      try{
        const geo = await getTripLatLon(trip);
        if(!geo){
          box.innerHTML = `<div class="wLoading">æ‰¾ä¸åˆ°ç›®çš„åœ°ä½ç½®ï¼Œè«‹ç¢ºèªç›®çš„åœ°åç¨±æ˜¯å¦æ­£ç¢ºã€‚</div>`;
          return;
        }

        const url =
          "https://api.open-meteo.com/v1/forecast" +
          `?latitude=${geo.lat}&longitude=${geo.lon}` +
          "&daily=temperature_2m_max,temperature_2m_min,weathercode" +
          "&timezone=auto" +
          `&start_date=${dayInfo.date}&end_date=${dayInfo.date}`;

        const res = await fetch(url);
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if(!data.daily?.time?.length){
          box.innerHTML = `<div class="wLoading">æŸ¥ä¸åˆ°é€™ä¸€å¤©çš„å¤©æ°£ï¼ˆå¯èƒ½è¶…å‡ºå¯é å ±ç¯„åœï¼‰ã€‚</div>`;
          return;
        }

        const maxT = data.daily.temperature_2m_max[0];
        const minT = data.daily.temperature_2m_min[0];
        const code = data.daily.weathercode?.[0];
        const info = WEATHER_CODE_MAP[code] || {emoji:"ğŸŒ¡", text:"å¤©æ°£è³‡è¨Š"};

        box.innerHTML = `
          <div class="weatherLeft">
            <div class="wEmoji">${info.emoji}</div>
            <div>
              <div class="wTemp">${Math.round(minT)}Â° / ${Math.round(maxT)}Â°</div>
              <div class="wSub">${safeText(trip.destination)} Â· ${safeText(info.text)}</div>
            </div>
          </div>
          <div class="wSub">è³‡æ–™ä¾†æºï¼šOpen-Meteo</div>
        `;
      }catch(e){
        console.error(e);
        box.innerHTML = `<div class="wLoading">å–å¾—å¤©æ°£å¤±æ•—ï¼Œå¯ä»¥ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚</div>`;
      }
    }

    /********************
     * 4) èˆªç­ï¼šAviationstack
     ********************/
    const IATA_TO_CITY_ZH = {
      TPE:"å°åŒ—", TSA:"å°åŒ—", KHH:"é«˜é›„",
      NRT:"æ±äº¬", HND:"æ±äº¬", KIX:"å¤§é˜ª", FUK:"ç¦å²¡",
      CDG:"å·´é»", ORY:"å·´é»",
      AMS:"é˜¿å§†æ–¯ç‰¹ä¸¹", BRU:"å¸ƒé­¯å¡çˆ¾",
      ICN:"é¦–çˆ¾", GMP:"é¦–çˆ¾",
      HKG:"é¦™æ¸¯",
      LHR:"å€«æ•¦", LGW:"å€«æ•¦"
    };

    const AVIATIONSTACK_KEY = "f9e92bf4a1ac9571bb2f08a7050e0503";

    async function fetchFlightInfoByNumber(flightNo, flightDate){
      if(!AVIATIONSTACK_KEY || AVIATIONSTACK_KEY === "YOUR_ACCESS_KEY_HERE"){
        throw new Error("å°šæœªè¨­å®š Aviationstack API Key");
      }
      const cleanNo = flightNo.trim().toUpperCase().replace(/\s+/g,"");
      if(!cleanNo) throw new Error("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿ");

      const url =
        "https://api.aviationstack.com/v1/flights" +
        "?access_key=" + encodeURIComponent(AVIATIONSTACK_KEY) +
        "&flight_iata=" + encodeURIComponent(cleanNo) +
        "&limit=10";

      const res = await fetch(url);
      if(!res.ok) throw new Error("æŸ¥è©¢å¤±æ•—ï¼ŒHTTP " + res.status);
      const data = await res.json();
      const list = data?.data;
      if(!Array.isArray(list) || list.length === 0){
        throw new Error("æŸ¥ç„¡æ­¤èˆªç­ï¼ˆå¯èƒ½æ˜¯æ—¥æœŸä¸ç¬¦æˆ–å…è²»æ–¹æ¡ˆè³‡æ–™æœ‰é™ï¼‰");
      }

      let picked = list[0];
      if(flightDate){
        const same = list.find(f => (f?.departure?.scheduled || "").substring(0,10) === flightDate);
        if(same) picked = same;
      }

      const dep = picked.departure || {};
      const arr = picked.arrival || {};

      let depDate = "";
      let depTime = "";
      if(dep.scheduled){
        depDate = dep.scheduled.substring(0,10);
        depTime = dep.scheduled.substring(11,16);
      }

      return {
        from: dep.iata || dep.airport || "",
        to: arr.iata || arr.airport || "",
        date: depDate,
        time: depTime,
        status: picked.flight_status || ""
      };
    }

    /********************
     * 5) è³‡æ–™çµæ§‹
     ********************/
    function createEmptyTrip(name){
      return {
        id: "trip_" + Math.random().toString(36).slice(2,9),
        name: name || "æ–°æ—…ç¨‹",
        destination: "",
        currency: "JPY",
        startDate: "",
        daysCount: 4,
        days: [],
        activeDayId: null,

        itinerary: {},

        flights: [],
        expenses: [],
        shopping: [],

        // è¡Œå‰å¾…è¾¦ï¼ˆä½ è¦åŠ å›ä¾†çš„ï¼‰
        prepTodos: [], // [{id,text,done}]

        exchangeRate: { base:"JPY", target:"TWD", rate:null, updatedAt:"" },

        geo: null,
        placeCache: {}
      };
    }

    function ensureTripShape(trip){
      if(!trip.itinerary) trip.itinerary = {};
      if(!trip.flights) trip.flights = [];
      if(!trip.expenses) trip.expenses = [];
      if(!trip.shopping) trip.shopping = [];
      if(!trip.prepTodos) trip.prepTodos = [];
      if(!trip.exchangeRate) trip.exchangeRate = { base: (trip.currency||"JPY"), target:"TWD", rate:null, updatedAt:"" };
      if(!trip.placeCache) trip.placeCache = {};
      if(!trip.days) trip.days = [];
    }

    function regenerateDays(trip){
      const start = trip.startDate ? new Date(trip.startDate) : null;
      const days = [];
      for(let i=0;i<trip.daysCount;i++){
        let dStr = "";
        if(start){
          const d = new Date(start);
          d.setDate(d.getDate()+i);
          dStr = d.toISOString().substring(0,10);
        }
        const id = "day"+(i+1);
        days.push({id, label:"Day "+(i+1), date:dStr});
        if(!trip.itinerary[id]) trip.itinerary[id] = [];
      }
      trip.days = days;

      // activeDayId å…è¨±æ˜¯ prepï¼›è‹¥æ˜¯å…¶ä»–ç„¡æ•ˆï¼Œå›åˆ° prep æˆ– day1
      if(!trip.activeDayId){
        trip.activeDayId = PREP_DAY_ID;
      }
      const valid = (trip.activeDayId === PREP_DAY_ID) || days.some(d=>d.id===trip.activeDayId);
      if(!valid){
        trip.activeDayId = PREP_DAY_ID;
      }
    }

    function loadRoot(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){
          const t = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(t);
          return { trips:[t], activeTripId:t.id };
        }
        const obj = JSON.parse(raw);
        if(!obj?.trips?.length){
          const t = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(t);
          return { trips:[t], activeTripId:t.id };
        }
        obj.trips.forEach(ensureTripShape);
        // ç¢ºä¿æ¯å€‹ trip éƒ½æœ‰ days
        obj.trips.forEach(t=>{
          if(!t.days?.length) regenerateDays(t);
          if(!t.activeDayId) t.activeDayId = PREP_DAY_ID;
        });
        return obj;
      }catch(e){
        console.error(e);
        const t = createEmptyTrip("æ–°æ—…ç¨‹ 1");
        regenerateDays(t);
        return { trips:[t], activeTripId:t.id };
      }
    }

    let root = loadRoot();

    function saveRoot(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(root));
      renderHeader();
      renderDayChips();
      renderDrawerTrips();
    }

    function getCurrentTrip(){
      let t = root.trips.find(x => x.id === root.activeTripId);
      if(!t){
        t = root.trips[0];
        root.activeTripId = t.id;
      }
      ensureTripShape(t);
      if(!t.days?.length) regenerateDays(t);
      if(!t.activeDayId) t.activeDayId = PREP_DAY_ID;
      return t;
    }

    /********************
     * 6) DOM åƒç…§
     ********************/
    const mainView = document.getElementById("mainView");

    const destTag = document.getElementById("destTag");
    const destPillText = document.getElementById("destPillText");
    const tripNameText = document.getElementById("tripNameText");
    const dateInfoText = document.getElementById("dateInfoText");
    const rateInfoText = document.getElementById("rateInfoText");

    const dayChipsEl = document.getElementById("dayChips");
    const itinerarySegTabs = document.getElementById("itinerarySegTabs");

    // Drawer
    const menuBtn = document.getElementById("menuBtn");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const drawer = document.getElementById("drawer");
    const drawerClose = document.getElementById("drawerClose");
    const drawerList = document.getElementById("drawerList");
    const drawerNewTrip = document.getElementById("drawerNewTrip");
    const drawerDeleteTrip = document.getElementById("drawerDeleteTrip");

    // Trip Modal
    const editTripBtn = document.getElementById("editTripBtn");
    const tripModalBackdrop = document.getElementById("tripModalBackdrop");
    const tripModalBody = document.getElementById("tripModalBody");
    const tripModalClose = document.getElementById("tripModalClose");
    const tripModalCancel = document.getElementById("tripModalCancel");
    const tripModalSave = document.getElementById("tripModalSave");

    // Itinerary Modal
    const itModalBackdrop = document.getElementById("itModalBackdrop");
    const itModalTitle = document.getElementById("itModalTitle");
    const itModalBody = document.getElementById("itModalBody");
    const itModalClose = document.getElementById("itModalClose");
    const itModalCancel = document.getElementById("itModalCancel");
    const itModalSave = document.getElementById("itModalSave");

    // Flight Modal
    const flModalBackdrop = document.getElementById("flModalBackdrop");
    const flModalTitle = document.getElementById("flModalTitle");
    const flModalBody = document.getElementById("flModalBody");
    const flModalClose = document.getElementById("flModalClose");
    const flModalCancel = document.getElementById("flModalCancel");
    const flModalSave = document.getElementById("flModalSave");

    /********************
     * 7) Header / Drawer
     ********************/
    function renderHeader(){
      const trip = getCurrentTrip();
      tripNameText.textContent = trip.name || "æœªå‘½åæ—…ç¨‹";
      destTag.textContent = trip.destination || "æœªè¨­å®šç›®çš„åœ°";
      destPillText.textContent = trip.destination || "æœªè¨­å®šç›®çš„åœ°";

      if(trip.startDate && trip.daysCount){
        const start = new Date(trip.startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + trip.daysCount - 1);
        dateInfoText.textContent = `${trip.daysCount} å¤©è¡Œç¨‹ï½œ${formatDateMMDD(trip.startDate)} - ${formatDateMMDD(end.toISOString().substring(0,10))}`;
      }else{
        dateInfoText.textContent = "è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸";
      }

      const ex = trip.exchangeRate;
      const cur = (trip.currency||"").toUpperCase();
      if(cur === "TWD"){
        rateInfoText.textContent = "åŒ¯ç‡ï¼šä¸»è¦è²¨å¹£ç‚º TWD";
      }else if(ex && typeof ex.rate === "number" && ex.rate > 0 && ex.base === cur && ex.target === "TWD"){
        rateInfoText.textContent = `åŒ¯ç‡ï¼š1 ${ex.base} â‰ˆ ${ex.rate.toFixed(2)} TWD`;
      }else{
        rateInfoText.textContent = "åŒ¯ç‡å°šæœªè¨­å®š";
      }
    }

    function openDrawer(){
      drawer.classList.add("open");
      drawerBackdrop.classList.add("show");
      renderDrawerTrips();
    }
    function closeDrawer(){
      drawer.classList.remove("open");
      drawerBackdrop.classList.remove("show");
    }

    function renderDrawerTrips(){
      const currentId = root.activeTripId;
      drawerList.innerHTML = "";
      root.trips.forEach(t=>{
        const div = document.createElement("div");
        div.className = "drawerTrip" + (t.id === currentId ? " active" : "");
        const startTxt = t.startDate ? formatDateMMDD(t.startDate) : "æ—¥æœŸæœªè¨­å®š";
        div.innerHTML = `
          <div class="drawerTripName">${safeText(t.name || "æœªå‘½åæ—…ç¨‹")}</div>
          <div class="drawerTripSub">${(t.daysCount||0)} å¤© Â· ${safeText(startTxt)}</div>
        `;
        div.addEventListener("click", ()=>{
          root.activeTripId = t.id;
          saveRoot();
          renderCurrentMainView();
          closeDrawer();
        });
        drawerList.appendChild(div);
      });
    }

    menuBtn.addEventListener("click", openDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);
    drawerClose.addEventListener("click", closeDrawer);

    drawerNewTrip.addEventListener("click", ()=>{
      const t = createEmptyTrip("æ–°æ—…ç¨‹ " + (root.trips.length + 1));
      regenerateDays(t);
      root.trips.push(t);
      root.activeTripId = t.id;
      saveRoot();
      renderCurrentMainView();
      closeDrawer();
    });

    drawerDeleteTrip.addEventListener("click", ()=>{
      if(root.trips.length <= 1){
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹ï¼Œç„¡æ³•å…¨éƒ¨åˆªå…‰ã€‚");
        return;
      }
      const trip = getCurrentTrip();
      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${trip.name}ã€é€™å€‹æ—…ç¨‹å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) return;
      root.trips = root.trips.filter(x => x.id !== trip.id);
      root.activeTripId = root.trips[0].id;
      saveRoot();
      renderCurrentMainView();
      closeDrawer();
    });

    /********************
     * 8) æ—…ç¨‹è¨­å®š Modal
     ********************/
    function openTripModal(){
      const trip = getCurrentTrip();
      const cur = trip.currency || "JPY";
      tripModalBody.innerHTML = `
        <div class="smallLabel">æ—…ç¨‹åç¨±</div>
        <input id="mTripName" value="${safeText(trip.name||"")}" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥è‡ªç”±è¡Œ" />

        <div class="row" style="margin-top:10px;">
          <div class="col">
            <div class="smallLabel">ç›®çš„åœ°åŸå¸‚ / å€åŸŸ</div>
            <input id="mDest" value="${safeText(trip.destination||"")}" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯ã€å·´é»â€¦" />
          </div>
          <div class="col">
            <div class="smallLabel">ä¸»è¦è²¨å¹£</div>
            <select id="mCur">
              <option value="KRW" ${cur==="KRW"?"selected":""}>KRW éŸ“å…ƒ</option>
              <option value="JPY" ${cur==="JPY"?"selected":""}>JPY æ—¥åœ“</option>
              <option value="TWD" ${cur==="TWD"?"selected":""}>TWD æ–°å°å¹£</option>
              <option value="HKD" ${cur==="HKD"?"selected":""}>HKD æ¸¯å¹£</option>
              <option value="USD" ${cur==="USD"?"selected":""}>USD ç¾å…ƒ</option>
              <option value="EUR" ${cur==="EUR"?"selected":""}>EUR æ­å…ƒ</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:2px;">
          <div class="col">
            <div class="smallLabel">å‡ºç™¼æ—¥æœŸ</div>
            <input type="date" id="mStart" value="${safeText(trip.startDate||"")}" />
          </div>
          <div class="col">
            <div class="smallLabel">å¤©æ•¸</div>
            <input type="number" id="mDays" min="1" max="30" value="${trip.daysCount||4}" />
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:10px;">
          <button class="btn btnDanger" id="mClearTrip" style="flex:1;">æ¸…ç©ºæœ¬æ—…ç¨‹è³‡æ–™</button>
          <button class="btn btnGhost" id="mFetchRate" style="flex:1;">æŸ¥è©¢åŒ¯ç‡</button>
        </div>

        <div style="margin-top:8px;font-size:11px;color:var(--sub);" id="mRateHint"></div>
      `;

      const hint = tripModalBody.querySelector("#mRateHint");
      const ex = trip.exchangeRate;
      if((trip.currency||"").toUpperCase() === "TWD"){
        hint.textContent = "ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æ›ç®—ã€‚";
      }else if(ex && typeof ex.rate === "number" && ex.rate > 0){
        hint.textContent = `ç›®å‰åŒ¯ç‡ï¼š1 ${ex.base} â‰ˆ ${ex.rate.toFixed(2)} TWD`;
      }else{
        hint.textContent = "ç›®å‰å°šæœªè¨­å®šåŒ¯ç‡ã€‚";
      }

      tripModalBody.querySelector("#mClearTrip").addEventListener("click", ()=>{
        if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ—…ç¨‹çš„è¡Œç¨‹ã€èˆªç­ã€è¨˜å¸³ã€è³¼ç‰©èˆ‡è¡Œå‰å¾…è¾¦è³‡æ–™å—ï¼Ÿ")) return;
        trip.itinerary = {};
        trip.flights = [];
        trip.expenses = [];
        trip.shopping = [];
        trip.prepTodos = [];
        trip.placeCache = {};
        trip.geo = null;
        regenerateDays(trip);
        saveRoot();
        renderCurrentMainView();
        closeTripModal();
      });

      tripModalBody.querySelector("#mFetchRate").addEventListener("click", async ()=>{
        const curSel = tripModalBody.querySelector("#mCur").value.toUpperCase();
        if(curSel === "TWD"){
          alert("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æŸ¥è©¢åŒ¯ç‡ã€‚");
          return;
        }
        try{
          const r = await fetchRateToTWD(curSel);
          trip.exchangeRate = { base: curSel, target:"TWD", rate:r.rate, updatedAt:r.updatedAt };
          hint.textContent = `ç›®å‰åŒ¯ç‡ï¼š1 ${curSel} â‰ˆ ${r.rate.toFixed(2)} TWD`;
          saveRoot();
        }catch(e){
          console.error(e);
          alert("åŒ¯ç‡æŸ¥è©¢å¤±æ•—ï¼š" + e.message);
        }
      });

      tripModalBackdrop.classList.add("show");
      tripModalBackdrop.setAttribute("aria-hidden","false");
    }

    function closeTripModal(){
      tripModalBackdrop.classList.remove("show");
      tripModalBackdrop.setAttribute("aria-hidden","true");
    }

    editTripBtn.addEventListener("click", openTripModal);
    tripModalClose.addEventListener("click", closeTripModal);
    tripModalCancel.addEventListener("click", closeTripModal);
    tripModalBackdrop.addEventListener("click", (e)=>{
      if(e.target === tripModalBackdrop) closeTripModal();
    });

    tripModalSave.addEventListener("click", async ()=>{
      const trip = getCurrentTrip();

      const name = document.getElementById("mTripName").value.trim() || "æœªå‘½åæ—…ç¨‹";
      const dest = document.getElementById("mDest").value.trim();
      const newCur = document.getElementById("mCur").value;
      const start = document.getElementById("mStart").value;
      let days = parseInt(document.getElementById("mDays").value,10);
      if(isNaN(days)) days = 1;
      days = Math.max(1, Math.min(30, days));

      const oldCur = trip.currency || "JPY";
      const oldDest = trip.destination || "";

      trip.name = name;
      trip.destination = dest;
      trip.currency = newCur;
      trip.startDate = start;
      trip.daysCount = days;
      regenerateDays(trip);

      if(oldDest !== dest){
        trip.geo = null;
        trip.placeCache = {};
      }

      if(oldCur !== newCur){
        trip.exchangeRate = { base:newCur, target:"TWD", rate:null, updatedAt:"" };
        if(newCur !== "TWD"){
          try{
            const r = await fetchRateToTWD(newCur);
            trip.exchangeRate = { base:newCur, target:"TWD", rate:r.rate, updatedAt:r.updatedAt };
          }catch(e){
            console.error(e);
            alert("å·²å„²å­˜æ—…ç¨‹è¨­å®šï¼Œä½†è‡ªå‹•æŠ“åŒ¯ç‡å¤±æ•—ï¼š" + e.message);
          }
        }
      }else{
        if(trip.exchangeRate) trip.exchangeRate.base = newCur;
      }

      saveRoot();
      renderCurrentMainView();
      closeTripModal();
    });

    /********************
     * 9) Day Chipsï¼ˆå«ã€Œè¡Œå‰ã€ï¼‰
     ********************/
    function renderDayChips(){
      const trip = getCurrentTrip();

      if(!trip.days?.length){
        dayChipsEl.innerHTML = `<div class="empty" style="padding:4px 0;">è«‹å…ˆè¨­å®šæ—…ç¨‹æ—¥æœŸèˆ‡å¤©æ•¸</div>`;
        return;
      }

      // activeDayId åˆæ³•ï¼šprep æˆ– day*
      const valid = (trip.activeDayId === PREP_DAY_ID) || trip.days.some(d=>d.id===trip.activeDayId);
      if(!valid){
        trip.activeDayId = PREP_DAY_ID;
        saveRoot();
      }

      const prepActive = trip.activeDayId === PREP_DAY_ID;

      dayChipsEl.innerHTML =
        `
          <div class="chip prepChip ${prepActive?"active":""}" data-day="${PREP_DAY_ID}">
            <strong>è¡Œå‰</strong>
            <span>å¾…è¾¦æ¸…å–®</span>
          </div>
        ` +
        trip.days.map(d=>{
          const active = d.id === trip.activeDayId;
          return `
            <div class="chip ${active?"active":""}" data-day="${d.id}">
              <strong>${safeText(d.label)}</strong>
              <span>${safeText(formatDateMMDD(d.date))}</span>
            </div>
          `;
        }).join("");

      dayChipsEl.querySelectorAll(".chip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          trip.activeDayId = ch.getAttribute("data-day");
          saveRoot();
          renderCurrentMainView(true);
        });
      });
    }

    /********************
     * 10) è¡Œç¨‹/åœ°åœ–ï¼šLeaflet
     ********************/
    let itinerarySubTab = "schedule";
    let leafletMap = null;
    let markerLayer = null;

    function resetLeafletIfNeeded(container){
      if(!container) return;
      if(leafletMap && leafletMap._container !== container){
        leafletMap.remove();
        leafletMap = null;
        markerLayer = null;
      }
    }

    function ensureLeaflet(container){
      resetLeafletIfNeeded(container);
      if(leafletMap) return leafletMap;

      leafletMap = L.map(container, { zoomControl:false });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap"
      }).addTo(leafletMap);

      markerLayer = L.layerGroup().addTo(leafletMap);
      return leafletMap;
    }

    async function buildMarkersForDay(trip, dayId){
      const items = (trip.itinerary[dayId] || []).filter(i => (i.title||"").trim());
      const pts = [];

      for(const item of items){
        let geo = null;

        if(typeof item.lat === "number" && typeof item.lon === "number"){
          geo = { lat:item.lat, lon:item.lon };
        }else{
          const key = (item.title||"").trim();
          if(trip.placeCache[key]){
            geo = trip.placeCache[key];
          }else{
            try{
              geo = await geocodePlace(key, trip.destination);
            }catch(e){
              console.warn("geocode å¤±æ•—ï¼š", key, e);
            }
            if(geo){
              trip.placeCache[key] = geo;
              saveRoot();
            }
          }
          if(geo){
            item.lat = geo.lat;
            item.lon = geo.lon;
          }
        }

        if(geo){
          pts.push({ lat:geo.lat, lon:geo.lon, title: item.title, time:item.time || "" });
        }
      }

      return pts;
    }

    async function renderMapForDay(trip, dayId){
      const mapEl = document.getElementById("dayMap");
      if(!mapEl) return;

      const map = ensureLeaflet(mapEl);
      setTimeout(()=>map.invalidateSize(), 60);
      markerLayer.clearLayers();

      const pts = await buildMarkersForDay(trip, dayId);

      const bounds = [];
      pts.forEach(p=>{
        const m = L.marker([p.lat, p.lon]).bindPopup(`${safeText(p.time ? (p.time+" Â· ") : "")}${safeText(p.title)}`);
        markerLayer.addLayer(m);
        bounds.push([p.lat, p.lon]);
      });

      if(!bounds.length){
        const geo = await getTripLatLon(trip);
        if(geo){
          const m = L.marker([geo.lat, geo.lon]).bindPopup(safeText(trip.destination || "ç›®çš„åœ°"));
          markerLayer.addLayer(m);
          map.setView([geo.lat, geo.lon], 11);
          return;
        }
        map.setView([23.5, 121], 6);
        return;
      }

      map.fitBounds(bounds, { padding:[30,30] });
    }

    /********************
     * 11) è¡Œç¨‹ Modal
     ********************/
    let editingItId = null;

    function openItineraryModal(trip, dayId, item){
      editingItId = item?.id || null;
      itModalTitle.textContent = editingItId ? "ç·¨è¼¯è¡Œç¨‹" : "æ–°å¢è¡Œç¨‹";

      const timeVal = item?.time || "";
      const titleVal = item?.title || "";
      const noteVal = item?.note || "";

      itModalBody.innerHTML = `
        <div class="row">
          <div class="col">
            <div class="smallLabel">æ™‚é–“</div>
            <input type="time" id="mItTime" value="${safeText(timeVal)}" />
          </div>
          <div class="col autocompleteWrap">
            <div class="smallLabel">è¡Œç¨‹åç¨±ï¼ˆåƒ Google Maps ä¸€æ¨£æœå°‹åœ°é»ï¼‰</div>
            <input id="mItTitle" value="${safeText(titleVal)}" placeholder="ä¾‹å¦‚ï¼šæ™¯é»/é¤å»³/åœ°æ¨™â€¦" autocomplete="off" />
            <div id="mItSuggest" class="autocompleteList"></div>
          </div>
        </div>

        <div class="smallLabel">å‚™è¨»</div>
        <textarea id="mItNote" placeholder="äº¤é€šæ–¹å¼ã€é–€ç¥¨ç­‰ï¼Œå¯ç•™ç™½">${safeText(noteVal)}</textarea>

        <div style="margin-top:8px;font-size:11px;color:var(--sub);">
          é¸æ“‡å»ºè­°å¾Œæœƒè‡ªå‹•ä¿å­˜åº§æ¨™ï¼Œåœ°åœ–é ç±¤æœƒè‡ªå‹•é‡˜é¸ã€‚
        </div>
      `;

      const titleEl = document.getElementById("mItTitle");
      const listEl = document.getElementById("mItSuggest");

      if(item && typeof item.lat === "number" && typeof item.lon === "number"){
        titleEl.dataset.lat = String(item.lat);
        titleEl.dataset.lon = String(item.lon);
      }else{
        delete titleEl.dataset.lat;
        delete titleEl.dataset.lon;
      }

      bindAutocomplete(titleEl, listEl, trip, (s)=>{
        titleEl.dataset.lat = String(s.lat);
        titleEl.dataset.lon = String(s.lon);
        if(!trip.placeCache) trip.placeCache = {};
        trip.placeCache[s.name] = { lat:s.lat, lon:s.lon };
        saveRoot();
      });

      itModalBackdrop.classList.add("show");
      itModalBackdrop.setAttribute("aria-hidden","false");
    }

    function closeItineraryModal(){
      itModalBackdrop.classList.remove("show");
      itModalBackdrop.setAttribute("aria-hidden","true");
      editingItId = null;
    }

    itModalClose.addEventListener("click", closeItineraryModal);
    itModalCancel.addEventListener("click", closeItineraryModal);
    itModalBackdrop.addEventListener("click", (e)=>{
      if(e.target === itModalBackdrop) closeItineraryModal();
    });

    itModalSave.addEventListener("click", ()=>{
      const trip = getCurrentTrip();
      const dayId = trip.activeDayId;
      if(!dayId || dayId === PREP_DAY_ID) return;

      const time = parseTimeString(document.getElementById("mItTime").value);
      const title = (document.getElementById("mItTitle").value || "").trim() || "æœªå‘½åè¡Œç¨‹";
      const note = (document.getElementById("mItNote").value || "").trim();

      let lat = null, lon = null;
      const titleEl = document.getElementById("mItTitle");
      if(titleEl.dataset.lat && titleEl.dataset.lon){
        const la = parseFloat(titleEl.dataset.lat);
        const lo = parseFloat(titleEl.dataset.lon);
        if(!isNaN(la) && !isNaN(lo)){ lat = la; lon = lo; }
      }

      if(!trip.itinerary[dayId]) trip.itinerary[dayId] = [];

      if(editingItId){
        const target = trip.itinerary[dayId].find(x=>x.id === editingItId);
        if(target){
          target.time = time;
          target.title = title;
          target.note = note;
          if(lat != null && lon != null){ target.lat = lat; target.lon = lon; }
        }
      }else{
        const newItem = { id: generateId("it"), time, title, note };
        if(lat != null && lon != null){ newItem.lat = lat; newItem.lon = lon; }
        trip.itinerary[dayId].push(newItem);
      }

      if(lat != null && lon != null){
        if(!trip.placeCache) trip.placeCache = {};
        trip.placeCache[title] = { lat, lon };
      }

      saveRoot();
      closeItineraryModal();
      renderCurrentMainView(true);
    });

    /********************
     * 12) èˆªç­ Modal
     ********************/
    let editingFlightId = null;

    function openFlightModal(trip, flight){
      editingFlightId = flight?.id || null;
      flModalTitle.textContent = editingFlightId ? "ç·¨è¼¯èˆªç­" : "æ–°å¢èˆªç­";

      flModalBody.innerHTML = `
        <div class="row">
          <div class="col">
            <div class="smallLabel">æ—¥æœŸï¼ˆå¯ç•™ç™½ï¼‰</div>
            <input type="date" id="mFlDate" value="${safeText(flight?.date || "")}" />
          </div>
          <div class="col">
            <div class="smallLabel">ç­æ©Ÿè™Ÿ</div>
            <input id="mFlNo" value="${safeText(flight?.flightNo || "")}" placeholder="ä¾‹å¦‚ï¼šBR87" />
          </div>
        </div>

        <div style="margin:0 0 10px; text-align:right;">
          <button class="btn btnGhost" id="mFlFillBtn">ç”±èˆªç­è³‡æ–™åº«å¸¶å…¥</button>
        </div>

        <div class="row">
          <div class="col">
            <div class="smallLabel">å‡ºç™¼åœ°ï¼ˆIATAï¼‰</div>
            <input id="mFlFrom" value="${safeText(flight?.from || "")}" placeholder="ä¾‹å¦‚ï¼šTPE" />
          </div>
          <div class="col">
            <div class="smallLabel">æŠµé”åœ°ï¼ˆIATAï¼‰</div>
            <input id="mFlTo" value="${safeText(flight?.to || "")}" placeholder="ä¾‹å¦‚ï¼šHKG" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="smallLabel">èµ·é£›æ™‚é–“</div>
            <input type="time" id="mFlTime" value="${safeText(flight?.time || "")}" />
          </div>
          <div class="col">
            <div class="smallLabel">å‚™è¨»</div>
            <input id="mFlNote" value="${safeText(flight?.note || "")}" placeholder="å»ç¨‹ï¼å›ç¨‹â€¦" />
          </div>
        </div>

        <div style="margin-top:6px;font-size:11px;color:var(--sub);">
          å°æé†’ï¼šå…è²»æ–¹æ¡ˆå¯èƒ½æœƒå› æ—¥æœŸæˆ–é¡åº¦é™åˆ¶è€ŒæŸ¥ä¸åˆ°ã€‚
        </div>
      `;

      const fillBtn = document.getElementById("mFlFillBtn");
      fillBtn.addEventListener("click", async ()=>{
        const dateInput = document.getElementById("mFlDate");
        const noInput = document.getElementById("mFlNo");
        const fromInput = document.getElementById("mFlFrom");
        const toInput = document.getElementById("mFlTo");
        const timeInput = document.getElementById("mFlTime");
        const noteInput = document.getElementById("mFlNote");

        const flightNo = (noInput.value||"").trim();
        if(!flightNo){
          alert("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿï¼Œä¾‹å¦‚ BR87");
          return;
        }

        fillBtn.disabled = true;
        const original = fillBtn.textContent;
        fillBtn.textContent = "æŸ¥è©¢ä¸­â€¦";

        try{
          const info = await fetchFlightInfoByNumber(flightNo, dateInput.value);
          if(info.from) fromInput.value = info.from;
          if(info.to) toInput.value = info.to;
          if(info.time) timeInput.value = info.time;
          if(info.date && !dateInput.value) dateInput.value = info.date;

          if(info.status){
            if(!noteInput.value) noteInput.value = "ç‹€æ…‹ï¼š" + info.status;
            else if(!noteInput.value.includes("ç‹€æ…‹ï¼š")) noteInput.value += "ï¼ˆç‹€æ…‹ï¼š" + info.status + "ï¼‰";
          }
        }catch(e){
          console.error(e);
          alert("æŸ¥è©¢å¤±æ•—ï¼šã€Œ" + e.message + "ã€\n\nå¯èƒ½åŸå› ï¼šç­æ©Ÿè™ŸéŒ¯èª¤ã€æ—¥æœŸä¸ç¬¦ã€æˆ–è¶…éå…è²»é¡åº¦ã€‚");
        }finally{
          fillBtn.disabled = false;
          fillBtn.textContent = original;
        }
      });

      flModalBackdrop.classList.add("show");
      flModalBackdrop.setAttribute("aria-hidden","false");
    }

    function closeFlightModal(){
      flModalBackdrop.classList.remove("show");
      flModalBackdrop.setAttribute("aria-hidden","true");
      editingFlightId = null;
    }

    flModalClose.addEventListener("click", closeFlightModal);
    flModalCancel.addEventListener("click", closeFlightModal);
    flModalBackdrop.addEventListener("click",(e)=>{
      if(e.target === flModalBackdrop) closeFlightModal();
    });

    flModalSave.addEventListener("click", ()=>{
      const trip = getCurrentTrip();

      const date = document.getElementById("mFlDate").value;
      const flightNo = (document.getElementById("mFlNo").value||"").trim();
      const from = (document.getElementById("mFlFrom").value||"").trim();
      const to = (document.getElementById("mFlTo").value||"").trim();
      const time = parseTimeString(document.getElementById("mFlTime").value);
      const note = (document.getElementById("mFlNote").value||"").trim();

      if(!flightNo && !from && !to && !time && !note && !date){
        closeFlightModal();
        return;
      }

      if(editingFlightId){
        const target = trip.flights.find(f=>f.id===editingFlightId);
        if(target){
          target.date = date;
          target.flightNo = flightNo;
          target.from = from;
          target.to = to;
          target.time = time;
          target.note = note;
        }
      }else{
        trip.flights.push({ id: generateId("fl"), date, flightNo, from, to, time, note });
      }

      saveRoot();
      closeFlightModal();
      renderCurrentMainView(true);
    });

    /********************
     * 13) åº•éƒ¨ Tab
     ********************/
    let currentTab = "itinerary"; // itinerary | expenses | shopping | flights

    const bottomTabs = document.querySelectorAll(".bottomTab");
    bottomTabs.forEach(el=>{
      el.addEventListener("click", ()=>{
        const t = el.getAttribute("data-tab");
        if(t === currentTab) return;
        currentTab = t;
        bottomTabs.forEach(x=>x.classList.toggle("active", x===el));

        itinerarySegTabs.style.display = (currentTab === "itinerary") ? "flex" : "none";
        renderCurrentMainView(true);
      });
    });

    itinerarySegTabs.querySelectorAll(".segTab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        const seg = tab.getAttribute("data-seg");
        if(seg === itinerarySubTab) return;
        itinerarySubTab = seg;
        itinerarySegTabs.querySelectorAll(".segTab").forEach(x=>x.classList.toggle("active", x===tab));
        renderCurrentMainView(true);
      });
    });

    /********************
     * 14) Viewï¼šè¡Œå‰å¾…è¾¦
     ********************/
    function renderPrepView(trip){
      const todos = (trip.prepTodos || []).slice();

      mainView.innerHTML = `
        <section class="card">
          <div class="cardHeader" style="margin-bottom:6px;">
            <div class="cardTitle">è¡Œå‰æº–å‚™æ¸…å–®</div>
          </div>

          <div class="smallLabel">æ–°å¢ä¸€é …è¡Œå‰æº–å‚™</div>
          <div class="prepAddRow">
            <input id="prepInput" placeholder="ä¾‹å¦‚ï¼šè¾¦æ—…éŠä¿éšªã€æ›å¤–å¹£ã€è²·ç¶²å¡â€¦" />
            <button class="prepAddBtn" id="prepAddBtn" aria-label="æ–°å¢">ï¼‹</button>
          </div>

          <div class="smallLabel" style="margin-top:12px;">è¡Œå‰æº–å‚™æ¸…å–®</div>
          <div id="prepList"></div>
        </section>
      `;

      const listEl = document.getElementById("prepList");
      function rerenderList(){
        const tds = (trip.prepTodos || []);
        if(!tds.length){
          listEl.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è¡Œå‰å¾…è¾¦ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹æ–°å¢ã€‚</div>`;
          return;
        }
        listEl.innerHTML = tds.map(t=>`
          <div class="todoItem">
            <div class="todoCheck ${t.done?"done":""}" data-todo-toggle="${t.id}">${t.done?"âœ“":""}</div>
            <div class="todoText ${t.done?"done":""}">${safeText(t.text || "")}</div>
            <button class="todoDel" data-todo-del="${t.id}" aria-label="åˆªé™¤">âœ•</button>
          </div>
        `).join("");

        listEl.querySelectorAll("[data-todo-toggle]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-todo-toggle");
            const target = trip.prepTodos.find(x=>x.id===id);
            if(!target) return;
            target.done = !target.done;
            saveRoot();
            rerenderList();
          });
        });

        listEl.querySelectorAll("[data-todo-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-todo-del");
            trip.prepTodos = trip.prepTodos.filter(x=>x.id!==id);
            saveRoot();
            rerenderList();
          });
        });
      }

      rerenderList();

      const input = document.getElementById("prepInput");
      const addBtn = document.getElementById("prepAddBtn");

      function addTodo(){
        const text = (input.value||"").trim();
        if(!text) return;
        trip.prepTodos.push({ id: generateId("todo"), text, done:false });
        input.value = "";
        saveRoot();
        rerenderList();
      }

      addBtn.addEventListener("click", addTodo);
      input.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          addTodo();
        }
      });
    }

    /********************
     * 15) Viewï¼šè¡Œç¨‹ï¼ˆschedule / mapï¼‰
     ********************/
    function renderItinerarySchedule(trip){
      const dayId = trip.activeDayId;

      // è¡Œå‰ï¼šé¡¯ç¤ºå¾…è¾¦æ¸…å–®
      if(dayId === PREP_DAY_ID){
        renderPrepView(trip);
        return;
      }

      const list = (trip.itinerary[dayId] || []).slice().sort((a,b)=>(a.time||"").localeCompare(b.time||""));

      const dayDate = trip.days.find(d=>d.id===dayId)?.date || "";
      const dayFlights = trip.flights
        .filter(f => (f.date || "") === dayDate)
        .slice()
        .sort((a,b)=>(a.time||"").localeCompare(b.time||""));

      let html = `
        <section class="card">
          <div class="cardHeader">
            <div class="cardTitle">ç•¶æ—¥å…§å®¹</div>
            <button class="btn btnPrimary" id="openAddItBtn">ï¼‹ æ–°å¢è¡Œç¨‹</button>
          </div>

          <div class="smallLabel">ç•¶æ—¥å¤©æ°£</div>
          <div id="dayWeatherBox" class="weatherBox">
            <div class="wLoading">è®€å–å¤©æ°£ä¸­â€¦</div>
          </div>

          <div class="smallLabel">ç•¶æ—¥è¡Œç¨‹</div>
      `;

      if(!list.length){
        html += `<div class="empty">é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œé»å³ä¸Šè§’ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹æ–°å¢ã€‚</div>`;
      }else{
        html += `<div class="list">`;
        list.forEach(item=>{
          html += `
            <div class="listItem">
              <div class="listMain">
                <div class="meta">${safeText(item.time || "æ™‚é–“æœªå¡«å¯«")}</div>
                <div class="itemTitle">${safeText(item.title || "æœªå‘½åè¡Œç¨‹")}</div>
                ${item.note ? `<div class="note">${safeText(item.note)}</div>` : ""}
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
                <button class="btn btnGhost" data-nav="${item.id}">å°èˆª</button>
                <button class="btn btnGhost" data-edit="${item.id}">ç·¨è¼¯</button>
                <button class="btn btnDanger btnIcon" data-del="${item.id}">âœ•</button>
              </div>
            </div>
          `;
        });
        html += `</div>`;
      }

      html += `<div style="height:10px;"></div>`;

      html += `
        <div class="cardHeader" style="margin-top:4px;">
          <div class="cardTitle">ç•¶æ—¥èˆªç­</div>
          <button class="btn btnGhost" id="openAddFlightBtn">ï¼‹ æ–°å¢èˆªç­</button>
        </div>
      `;

      if(!dayDate){
        html += `<div class="empty">æ­¤æ—¥å°šæœªè¨­å®šæ—¥æœŸï¼Œç„¡æ³•è‡ªå‹•å°æ‡‰èˆªç­ã€‚</div>`;
      }else if(!dayFlights.length){
        html += `<div class="empty">æœ¬æ—¥å°šæœªæ–°å¢èˆªç­ã€‚</div>`;
      }else{
        dayFlights.forEach(f=>{
          const dateText = f.date ? formatDateMMDD(f.date) : "";
          const timeText = f.time || "";
          const fromCode = (f.from || "???").toUpperCase();
          const toCode = (f.to || "???").toUpperCase();
          const toCityZh = IATA_TO_CITY_ZH[toCode] || toCode;
          html += `
            <div class="flightCard">
              <button class="flightDel" data-fl-del="${f.id}">âœ•</button>
              <div class="flightTop">
                <div>${safeText(dateText)}${timeText ? " Â· "+safeText(timeText) : ""}</div>
                <div style="text-align:right;opacity:.95;">${safeText(f.note||"")}</div>
              </div>
              <div class="flightMain">
                <div>
                  <div class="airport">${safeText(fromCode)}</div>
                  <div class="airportLbl">FROM</div>
                </div>
                <div class="plane">âœˆï¸</div>
                <div style="text-align:right;">
                  <div class="airport">${safeText(toCode)}</div>
                  <div class="airportLbl">TO</div>
                </div>
              </div>
              <div class="flightBottom">
                <div><strong>ç­æ©Ÿï¼š</strong>${safeText(f.flightNo || "æœªå¡«å¯«")} Â· å‰å¾€ ${safeText(toCityZh)}</div>
              </div>
            </div>
          `;
        });
      }

      html += `</section>`;

      mainView.innerHTML = html;

      updateWeatherBox(trip, dayId);

      document.getElementById("openAddItBtn").addEventListener("click", ()=>{
        openItineraryModal(trip, dayId, null);
      });

      mainView.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          trip.itinerary[dayId] = (trip.itinerary[dayId]||[]).filter(x=>x.id !== id);
          saveRoot();
          renderItinerarySchedule(trip);
        });
      });

      mainView.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-edit");
          const item = (trip.itinerary[dayId]||[]).find(x=>x.id===id);
          if(!item) return;
          openItineraryModal(trip, dayId, item);
        });
      });

      mainView.querySelectorAll("[data-nav]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-nav");
          const item = (trip.itinerary[dayId]||[]).find(x=>x.id===id);
          const q = encodeURIComponent(item?.title || trip.destination || "æ™¯é»");
          window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
        });
      });

      document.getElementById("openAddFlightBtn").addEventListener("click", ()=>{
        openFlightModal(trip, { date: dayDate });
      });

      mainView.querySelectorAll("[data-fl-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-fl-del");
          trip.flights = trip.flights.filter(f=>f.id!==id);
          saveRoot();
          renderItinerarySchedule(trip);
        });
      });
    }

    async function renderItineraryMap(trip){
      const dayId = trip.activeDayId;

      // è¡Œå‰ä¸é¡¯ç¤ºåœ°åœ–
      if(dayId === PREP_DAY_ID){
        mainView.innerHTML = `
          <section class="card">
            <div class="cardHeader">
              <div class="cardTitle">åœ°åœ–</div>
            </div>
            <div class="empty">è¡Œå‰å¾…è¾¦ä¸é¡¯ç¤ºåœ°åœ–ã€‚è«‹åˆ‡å›ã€Œè¡Œç¨‹ã€æŸ¥çœ‹è¡Œå‰æº–å‚™æ¸…å–®ã€‚</div>
          </section>
        `;
        return;
      }

      mainView.innerHTML = `
        <section class="card">
          <div class="cardHeader">
            <div class="cardTitle">åœ°åœ–ï¼ˆä¾ç•¶æ—¥è¡Œç¨‹è‡ªå‹•é‡˜é¸ï¼‰</div>
            <button class="btn btnGhost" id="mapRefreshBtn">é‡æ–°è®€å–</button>
          </div>

          <div class="smallLabel">æç¤ºï¼šè«‹å…ˆåœ¨ã€Œè¡Œç¨‹ã€åˆ†é æ–°å¢åœ°é»ï¼Œé€™è£¡æœƒè‡ªå‹•é‡˜é¸ã€‚</div>
          <div id="dayMap" class="mapContainer"></div>

          <div style="margin-top:10px;font-size:11px;color:var(--sub);">
            è‹¥åœ°é»åç¨±éæ–¼ç°¡ç•¥ï¼ˆä¾‹å¦‚åªæ‰“ã€Œå·´é»ã€ï¼‰ï¼Œå¯èƒ½æœƒé‡˜åˆ°å…¶ä»–åœ‹å®¶ï¼›å»ºè­°é¸ç”¨ä¸‹æ‹‰å»ºè­°æˆ–è¼¸å…¥æ›´å®Œæ•´çš„åœ°æ¨™åç¨±ã€‚
          </div>
        </section>
      `;

      document.getElementById("mapRefreshBtn").addEventListener("click", ()=>{
        renderMapForDay(trip, dayId);
      });

      await renderMapForDay(trip, dayId);
    }

    /********************
     * 16) Viewï¼šèˆªç­ï¼ˆåˆ—è¡¨ï¼‰
     ********************/
    function renderFlightsView(trip){
      let html = `
        <section class="card">
          <div class="cardHeader">
            <div class="cardTitle">èˆªç­è³‡è¨Š</div>
            <button class="btn btnPrimary" id="openNewFlight">ï¼‹ æ–°å¢èˆªç­</button>
          </div>
          <div id="flightList"></div>
        </section>
      `;
      mainView.innerHTML = html;

      const listEl = document.getElementById("flightList");
      if(!trip.flights.length){
        listEl.innerHTML = `<div class="empty">ç›®å‰å°šæœªæ–°å¢èˆªç­ã€‚</div>`;
      }else{
        const list = trip.flights.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
        listEl.innerHTML = list.map(f=>{
          const dateText = f.date ? formatDateMMDD(f.date) : "";
          const timeText = f.time || "";
          const fromCode = (f.from || "???").toUpperCase();
          const toCode = (f.to || "???").toUpperCase();
          const note = f.note || "";
          const toCityZh = IATA_TO_CITY_ZH[toCode] || toCode;
          return `
            <div class="flightCard">
              <button class="flightDel" data-del="${f.id}">âœ•</button>
              <div class="flightTop">
                <div>${safeText(dateText)}${timeText ? " Â· "+safeText(timeText) : ""}</div>
                <div style="text-align:right;opacity:.95;">${safeText(note)}</div>
              </div>
              <div class="flightMain">
                <div>
                  <div class="airport">${safeText(fromCode)}</div>
                  <div class="airportLbl">FROM</div>
                </div>
                <div class="plane">âœˆï¸</div>
                <div style="text-align:right;">
                  <div class="airport">${safeText(toCode)}</div>
                  <div class="airportLbl">TO</div>
                </div>
              </div>
              <div class="flightBottom">
                <div><strong>ç­æ©Ÿï¼š</strong>${safeText(f.flightNo || "æœªå¡«å¯«")} Â· å‰å¾€ ${safeText(toCityZh)}</div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn btnGhost" data-edit="${f.id}">ç·¨è¼¯</button>
              </div>
            </div>
          `;
        }).join("");

        listEl.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-del");
            trip.flights = trip.flights.filter(f=>f.id !== id);
            saveRoot();
            renderFlightsView(trip);
          });
        });

        listEl.querySelectorAll("[data-edit]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-edit");
            const f = trip.flights.find(x=>x.id===id);
            if(!f) return;
            openFlightModal(trip, f);
          });
        });
      }

      document.getElementById("openNewFlight").addEventListener("click", ()=>{
        const dayDate = (trip.activeDayId && trip.activeDayId !== PREP_DAY_ID)
          ? (trip.days.find(d=>d.id===trip.activeDayId)?.date || "")
          : "";
        openFlightModal(trip, dayDate ? { date: dayDate } : null);
      });
    }

    /********************
     * 17) Viewï¼šè¨˜å¸³ï¼ˆä¾æ¯æ—¥è¨˜éŒ„ï¼‰â€”â€”åœ–äºŒæ¨¡æ¿
     ********************/
    let expenseFilter = "all"; // all | cash | card

    function calcApproxTwdForExpense(e, cur, usableRate){
      if(typeof e.approxTwd === "number" && !isNaN(e.approxTwd)) return e.approxTwd;
      const amt = Number(e.amount)||0;
      if(cur === "TWD") return amt;
      if(usableRate) return amt * usableRate;
      return 0;
    }

    function renderExpensesView(trip){
      const cur = (trip.currency || "JPY").toUpperCase();
      const dayId = trip.activeDayId;
      const dayDate = (dayId && dayId !== PREP_DAY_ID) ? (trip.days.find(d=>d.id===dayId)?.date || "") : "";

      // è¡Œå‰ä¸è¨˜å¸³ï¼ˆé¿å…æ··äº‚ï¼‰
      if(dayId === PREP_DAY_ID){
        mainView.innerHTML = `
          <section class="card">
            <div class="cardHeader">
              <div class="cardTitle">è¨˜å¸³ï¼ˆä¾æ¯æ—¥è¨˜éŒ„ï¼‰</div>
            </div>
            <div class="empty">è¡Œå‰å¾…è¾¦ä¸æä¾›è¨˜å¸³ã€‚è«‹åˆ‡åˆ° Day 1ï½Day N å†è¨˜å¸³ã€‚</div>
          </section>
        `;
        return;
      }

      // ç•¶æ—¥å…¨éƒ¨æ¸…å–®ï¼ˆç”¨æ–¼ç¸½è¦½æ‹†åˆ†ï¼‰
      const dayAll = trip.expenses.filter(e => e.dayId === dayId);

      // åˆ—è¡¨ï¼šä¾ç¯©é¸
      let dayList = dayAll.slice();
      if(expenseFilter === "cash") dayList = dayList.filter(e=>e.method==="cash");
      if(expenseFilter === "card") dayList = dayList.filter(e=>e.method==="card");

      const ex = trip.exchangeRate;
      const usableRate = (cur === "TWD")
        ? null
        : (ex && typeof ex.rate === "number" && ex.rate > 0 && ex.base === cur && ex.target === "TWD" ? ex.rate : null);

      // ç¸½è¦½ï¼šä¸å—ç¯©é¸å½±éŸ¿
      const totalCur = dayAll.reduce((s,e)=> s + (Number(e.amount)||0), 0);
      const totalTwd = dayAll.reduce((s,e)=> s + calcApproxTwdForExpense(e, cur, usableRate), 0);

      const cashAll = dayAll.filter(e=>e.method==="cash");
      const cardAll = dayAll.filter(e=>e.method==="card");

      const cashCur = cashAll.reduce((s,e)=> s + (Number(e.amount)||0), 0);
      const cashTwd = cashAll.reduce((s,e)=> s + calcApproxTwdForExpense(e, cur, usableRate), 0);

      const cardCur = cardAll.reduce((s,e)=> s + (Number(e.amount)||0), 0);
      const cardTwd = cardAll.reduce((s,e)=> s + calcApproxTwdForExpense(e, cur, usableRate), 0);

      mainView.innerHTML = `
        <section class="card">
          <div class="cardHeader">
            <div class="cardTitle">è¨˜å¸³ï¼ˆä¾æ¯æ—¥è¨˜éŒ„ï¼‰</div>
            <button class="btn btnGhost" id="expFetchRate">æŸ¥è©¢åŒ¯ç‡</button>
          </div>

          <div style="font-size:11px;color:var(--sub);margin-bottom:10px;">
            ç›®å‰é¡¯ç¤ºï¼š${safeText(dayDate ? formatDateMMDD(dayDate) : "æ­¤æ—¥æœªè¨­å®šæ—¥æœŸ")}ï¼ˆ${safeText(dayId)}ï¼‰
          </div>

          <div class="row">
            <div class="col">
              <div class="smallLabel">åŒ¯ç‡ï¼ˆ${safeText(cur)} âœ TWDï¼‰</div>
              <input id="expRateInput" placeholder="1 ${safeText(cur)} = ? TWD" />
            </div>
            <div style="display:flex;align-items:flex-end;">
              <button class="btn btnPrimary" id="expSaveRate">å„²å­˜</button>
            </div>
          </div>

          <div style="margin-top:6px;font-size:11px;color:var(--sub);" id="expRateHint"></div>

          <!-- åœ–äºŒï¼šç¸½æ”¯å‡º + ç¾é‡‘/ä¿¡ç”¨å¡æ‹†åˆ† -->
          <div class="expenseSummaryCard">
            <div class="expenseSumTop">ç¸½æ”¯å‡ºï¼ˆ${safeText(cur)}ï¼‰</div>
            <div class="expenseSumMain">${Math.round(totalCur)}</div>
            <div class="expenseSumSub">ç´„ TWD ${Math.round(totalTwd)}</div>

            <div class="expenseSplit">
              <div class="expenseCol">
                <div class="expenseColTitle">ç¾é‡‘</div>
                <div class="expenseColVal">${Math.round(cashCur)}</div>
                <div class="expenseColSub">ç´„ TWD ${Math.round(cashTwd)}</div>
              </div>
              <div class="expenseDivider"></div>
              <div class="expenseCol">
                <div class="expenseColTitle">ä¿¡ç”¨å¡</div>
                <div class="expenseColVal">${Math.round(cardCur)}</div>
                <div class="expenseColSub">ç´„ TWD ${Math.round(cardTwd)}</div>
              </div>
            </div>
          </div>

          <div class="segTabs" style="margin-top:10px;">
            <div class="segTab ${expenseFilter==="all"?"active":""}" data-expf="all">å…¨éƒ¨</div>
            <div class="segTab ${expenseFilter==="cash"?"active":""}" data-expf="cash">ç¾é‡‘</div>
            <div class="segTab ${expenseFilter==="card"?"active":""}" data-expf="card">ä¿¡ç”¨å¡</div>
          </div>

          <div style="margin-top:12px;">
            <div class="cardHeader" style="margin-bottom:8px;">
              <div class="cardTitle">æ–°å¢æ”¯å‡º</div>
              <button class="btn btnPrimary" id="addExpBtn">ï¼‹ æ–°å¢</button>
            </div>

            <div class="row">
              <div class="col">
                <div class="smallLabel">æ—¥æœŸï¼ˆè‡ªå‹•å¸¶å…¥ç•¶æ—¥ï¼‰</div>
                <input type="date" id="expDate" value="${safeText(dayDate)}" />
              </div>
              <div class="col">
                <div class="smallLabel">ä»˜æ¬¾æ–¹å¼</div>
                <select id="expMethod">
                  <option value="cash">ç¾é‡‘</option>
                  <option value="card">ä¿¡ç”¨å¡</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col">
                <div class="smallLabel">é‡‘é¡ï¼ˆ${safeText(cur)}ï¼‰</div>
                <input id="expAmount" type="number" placeholder="ä¾‹å¦‚ï¼š1200" />
              </div>
              <div class="col">
                <div class="smallLabel">åˆ†é¡</div>
                <input id="expCategory" placeholder="é¤é£²ã€äº¤é€šâ€¦" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <div class="smallLabel">ç´„ç•¶ TWDï¼ˆå¯ç•™ç™½ï¼‰</div>
                <input id="expApprox" type="number" placeholder="å¯æ‰‹å‹•è¼¸å…¥" />
              </div>
              <div class="col">
                <div class="smallLabel">å‚™è¨»</div>
                <input id="expNote" placeholder="åº—åã€åˆ·å“ªå¼µå¡â€¦" />
              </div>
            </div>

            <div style="margin-top:6px;font-size:11px;color:var(--sub);">
              è‹¥æœªå¡«ã€Œç´„ç•¶ TWDã€ï¼Œæœƒä¾åŒ¯ç‡è‡ªå‹•æ›ç®—ï¼ˆè‹¥å¯ç”¨ï¼‰ã€‚
            </div>
          </div>

          <div style="margin-top:14px;" id="expList"></div>
        </section>
      `;

      // åŒ¯ç‡é¡¯ç¤º
      const rateInput = document.getElementById("expRateInput");
      const hint = document.getElementById("expRateHint");

      if(cur === "TWD"){
        hint.textContent = "ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€åŒ¯ç‡ã€‚";
      }else if(usableRate){
        rateInput.value = usableRate.toFixed(2);
        hint.textContent = `ç›®å‰åŒ¯ç‡ï¼š1 ${cur} â‰ˆ ${usableRate.toFixed(2)} TWD`;
      }else{
        hint.textContent = "ç›®å‰å°šæœªè¨­å®šåŒ¯ç‡ã€‚";
      }

      document.querySelectorAll("[data-expf]").forEach(tab=>{
        tab.addEventListener("click", ()=>{
          expenseFilter = tab.getAttribute("data-expf");
          renderExpensesView(trip);
        });
      });

      document.getElementById("expFetchRate").addEventListener("click", async ()=>{
        if(cur === "TWD"){
          alert("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æŸ¥è©¢åŒ¯ç‡ã€‚");
          return;
        }
        try{
          const r = await fetchRateToTWD(cur);
          trip.exchangeRate = { base:cur, target:"TWD", rate:r.rate, updatedAt:r.updatedAt };
          saveRoot();
          renderExpensesView(trip);
        }catch(e){
          console.error(e);
          alert("åŒ¯ç‡æŸ¥è©¢å¤±æ•—ï¼š" + e.message);
        }
      });

      document.getElementById("expSaveRate").addEventListener("click", ()=>{
        const v = parseFloat(rateInput.value);
        if(cur === "TWD"){
          alert("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€å„²å­˜åŒ¯ç‡ã€‚");
          return;
        }
        if(isNaN(v) || v <= 0){
          alert("è«‹è¼¸å…¥æ­£ç¢ºçš„åŒ¯ç‡æ•¸å­—ï¼ˆ> 0ï¼‰ã€‚");
          return;
        }
        trip.exchangeRate = { base:cur, target:"TWD", rate:v, updatedAt:"" };
        saveRoot();
        renderExpensesView(trip);
      });

      // æ–°å¢æ”¯å‡º
      document.getElementById("addExpBtn").addEventListener("click", ()=>{
        const date = document.getElementById("expDate").value || dayDate || "";
        const method = document.getElementById("expMethod").value;
        const amount = parseFloat(document.getElementById("expAmount").value);
        const category = (document.getElementById("expCategory").value||"").trim();
        const approxInput = parseFloat(document.getElementById("expApprox").value);
        const note = (document.getElementById("expNote").value||"").trim();

        if(isNaN(amount)) return;

        let approxTwd = null;
        if(!isNaN(approxInput)) approxTwd = approxInput;
        else if(cur === "TWD") approxTwd = amount;
        else if(usableRate) approxTwd = amount * usableRate;

        trip.expenses.push({
          id: generateId("exp"),
          dayId,
          date,
          method,
          amount,
          category,
          note,
          approxTwd
        });

        saveRoot();
        renderExpensesView(trip);
      });

      // åˆ—è¡¨
      const listEl = document.getElementById("expList");
      if(!dayList.length){
        listEl.innerHTML = `<div class="empty">æœ¬æ—¥å°šæœªæ–°å¢æ”¯å‡ºã€‚</div>`;
      }else{
        const labelOf = (m)=> m==="cash"?"ç¾é‡‘":(m==="card"?"ä¿¡ç”¨å¡":"å…¶ä»–");
        listEl.innerHTML = `<div class="list">` + dayList
          .slice()
          .sort((a,b)=>(a.date||"").localeCompare(b.date||""))
          .map(e=>{
            const approx = (typeof e.approxTwd === "number" && !isNaN(e.approxTwd))
              ? `ç´„ TWD ${Math.round(e.approxTwd)}`
              : (cur==="TWD" ? "" : (usableRate ? `ç´„ TWD ${Math.round((Number(e.amount)||0)*usableRate)}` : ""));
            return `
              <div class="listItem">
                <div class="listMain">
                  <div class="meta">${safeText(e.date ? formatDateMMDD(e.date) : "")}</div>
                  <div class="itemTitle">
                    ${safeText(e.category || "æœªåˆ†é¡")}
                    <span class="badge">${safeText(labelOf(e.method))}</span>
                    <span class="badge">${safeText(cur)} ${Math.round(Number(e.amount)||0)}</span>
                    ${approx ? `<span class="badge">${safeText(approx)}</span>` : ""}
                  </div>
                  ${e.note ? `<div class="note">${safeText(e.note)}</div>` : ""}
                </div>
                <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
                  <button class="btn btnDanger btnIcon" data-exp-del="${e.id}">âœ•</button>
                </div>
              </div>
            `;
          }).join("") + `</div>`;

        listEl.querySelectorAll("[data-exp-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-exp-del");
            trip.expenses = trip.expenses.filter(x=>x.id !== id);
            saveRoot();
            renderExpensesView(trip);
          });
        });
      }
    }

    /********************
     * 18) Viewï¼šè³¼ç‰©
     ********************/
    function renderShoppingView(trip){
      const cur = (trip.currency || "JPY").toUpperCase();
      const totalPlan = trip.shopping.reduce((s,i)=> s + (Number(i.price)||0), 0);
      const totalBought = trip.shopping.filter(i=>i.bought).reduce((s,i)=> s + (Number(i.price)||0), 0);

      mainView.innerHTML = `
        <section class="card">
          <div class="cardHeader">
            <div class="cardTitle">è³¼ç‰©æ¸…å–®</div>
          </div>

          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--sub);">
            <div>è¨ˆç•«è³¼ç‰©ç¸½é¡</div><div style="font-weight:900;color:var(--text);">${safeText(cur)} ${Math.round(totalPlan)}</div>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--sub);margin-top:4px;">
            <div>å·²è³¼è²·é‡‘é¡</div><div style="font-weight:900;color:var(--text);">${safeText(cur)} ${Math.round(totalBought)}</div>
          </div>

          <div style="margin-top:14px;">
            <div class="cardHeader" style="margin-bottom:8px;">
              <div class="cardTitle">æ–°å¢å“é …</div>
              <button class="btn btnPrimary" id="addShopBtn">ï¼‹ æ–°å¢</button>
            </div>

            <div class="row">
              <div class="col">
                <div class="smallLabel">å“é …</div>
                <input id="shopName" placeholder="ä¾‹å¦‚ï¼šä¼´æ‰‹ç¦®ã€ä¿é¤Šå“â€¦" />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <div class="smallLabel">åƒ¹æ ¼ï¼ˆ${safeText(cur)}ï¼‰</div>
                <input id="shopPrice" type="number" placeholder="å¯ç•™ç™½" />
              </div>
              <div class="col">
                <div class="smallLabel">å‚™è¨»</div>
                <input id="shopNote" placeholder="åº—å®¶ã€è‰²è™Ÿâ€¦" />
              </div>
            </div>
          </div>

          <div style="margin-top:14px;" id="shopList"></div>
        </section>
      `;

      document.getElementById("addShopBtn").addEventListener("click", ()=>{
        const name = (document.getElementById("shopName").value||"").trim();
        const price = parseFloat(document.getElementById("shopPrice").value);
        const note = (document.getElementById("shopNote").value||"").trim();
        if(!name && !note) return;

        trip.shopping.push({
          id: generateId("shop"),
          name: name || "æœªå‘½åå“é …",
          price: isNaN(price) ? 0 : price,
          note,
          bought:false
        });

        saveRoot();
        renderShoppingView(trip);
      });

      const listEl = document.getElementById("shopList");
      if(!trip.shopping.length){
        listEl.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è³¼ç‰©å“é …ã€‚</div>`;
      }else{
        listEl.innerHTML = `<div class="list">` + trip.shopping.map(i=>`
          <div class="listItem">
            <div class="listMain">
              <div class="itemTitle">
                ${safeText(i.name)}
                ${i.bought ? `<span class="badge">å·²è³¼è²·</span>` : ""}
                ${i.price ? `<span class="badge">${safeText(cur)} ${Math.round(i.price)}</span>` : ""}
              </div>
              ${i.note ? `<div class="note">${safeText(i.note)}</div>` : ""}
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
              <button class="btn btnGhost" data-toggle="${i.id}">${i.bought ? "å–æ¶ˆå·²è²·" : "æ¨™è¨˜å·²è²·"}</button>
              <button class="btn btnDanger btnIcon" data-del="${i.id}">âœ•</button>
            </div>
          </div>
        `).join("") + `</div>`;

        listEl.querySelectorAll("[data-toggle]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-toggle");
            const target = trip.shopping.find(x=>x.id===id);
            if(target){
              target.bought = !target.bought;
              saveRoot();
              renderShoppingView(trip);
            }
          });
        });
        listEl.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-del");
            trip.shopping = trip.shopping.filter(x=>x.id!==id);
            saveRoot();
            renderShoppingView(trip);
          });
        });
      }
    }

    /********************
     * 19) ä¸»åˆ‡æ›ï¼šrenderCurrentMainView
     ********************/
    function renderCurrentMainView(keepScroll){
      const trip = getCurrentTrip();

      itinerarySegTabs.style.display = (currentTab === "itinerary") ? "flex" : "none";

      if(currentTab === "itinerary"){
        itinerarySegTabs.querySelectorAll(".segTab").forEach(tab=>{
          tab.classList.toggle("active", tab.getAttribute("data-seg") === itinerarySubTab);
        });

        if(itinerarySubTab === "map"){
          renderItineraryMap(trip);
        }else{
          renderItinerarySchedule(trip);
        }
      }else if(currentTab === "flights"){
        renderFlightsView(trip);
      }else if(currentTab === "expenses"){
        renderExpensesView(trip);
      }else if(currentTab === "shopping"){
        renderShoppingView(trip);
      }

      if(!keepScroll){
        window.scrollTo({ top: 0, behavior: "auto" });
      }
    }

    /********************
     * 20) åˆå§‹åŒ–
     ********************/
    (function init(){
      const trip = getCurrentTrip();
      if(!trip.days?.length) regenerateDays(trip);

      renderHeader();
      renderDayChips();
      renderDrawerTrips();

      itinerarySegTabs.style.display = "flex";
      itinerarySubTab = "schedule";
      itinerarySegTabs.querySelectorAll(".segTab").forEach(x=>{
        x.classList.toggle("active", x.getAttribute("data-seg")==="schedule");
      });

      renderCurrentMainView(false);
    })();
  </script>
</body>
</html>
