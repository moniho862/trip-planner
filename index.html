<script>
// ====== åœ°ç†ç·¨ç¢¼èˆ‡å¤©æ°£æŸ¥è©¢å…±ç”¨è®Šæ•¸ ======
let geoCache = {};
let mapInstance = null;
let markersLayer = null;

// å–å¾—åº§æ¨™ï¼ˆä½¿ç”¨ open-meteo geocodingï¼‰
async function geocodeLocation(name) {
  const q = (name || "").trim();
  if (!q) return null;
  if (geoCache[q]) return geoCache[q];

  const res = await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=zh_TW&format=json`
  );
  if (!res.ok) return null;
  const data = await res.json();
  if (!data.results || !data.results.length) return null;
  const r = data.results[0];
  const result = { lat: r.latitude, lon: r.longitude, name: r.name, country: r.country };
  geoCache[q] = result;
  return result;
}

// å–å¾—å¤©æ°£
async function fetchWeather(lat, lon) {
  const res = await fetch(
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`
  );
  if (!res.ok) return null;
  const data = await res.json();
  return {
    max: data.daily.temperature_2m_max[0],
    min: data.daily.temperature_2m_min[0],
    code: data.daily.weathercode[0],
  };
}

// Leaflet å¤©æ°£åœ–ç¤ºå°ç…§
const weatherIcons = {
  0: "â˜€ï¸ æ™´å¤©",
  1: "ğŸŒ¤ å°‘é›²",
  2: "â›… å¤šé›²",
  3: "â˜ï¸ é™°å¤©",
  45: "ğŸŒ« éœ§",
  48: "ğŸŒ« å‡éœ§",
  51: "ğŸŒ¦ æ¯›æ¯›é›¨",
  61: "ğŸŒ§ å°é›¨",
  63: "ğŸŒ§ ä¸­é›¨",
  65: "ğŸŒ§ å¤§é›¨",
  71: "â„ï¸ å°é›ª",
  73: "â„ï¸ ä¸­é›ª",
  75: "â„ï¸ å¤§é›ª",
  95: "â›ˆ é›·é›¨",
};

// é¡¯ç¤ºæ¯æ—¥åœ°åœ–èˆ‡å¤©æ°£
async function renderDailyMapAndWeather(dayData, mapContainerId, weatherContainerId) {
  const mapContainer = document.getElementById(mapContainerId);
  const weatherEl = document.getElementById(weatherContainerId);
  if (!mapContainer || !dayData) return;

  // æ¸…ç©ºåœ°åœ–èˆ‡å¤©æ°£
  mapContainer.innerHTML = "";
  weatherEl.innerHTML = "";

  const geocodedPlaces = [];

  // 1ï¸âƒ£ æ ¹æ“šæ¯æ—¥è¡Œç¨‹çš„æ¯ä¸€å€‹åœ°é»åç¨±å»æŸ¥åº§æ¨™
  for (const item of dayData.items || []) {
    if (item.place && item.place.trim() !== "") {
      const loc = await geocodeLocation(item.place);
      if (loc) geocodedPlaces.push(loc);
    }
  }

  // 2ï¸âƒ£ åˆå§‹åŒ– Leaflet åœ°åœ–
  mapInstance = L.map(mapContainer, { zoomControl: true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap",
  }).addTo(mapInstance);

  markersLayer = L.layerGroup().addTo(mapInstance);

  // 3ï¸âƒ£ é‡˜é¸æ‰€æœ‰è¡Œç¨‹åœ°é»
  if (geocodedPlaces.length > 0) {
    geocodedPlaces.forEach((p) => {
      L.marker([p.lat, p.lon]).addTo(markersLayer).bindPopup(`${p.name}<br>${p.country || ""}`);
    });

    // èª¿æ•´è¦–é‡
    const bounds = L.latLngBounds(geocodedPlaces.map((p) => [p.lat, p.lon]));
    mapInstance.fitBounds(bounds, { padding: [40, 40] });

    // 4ï¸âƒ£ é¡¯ç¤ºå¤©æ°£ï¼ˆå–ç¬¬ä¸€å€‹åœ°é»ï¼‰
    const w = await fetchWeather(geocodedPlaces[0].lat, geocodedPlaces[0].lon);
    if (w) {
      weatherEl.innerHTML = `
        <div class="bg-blue-50 rounded-lg p-3 text-gray-800 text-sm flex items-center justify-between">
          <div>${weatherIcons[w.code] || "ğŸŒ"} ${w.min}Â° / ${w.max}Â°</div>
          <div class="text-xs text-gray-500">è³‡æ–™ä¾†æºï¼šOpen-Meteoï¼ˆæ¯æ—¥æ•´é«”é«˜ / ä½æº«ï¼‰</div>
        </div>`;
    } else {
      weatherEl.innerHTML = `<div class="text-gray-500 text-sm">ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™ã€‚</div>`;
    }
  } else {
    weatherEl.innerHTML = `<div class="text-gray-500 text-sm">æ²’æœ‰å¯é¡¯ç¤ºçš„åœ°é»ã€‚</div>`;
    mapInstance.setView([48.8566, 2.3522], 5); // é è¨­æ³•åœ‹å·´é»
  }

  // 5ï¸âƒ£ é¡¯ç¤ºä½¿ç”¨è€…ç›®å‰ä½ç½®ï¼ˆè‹¥å…è¨±ï¼‰
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        const userMarker = L.circleMarker([latitude, longitude], {
          radius: 6,
          color: "#007bff",
          fillColor: "#007bff",
          fillOpacity: 0.8,
        })
          .addTo(markersLayer)
          .bindPopup("ğŸ“ ç›®å‰ä½ç½®");
      },
      (err) => console.warn("å®šä½å¤±æ•—ï¼š", err)
    );
  }
}
</script>
