<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Planner</title>
  <style>
    :root {
      --bg: #e9f3ff;
      --primary: #3b82f6;
      --primary-soft: #dbeafe;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 20px;
      --radius-md: 14px;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #c5e0ff 0%, #f5f7ff 40%, #ffffff 100%);
      color: var(--text-main);
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px 16px 72px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-sub);
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(59,130,246,.1);
      color: #1d4ed8;
      margin-left: 6px;
    }

    .top-info {
      text-align: right;
      font-size: 11px;
      color: var(--text-sub);
    }

    .top-info-line {
      white-space: nowrap;
    }

    .top-info-line + .top-info-line {
      margin-top: 2px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 12px 14px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08);
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .small-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      font-size: 13px;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      outline: none;
      background: #f9fafb;
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      background: #ffffff;
    }

    textarea {
      border-radius: 12px;
      resize: vertical;
      min-height: 52px;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }

    .row > .col {
      flex: 1;
    }

    .btn {
      border-radius: 999px;
      border: none;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-ghost {
      background: #eef2ff;
      color: #4f46e5;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      padding: 0;
      justify-content: center;
    }

    .btn-sm {
      font-size: 12px;
      padding: 5px 10px;
    }

    .tabs {
      display: flex;
      background: rgba(255,255,255,.8);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      margin: 8px 0 12px;
    }

    .tab {
      flex: 1;
      text-align: center;
      font-size: 13px;
      padding: 6px 0;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-sub);
    }

    .tab.active {
      background: #111827;
      color: #f9fafb;
    }

    .day-chips {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding-bottom: 4px;
      margin-bottom: 8px;
    }

    .chip {
      min-width: 68px;
      padding: 6px 8px;
      border-radius: 16px;
      background: #eff6ff;
      font-size: 11px;
      text-align: center;
      cursor: pointer;
      color: #1d4ed8;
    }

    .chip strong {
      display: block;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .chip.active {
      background: #1d4ed8;
      color: #eff6ff;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eff6ff;
      font-size: 11px;
      color: #1d4ed8;
    }

    .list {
      margin-top: 6px;
    }

    .list-item {
      background: #f9fafb;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
    }

    .list-main {
      flex: 1;
    }

    .list-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .list-meta {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .list-note {
      font-size: 12px;
      color: #4b5563;
    }

    .badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      margin-left: 4px;
    }

    .empty {
      font-size: 12px;
      color: var(--text-sub);
      text-align: center;
      padding: 12px 4px 4px;
    }

    /* checklist */
    .check-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .check-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .check-text.done {
      text-decoration: line-through;
      color: #9ca3af;
    }

    /* bottom nav */
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 480px;
      margin: 0 auto;
      padding: 8px 16px 12px;
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(18px);
      border-top: 1px solid rgba(209,213,219,.8);
    }

    .bottom-tabs {
      display: flex;
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
    }

    .bottom-tab {
      flex: 1;
      text-align: center;
      font-size: 11px;
      padding: 6px 0 4px;
      border-radius: 999px;
      color: #6b7280;
      cursor: pointer;
    }

    .bottom-tab span {
      display: block;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .bottom-tab.active {
      background: #111827;
      color: #f9fafb;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 4px;
      color: var(--text-sub);
    }

    .summary-row strong {
      color: #111827;
    }

    /* ===== èˆªç­å¡ç‰‡æ¨£å¼ ===== */
    .flight-card-wrap {
      margin-top: 8px;
    }

    .flight-card {
      position: relative;
      border-radius: 22px;
      padding: 12px 14px;
      background: linear-gradient(135deg, #2563eb, #0ea5e9);
      color: #f9fafb;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.35);
      overflow: hidden;
    }

    .flight-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      opacity: 0.9;
    }

    .flight-card-top-left {
      font-weight: 600;
    }

    .flight-card-top-right {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.25);
      font-size: 11px;
    }

    .flight-card-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
    }

    .flight-airport {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .flight-airport-label {
      font-size: 11px;
      opacity: 0.9;
    }

    .flight-plane-icon {
      font-size: 22px;
      padding: 0 10px;
    }

    .flight-card-bottom {
      margin-top: 6px;
      font-size: 12px;
      opacity: 0.95;
    }

    .flight-card-note {
      margin-top: 2px;
      font-size: 11px;
      opacity: 0.9;
    }

    .flight-delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: rgba(248, 113, 113, 0.9);
      color: #fee2e2;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    @media (min-width: 768px) {
      .app {
        margin-top: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">
          Trip Planner
          <span class="tag" id="destinationTag">æœªè¨­å®šç›®çš„åœ°</span>
        </div>
        <div class="subtitle" id="tripNameText">æœªå‘½åæ—…ç¨‹</div>
      </div>
      <div class="top-info">
        <div id="dateInfoText" class="top-info-line">è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸</div>
        <div id="rateInfoText" class="top-info-line">åŒ¯ç‡å°šæœªè¨­å®š</div>
      </div>
    </header>

    <!-- æ—…ç¨‹é¸æ“‡ + åŸºæœ¬è¨­å®š -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">æ—…ç¨‹è¨­å®š</div>
      </div>

      <div class="row">
        <div class="col">
          <label class="small-label">é¸æ“‡æ—…ç¨‹</label>
          <select id="tripSelect"></select>
        </div>
        <button class="btn btn-ghost btn-sm" id="newTripBtn">ï¼‹ æ–°æ—…ç¨‹</button>
      </div>

      <div class="row" style="margin-bottom:2px;">
        <button class="btn btn-danger btn-sm" id="deleteTripBtn">åˆªé™¤ç›®å‰æ—…ç¨‹</button>
        <div style="font-size:11px;color:var(--text-sub);">
          * åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œé©åˆåˆªé™¤æ¸¬è©¦ç”¨æ—…ç¨‹
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0 10px;">

      <div class="row">
        <div class="col">
          <label class="small-label">æ—…ç¨‹åç¨±</label>
          <input id="tripNameInput" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥è‡ªç”±è¡Œ" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label class="small-label">ç›®çš„åœ°åŸå¸‚ / å€åŸŸ</label>
          <input id="destinationInput" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€æ­æ´²â€¦" />
        </div>
        <div class="col">
          <label class="small-label">ä¸»è¦è²¨å¹£</label>
          <select id="currencyInput">
            <option value="KRW">KRW éŸ“å…ƒ</option>
            <option value="JPY">JPY æ—¥åœ“</option>
            <option value="TWD">TWD æ–°å°å¹£</option>
            <option value="HKD">HKD æ¸¯å¹£</option>
            <option value="USD">USD ç¾å…ƒ</option>
            <option value="EUR">EUR æ­å…ƒ</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label class="small-label">å‡ºç™¼æ—¥æœŸ</label>
          <input type="date" id="startDateInput" />
        </div>
        <div class="col">
          <label class="small-label">å¤©æ•¸</label>
          <input type="number" id="daysInput" min="1" max="30" value="4" />
        </div>
      </div>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <button class="btn btn-primary" id="applyTripBtn">å¥—ç”¨è®Šæ›´</button>
        <button class="btn btn-ghost" id="resetBtn">æ¸…ç©ºæœ¬æ—…ç¨‹è³‡æ–™</button>
      </div>
    </section>

    <!-- ä¸»å…§å®¹ï¼šä¾åº•éƒ¨ tab åˆ‡æ› -->
    <div id="mainView"></div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <nav class="bottom-nav">
    <div class="bottom-tabs">
      <div class="bottom-tab active" data-tab="itinerary">
        <span>ğŸ—º</span>è¡Œç¨‹
      </div>
      <div class="bottom-tab" data-tab="prep">
        <span>ğŸ§³</span>è¡Œå‰
      </div>
      <div class="bottom-tab" data-tab="flights">
        <span>âœˆï¸</span>èˆªç­
      </div>
      <div class="bottom-tab" data-tab="expenses">
        <span>ğŸ’°</span>è¨˜å¸³
      </div>
      <div class="bottom-tab" data-tab="shopping">
        <span>ğŸ›</span>è³¼ç‰©
      </div>
    </div>
  </nav>

  <script>
    // ====== Aviationstack API è¨­å®šï¼ˆä½ è‡ªå·±çš„ keyï¼‰ ======
    const AVIATIONSTACK_KEY = "f9e92bf4a1ac9571bb2f08a7050e0503";

    // ====== åŒ¯ç‡ APIï¼šopen.er-api.comï¼ˆå… keyï¼‰ ======
    async function fetchFxRate(baseCurrency) {
      const url = "https://open.er-api.com/v6/latest/" + encodeURIComponent(baseCurrency);
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      const data = await res.json();
      if (!data || data.result !== "success") {
        throw new Error("å–å¾—åŒ¯ç‡è³‡æ–™å¤±æ•—ï¼ˆresult=" + (data && data.result) + "ï¼‰");
      }
      const rate = data.rates && data.rates.TWD;
      if (!rate) {
        throw new Error("å–å¾—åŒ¯ç‡è³‡æ–™å¤±æ•—ï¼ˆç„¡ TWD åŒ¯ç‡ï¼‰");
      }
      return {
        rate: rate,
        updatedAt: data.time_last_update_utc || ""
      };
    }

    // ====== è³‡æ–™çµæ§‹ / å„²å­˜ ======
    const STORAGE_KEY = "tripPlanner_multi_v2";

    function createEmptyTrip(name) {
      return {
        id: "trip_" + Math.random().toString(36).slice(2, 9),
        name: name || "æ–°æ—…ç¨‹",
        destination: "",
        currency: "JPY",
        startDate: "",
        daysCount: 4,
        days: [],
        activeDayId: null,
        flights: [],
        checklist: [],
        itinerary: {},
        expenses: [],
        shopping: [],
        fxBase: null,       // ä¾‹å¦‚ "EUR"
        fxRate: null,       // 1 base = ? TWD
        fxUpdatedAt: null   // åŒ¯ç‡æ™‚é–“å­—ä¸²
      };
    }

    function loadRoot() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(trip);
          return { trips: [trip], activeTripId: trip.id };
        }
        return JSON.parse(raw);
      } catch (e) {
        console.error(e);
        const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
        regenerateDays(trip);
        return { trips: [trip], activeTripId: trip.id };
      }
    }

    let root = loadRoot();

    function saveRoot() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(root));
      renderHeader();
      renderTripSelector();
    }

    function getCurrentTrip() {
      let t = root.trips.find(trip => trip.id === root.activeTripId);
      if (!t) {
        t = root.trips[0];
        root.activeTripId = t.id;
      }
      return t;
    }

    function regenerateDays(trip) {
      const start = trip.startDate ? new Date(trip.startDate) : null;
      const days = [];
      for (let i = 0; i < trip.daysCount; i++) {
        let dStr = "";
        if (start) {
          const d = new Date(start);
          d.setDate(d.getDate() + i);
          dStr = d.toISOString().substring(0, 10);
        }
        const id = "day" + (i + 1);
        days.push({ id, label: "Day " + (i + 1), date: dStr });
        if (!trip.itinerary[id]) trip.itinerary[id] = [];
      }
      trip.days = days;
      if (!trip.activeDayId && days.length > 0) {
        trip.activeDayId = days[0].id;
      }
    }

    // ====== å°å·¥å…· ======
    function formatDateMMDD(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return String(m).padStart(2, "0") + "/" + String(day).padStart(2, "0");
    }

    function generateId(prefix) {
      return prefix + "_" + Math.random().toString(36).slice(2, 9);
    }

    function formatAmount(amount, currency) {
      if (amount == null || isNaN(amount)) return "-";
      return currency + " " + amount.toFixed(0);
    }

    function formatDateYYYYMMDDFromUtc(utcStr) {
      if (!utcStr) return "";
      const d = new Date(utcStr);
      if (isNaN(d)) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    // ====== ä¾èˆªç­è™Ÿå¾ aviationstack æŸ¥è³‡æ–™ ======
    async function fetchFlightInfoByNumber(flightNo) {
      if (!AVIATIONSTACK_KEY || AVIATIONSTACK_KEY === "YOUR_ACCESS_KEY_HERE") {
        throw new Error("å°šæœªè¨­å®š Aviationstack API Key");
      }

      const cleanNo = flightNo.trim().toUpperCase().replace(/\s+/g, "");
      if (!cleanNo) {
        throw new Error("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿ");
      }

      const url =
        "https://api.aviationstack.com/v1/flights" +
        "?access_key=" + encodeURIComponent(AVIATIONSTACK_KEY) +
        "&flight_iata=" + encodeURIComponent(cleanNo) +
        "&limit=1";

      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("æŸ¥è©¢å¤±æ•—ï¼ŒHTTP " + res.status);
      }

      const data = await res.json();
      if (!data || !data.data || data.data.length === 0) {
        throw new Error("æŸ¥ç„¡æ­¤èˆªç­ï¼ˆå¯èƒ½æ˜¯æ—¥æœŸä¸ç¬¦æˆ–å…è²»æ–¹æ¡ˆè³‡æ–™æœ‰é™ï¼‰");
      }

      const f = data.data[0];
      const dep = f.departure || {};
      const arr = f.arrival || {};

      let depDate = "";
      let depTime = "";
      if (dep.scheduled) {
        depDate = dep.scheduled.substring(0, 10);
        depTime = dep.scheduled.substring(11, 16);
      }

      return {
        from: dep.iata || dep.airport || "",
        to: arr.iata || arr.airport || "",
        date: depDate,
        time: depTime,
        status: f.flight_status || ""
      };
    }

    // ====== Header èˆ‡æ—…ç¨‹è¨­å®š ======
    const tripNameInput = document.getElementById("tripNameInput");
    const destinationInput = document.getElementById("destinationInput");
    const currencyInput = document.getElementById("currencyInput");
    const startDateInput = document.getElementById("startDateInput");
    const daysInput = document.getElementById("daysInput");
    const applyTripBtn = document.getElementById("applyTripBtn");
    const resetBtn = document.getElementById("resetBtn");
    const tripSelect = document.getElementById("tripSelect");
    const newTripBtn = document.getElementById("newTripBtn");
    const deleteTripBtn = document.getElementById("deleteTripBtn");

    const destinationTag = document.getElementById("destinationTag");
    const tripNameText = document.getElementById("tripNameText");
    const dateInfoText = document.getElementById("dateInfoText");
    const rateInfoText = document.getElementById("rateInfoText");
    const mainView = document.getElementById("mainView");

    function renderHeader() {
      const trip = getCurrentTrip();
      tripNameText.textContent = trip.name || "æœªå‘½åæ—…ç¨‹";
      destinationTag.textContent = trip.destination || "æœªè¨­å®šç›®çš„åœ°";

      if (trip.startDate && trip.daysCount) {
        const start = new Date(trip.startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + trip.daysCount - 1);
        const info =
          `${trip.daysCount} å¤©è¡Œç¨‹ï½œ` +
          `${formatDateMMDD(trip.startDate)} - ` +
          `${formatDateMMDD(end.toISOString().substring(0, 10))}`;
        dateInfoText.textContent = info;
      } else {
        dateInfoText.textContent = "è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸";
      }

      // åŒ¯ç‡é¡¯ç¤º
      if (trip.fxRate && trip.fxBase === trip.currency) {
        const dStr = formatDateYYYYMMDDFromUtc(trip.fxUpdatedAt);
        let text = `åŒ¯ç‡ï¼š1 ${trip.fxBase} â‰ˆ ${trip.fxRate.toFixed(2)} TWD`;
        if (dStr) text += `ï¼ˆ${dStr}ï¼‰`;
        rateInfoText.textContent = text;
      } else {
        rateInfoText.textContent = "åŒ¯ç‡å°šæœªè¨­å®š";
      }
    }

    function initTripInputs() {
      const trip = getCurrentTrip();
      tripNameInput.value = trip.name || "";
      destinationInput.value = trip.destination || "";
      currencyInput.value = trip.currency || "JPY";
      startDateInput.value = trip.startDate || "";
      daysInput.value = trip.daysCount || 4;
    }

    function renderTripSelector() {
      const current = getCurrentTrip();
      tripSelect.innerHTML = "";
      root.trips.forEach(trip => {
        const opt = document.createElement("option");
        opt.value = trip.id;
        opt.textContent = trip.name || "æœªå‘½åæ—…ç¨‹";
        if (trip.id === current.id) opt.selected = true;
        tripSelect.appendChild(opt);
      });
    }

    tripSelect.addEventListener("change", () => {
      root.activeTripId = tripSelect.value;
      initTripInputs();
      renderHeader();
      renderCurrentMainView();
      saveRoot();
    });

    newTripBtn.addEventListener("click", () => {
      const name = "æ–°æ—…ç¨‹ " + (root.trips.length + 1);
      const trip = createEmptyTrip(name);
      regenerateDays(trip);
      root.trips.push(trip);
      root.activeTripId = trip.id;
      saveRoot();
      initTripInputs();
      renderCurrentMainView();
    });

    deleteTripBtn.addEventListener("click", () => {
      if (root.trips.length <= 1) {
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹ï¼Œç„¡æ³•å…¨éƒ¨åˆªå…‰ã€‚");
        return;
      }
      const trip = getCurrentTrip();
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${trip.name}ã€é€™å€‹æ—…ç¨‹å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) return;
      root.trips = root.trips.filter(t => t.id !== trip.id);
      root.activeTripId = root.trips[0].id;
      saveRoot();
      initTripInputs();
      renderCurrentMainView();
    });

    applyTripBtn.addEventListener("click", () => {
      const trip = getCurrentTrip();
      trip.name = tripNameInput.value.trim() || "æœªå‘½åæ—…ç¨‹";
      trip.destination = destinationInput.value.trim();
      trip.currency = currencyInput.value;
      trip.startDate = startDateInput.value;
      let n = parseInt(daysInput.value, 10);
      if (isNaN(n)) n = 1;
      trip.daysCount = Math.max(1, Math.min(30, n));
      regenerateDays(trip);
      saveRoot();
      renderCurrentMainView();
    });

    resetBtn.addEventListener("click", () => {
      const trip = getCurrentTrip();
      if (!confirm(`æ¸…ç©ºã€Œ${trip.name}ã€é€™å€‹æ—…ç¨‹å…§çš„æ‰€æœ‰è³‡æ–™ï¼Ÿ`)) return;
      const newTrip = createEmptyTrip(trip.name);
      newTrip.id = trip.id;
      newTrip.currency = trip.currency;
      newTrip.startDate = trip.startDate;
      newTrip.daysCount = trip.daysCount;
      regenerateDays(newTrip);
      const idx = root.trips.findIndex(t => t.id === trip.id);
      root.trips[idx] = newTrip;
      saveRoot();
      initTripInputs();
      renderCurrentMainView();
    });

    // ====== åº•éƒ¨ Tab æ§åˆ¶ ======
    let currentTab = "itinerary";
    const bottomTabs = document.querySelectorAll(".bottom-tab");

    bottomTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const t = tab.getAttribute("data-tab");
        if (t === currentTab) return;
        currentTab = t;
        bottomTabs.forEach(tb => tb.classList.toggle("active", tb === tab));
        renderCurrentMainView();
      });
    });

    // ====== è¡Œç¨‹ Tab ======
    function renderItineraryView() {
      const trip = getCurrentTrip();

      if (!trip.days || trip.days.length === 0) {
        mainView.innerHTML =
          `<section class="card"><div class="empty">è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šæ—…ç¨‹æ—¥æœŸèˆ‡å¤©æ•¸</div></section>`;
        return;
      }

      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">æ¯æ—¥è¡Œç¨‹</div>
            <div class="pill">
              <span>ğŸ“</span>
              <span>${trip.destination || "ç›®çš„åœ°æœªè¨­å®š"}</span>
            </div>
          </div>

          <div class="small-label">è¡Œå‰æº–å‚™ï¼ˆæ­¤æ—…ç¨‹ï¼‰</div>
          <div class="row">
            <div class="col">
              <input id="prepInput_inline" placeholder="ä¾‹å¦‚ï¼šè¾¦æ—…éŠä¿éšªã€æ›å¤–å¹£ã€è²·ç¶²å¡â€¦" />
            </div>
            <button class="btn btn-primary btn-icon" id="addPrepBtn_inline">ï¼‹</button>
          </div>
          <div id="prepList_inline" style="margin-bottom:8px;"></div>

          <hr style="border:none;border-top:1px solid #e5e7eb;margin:6px 0 10px;">

          <div class="day-chips">
      `;

      trip.days.forEach(d => {
        const isActive = d.id === trip.activeDayId;
        html += `
          <div class="chip ${isActive ? "active" : ""}" data-day-id="${d.id}">
            <strong>${d.label}</strong>
            <span>${formatDateMMDD(d.date)}</span>
          </div>
        `;
      });

      html += `
          </div>
          <div id="dayContent"></div>
        </section>
      `;

      mainView.innerHTML = html;

      // è¡Œå‰æ¸…å–®ï¼ˆå…§åµŒï¼‰
      renderPrepList(trip, "prepList_inline");

      document.getElementById("addPrepBtn_inline").addEventListener("click", () => {
        const input = document.getElementById("prepInput_inline");
        const text = input.value.trim();
        if (!text) return;
        trip.checklist.push({
          id: generateId("prep"),
          text,
          done: false
        });
        input.value = "";
        saveRoot();
        renderItineraryView(); // é‡æ–°ç•«ï¼Œè®“å‹¾é¸ç‹€æ…‹ä¹Ÿæ›´æ–°
      });

      document.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const id = chip.getAttribute("data-day-id");
          trip.activeDayId = id;
          saveRoot();
          renderItineraryView();
        });
      });

      renderDayItinerary(trip);
    }

    function renderDayItinerary(trip) {
      const container = document.getElementById("dayContent");
      const dayId = trip.activeDayId || (trip.days[0] && trip.days[0].id);
      if (!dayId) {
        container.innerHTML = `<div class="empty">å°šæœªå»ºç«‹è¡Œç¨‹æ—¥</div>`;
        return;
      }

      const list = trip.itinerary[dayId] || [];
      let listHtml = "";

      if (list.length === 0) {
        listHtml = `<div class="empty">é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œä¸‹é¢å¯ä»¥æ–°å¢ä¸€ç­†ï½</div>`;
      } else {
        listHtml = `<div class="list">`;
        list.forEach(item => {
          const query = encodeURIComponent(item.title || item.note || "");
          const mapUrl = query
            ? `https://www.google.com/maps/search/?api=1&query=${query}`
            : "";

          listHtml += `
            <div class="list-item">
              <div class="list-main">
                <div class="list-meta">${item.time || "æ™‚é–“æœªå¡«å¯«"}</div>
                <div class="list-title">${item.title || "æœªå‘½åè¡Œç¨‹"}</div>
                ${item.note ? `<div class="list-note">${item.note}</div>` : ""}
              </div>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <button class="btn btn-ghost btn-sm" data-map="${item.id}" ${mapUrl ? "" : "disabled"}>
                  åœ°åœ–
                </button>
                <button class="btn btn-danger btn-icon" data-del-itinerary="${item.id}">âœ•</button>
              </div>
            </div>
          `;
        });
        listHtml += `</div>`;
      }

      const formHtml = `
        <div style="margin-top:10px;">
          <div class="small-label">æ–°å¢è¡Œç¨‹é …ç›®</div>
          <div class="row">
            <div class="col">
              <input id="itTime" placeholder="æ™‚é–“ï¼ˆä¾‹å¦‚ 09:00ï¼‰" />
            </div>
            <div class="col">
              <input id="itTitle" placeholder="è¡Œç¨‹åç¨±ï¼ˆä¾‹å¦‚ï¼šç¾…æµ®å®®ï¼‰" />
            </div>
          </div>
          <textarea id="itNote" placeholder="å‚™è¨»ï¼ˆäº¤é€šæ–¹å¼ã€é–€ç¥¨ç­‰ï¼Œå¯ç•™ç™½ï¼‰"></textarea>
          <div style="margin-top:8px; text-align:right;">
            <button class="btn btn-primary" id="addItineraryBtn">ï¼‹ æ–°å¢è¡Œç¨‹</button>
          </div>
        </div>
      `;

      container.innerHTML = listHtml + formHtml;

      document.getElementById("addItineraryBtn").addEventListener("click", () => {
        const time = document.getElementById("itTime").value.trim();
        const title = document.getElementById("itTitle").value.trim();
        const note = document.getElementById("itNote").value.trim();
        if (!title && !time && !note) return;

        const item = {
          id: generateId("it"),
          time,
          title: title || "æœªå‘½åè¡Œç¨‹",
          note
        };
        if (!trip.itinerary[dayId]) trip.itinerary[dayId] = [];
        trip.itinerary[dayId].push(item);
        saveRoot();
        renderDayItinerary(trip);
      });

      container.querySelectorAll("[data-del-itinerary]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del-itinerary");
          trip.itinerary[dayId] = (trip.itinerary[dayId] || []).filter(i => i.id !== id);
          saveRoot();
          renderDayItinerary(trip);
        });
      });

      container.querySelectorAll("[data-map]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-map");
          const target = (trip.itinerary[dayId] || []).find(i => i.id === id);
          if (!target) return;
          const q = encodeURIComponent(target.title || target.note || "");
          if (!q) {
            alert("æ­¤è¡Œç¨‹æ²’æœ‰åç¨±æˆ–å‚™è¨»ï¼Œç„¡æ³•é–‹å•Ÿåœ°åœ–ã€‚");
            return;
          }
          const url = `https://www.google.com/maps/search/?api=1&query=${q}`;
          window.open(url, "_blank");
        });
      });
    }

    // ====== è¡Œå‰ Tab ======
    function renderPrepView() {
      const trip = getCurrentTrip();
      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">è¡Œå‰æº–å‚™æ¸…å–®</div>
          </div>

          <div style="margin-bottom:10px;">
            <div class="small-label">æ–°å¢ä¸€é …è¡Œå‰æº–å‚™</div>
            <div class="row">
              <div class="col">
                <input id="prepInput" placeholder="ä¾‹å¦‚ï¼šè¾¦æ—…éŠä¿éšªã€æ›å¤–å¹£ã€è²·ç¶²å¡â€¦" />
              </div>
              <button class="btn btn-primary btn-icon" id="addPrepBtn">ï¼‹</button>
            </div>
          </div>

          <div id="prepList"></div>
        </section>
      `;
      mainView.innerHTML = html;
      renderPrepList(trip, "prepList");

      document.getElementById("addPrepBtn").addEventListener("click", () => {
        const input = document.getElementById("prepInput");
        const text = input.value.trim();
        if (!text) return;
        trip.checklist.push({
          id: generateId("prep"),
          text,
          done: false
        });
        input.value = "";
        saveRoot();
        renderPrepView();
      });
    }

    function renderPrepList(trip, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (!trip.checklist || trip.checklist.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è¡Œå‰å¾…è¾¦ï¼Œå¯ä»¥å…ˆæ–°å¢ã€‚</div>`;
        return;
      }

      let html = "";
      trip.checklist.forEach(item => {
        html += `
          <div class="check-row">
            <input type="checkbox" data-prep-id="${item.id}" ${item.done ? "checked" : ""}/>
            <div class="check-text ${item.done ? "done" : ""}">${item.text}</div>
            <button class="btn btn-danger btn-icon" data-prep-del="${item.id}">âœ•</button>
          </div>
        `;
      });

      container.innerHTML = html;

      container.querySelectorAll("[data-prep-id]").forEach(cb => {
        cb.addEventListener("change", () => {
          const id = cb.getAttribute("data-prep-id");
          const target = trip.checklist.find(i => i.id === id);
          if (target) {
            target.done = cb.checked;
            saveRoot();
            renderPrepList(trip, containerId);
          }
        });
      });

      container.querySelectorAll("[data-prep-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-prep-del");
          trip.checklist = trip.checklist.filter(i => i.id !== id);
          saveRoot();
          renderPrepList(trip, containerId);
        });
      });
    }

    // ====== èˆªç­ Tab ======
    function renderFlightsView() {
      const trip = getCurrentTrip();
      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">èˆªç­è³‡è¨Š</div>
          </div>
          <div id="flightList"></div>

          <div style="margin-top:10px;">
            <div class="small-label">æ–°å¢èˆªç­</div>
            <div class="row">
              <div class="col">
                <input type="date" id="flightDate" />
              </div>
              <div class="col">
                <input id="flightNo" placeholder="ç­æ©Ÿè™Ÿï¼ˆä¾‹å¦‚ï¼šBR87ï¼‰" />
              </div>
            </div>

            <div style="margin:4px 0 8px; text-align:right;">
              <button class="btn btn-ghost btn-sm" id="fillFlightFromApiBtn">
                ç”±èˆªç­è³‡æ–™åº«å¸¶å…¥
              </button>
            </div>

            <div class="row">
              <div class="col">
                <input id="flightFrom" placeholder="å‡ºç™¼åœ°ï¼ˆä¾‹å¦‚ï¼šTPEï¼‰" />
              </div>
              <div class="col">
                <input id="flightTo" placeholder="æŠµé”åœ°ï¼ˆä¾‹å¦‚ï¼šCDGï¼‰" />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <input id="flightTime" placeholder="èµ·é£›æ™‚é–“ï¼ˆä¾‹å¦‚ï¼š23:40ï¼‰" />
              </div>
              <div class="col">
                <input id="flightNote" placeholder="å‚™è¨»ï¼ˆå»ç¨‹ï¼å›ç¨‹â€¦ï¼‰" />
              </div>
            </div>
            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addFlightBtn">ï¼‹ æ–°å¢èˆªç­</button>
            </div>
          </div>
        </section>
      `;

      mainView.innerHTML = html;
      renderFlightList(trip);

      const fillBtn = document.getElementById("fillFlightFromApiBtn");
      fillBtn.addEventListener("click", async () => {
        const noInput = document.getElementById("flightNo");
        const fromInput = document.getElementById("flightFrom");
        const toInput = document.getElementById("flightTo");
        const timeInput = document.getElementById("flightTime");
        const noteInput = document.getElementById("flightNote");
        const dateInput = document.getElementById("flightDate");

        const flightNo = noInput.value;

        if (!flightNo.trim()) {
          alert("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿï¼Œä¾‹å¦‚ BR87");
          return;
        }

        fillBtn.disabled = true;
        const originalText = fillBtn.textContent;
        fillBtn.textContent = "æŸ¥è©¢ä¸­â€¦";

        try {
          const info = await fetchFlightInfoByNumber(flightNo);

          if (info.from) fromInput.value = info.from;
          if (info.to) toInput.value = info.to;
          if (info.time) timeInput.value = info.time;
          if (info.date && !dateInput.value) dateInput.value = info.date;

          if (info.status) {
            if (!noteInput.value) {
              noteInput.value = "ç‹€æ…‹ï¼š" + info.status;
            } else if (!noteInput.value.includes("ç‹€æ…‹ï¼š")) {
              noteInput.value += "ï¼ˆç‹€æ…‹ï¼š" + info.status + "ï¼‰";
            }
          }
        } catch (err) {
          console.error(err);
          alert("æŸ¥è©¢å¤±æ•—ï¼šã€Œ" + err.message + "ã€\n\nå¯èƒ½åŸå› ï¼šç­æ©Ÿè™ŸéŒ¯èª¤ã€æ—¥æœŸä¸ç¬¦ã€æˆ–è¶…éå…è²»é¡åº¦ã€‚");
        } finally {
          fillBtn.disabled = false;
          fillBtn.textContent = originalText;
        }
      });

      document.getElementById("addFlightBtn").addEventListener("click", () => {
        const date = document.getElementById("flightDate").value;
        const no = document.getElementById("flightNo").value.trim();
        const from = document.getElementById("flightFrom").value.trim();
        const to = document.getElementById("flightTo").value.trim();
        const time = document.getElementById("flightTime").value.trim();
        const note = document.getElementById("flightNote").value.trim();
        if (!no && !from && !to) return;

        trip.flights.push({
          id: generateId("fl"),
          date,
          flightNo: no || "",
          from,
          to,
          time,
          note
        });
        saveRoot();
        renderFlightsView();
      });
    }

    function renderFlightList(trip) {
      const container = document.getElementById("flightList");
      if (!trip.flights || trip.flights.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰å°šæœªæ–°å¢èˆªç­ã€‚</div>`;
        return;
      }

      let html = "";
      trip.flights
        .slice()
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
        .forEach(f => {
          const dateText = f.date ? formatDateMMDD(f.date) : "";
          const timeText = f.time || "";
          const fromCode = f.from || "???";
          const toCode = f.to || "???";
          const note = f.note || "";

          html += `
            <div class="flight-card-wrap">
              <div class="flight-card">
                <button class="flight-delete-btn" data-fl-del="${f.id}">âœ•</button>
                <div class="flight-card-top">
                  <div class="flight-card-top-left">
                    ${dateText ? dateText : ""}${timeText ? " Â· " + timeText : ""}
                  </div>
                  <div class="flight-card-top-right">
                    FLIGHT${f.flightNo ? " Â· " + f.flightNo : ""}
                  </div>
                </div>
                <div class="flight-card-main">
                  <div>
                    <div class="flight-airport">${fromCode}</div>
                    <div class="flight-airport-label">FROM</div>
                  </div>
                  <div class="flight-plane-icon">âœˆï¸</div>
                  <div style="text-align:right;">
                    <div class="flight-airport">${toCode}</div>
                    <div class="flight-airport-label">TO</div>
                  </div>
                </div>
                <div class="flight-card-bottom">
                  ${note ? `<div class="flight-card-note">${note}</div>` : ""}
                </div>
              </div>
            </div>
          `;
        });

      container.innerHTML = html;

      container.querySelectorAll("[data-fl-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-fl-del");
          trip.flights = trip.flights.filter(f => f.id !== id);
          saveRoot();
          renderFlightsView();
        });
      });
    }

    // ====== è¨˜å¸³ Tab ======
    function renderExpensesView() {
      const trip = getCurrentTrip();
      const cur = trip.currency || "JPY";

      const total = trip.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const cash = trip.expenses
        .filter(e => e.method === "cash")
        .reduce((s, e) => s + (e.amount || 0), 0);
      const card = trip.expenses
        .filter(e => e.method === "card")
        .reduce((s, e) => s + (e.amount || 0), 0);

      let rateInfoTextHtml = "ç›®å‰å°šæœªè¨­å®šåŒ¯ç‡ï¼ˆè‹¥ä¸»è¦è²¨å¹£ç‚º TWD å‰‡ä¸éœ€è¨­å®šï¼‰";
      if (trip.fxRate && trip.fxBase === cur) {
        const dStr = formatDateYYYYMMDDFromUtc(trip.fxUpdatedAt);
        rateInfoTextHtml =
          `ç›®å‰åŒ¯ç‡ï¼š1 ${trip.fxBase} â‰ˆ ${trip.fxRate.toFixed(2)} TWD` +
          (dStr ? `ï¼ˆæ›´æ–°ï¼š${dStr}ï¼‰` : "");
      }

      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">æ—…è²»ç®¡ç†</div>
          </div>

          <div style="margin-bottom:10px;">
            <div class="small-label">åŒ¯ç‡è¨­å®šï¼ˆ${cur} âœ TWDï¼‰</div>
            <div class="row">
              <div class="col">
                <input type="number" id="fxInput" step="0.01" placeholder="1 ${cur} = ? TWD" />
              </div>
              <button class="btn btn-ghost btn-sm" id="fxFetchBtn">æŸ¥è©¢åŒ¯ç‡</button>
              <button class="btn btn-primary btn-sm" id="fxSaveBtn">å„²å­˜åŒ¯ç‡</button>
            </div>
            <div class="small-label" id="fxInfo">
              ${rateInfoTextHtml}
            </div>
          </div>

          <div>
            <div class="summary-row"><span>ç¸½æ”¯å‡º</span><strong>${formatAmount(total, cur)}</strong></div>
            <div class="summary-row"><span>ç¾é‡‘</span><strong>${formatAmount(cash, cur)}</strong></div>
            <div class="summary-row"><span>ä¿¡ç”¨å¡</span><strong>${formatAmount(card, cur)}</strong></div>
          </div>

          <div style="margin-top:10px;">
            <div class="small-label">æ–°å¢ä¸€ç­†æ”¯å‡º</div>
            <div class="row">
              <div class="col">
                <input type="date" id="expDate" />
              </div>
              <div class="col">
                <select id="expMethod">
                  <option value="cash">ç¾é‡‘</option>
                  <option value="card">ä¿¡ç”¨å¡</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <input id="expAmount" type="number" placeholder="é‡‘é¡" />
              </div>
              <div class="col">
                <input id="expCategory" placeholder="åˆ†é¡ï¼ˆé¤é£²ã€äº¤é€šâ€¦ï¼‰" />
              </div>
            </div>
            <input id="expNote" placeholder="å‚™è¨»ï¼ˆåº—åã€åˆ·å“ªå¼µå¡â€¦ï¼‰" />
            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addExpenseBtn">ï¼‹ æ–°å¢æ”¯å‡º</button>
            </div>
          </div>

          <div style="margin-top:10px;" id="expenseList"></div>
        </section>
      `;

      mainView.innerHTML = html;

      // åŒ¯ç‡æŒ‰éˆ•
      document.getElementById("fxFetchBtn").addEventListener("click", async () => {
        const btn = document.getElementById("fxFetchBtn");
        const input = document.getElementById("fxInput");
        const info = document.getElementById("fxInfo");
        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = "æŸ¥è©¢ä¸­â€¦";
        try {
          const result = await fetchFxRate(cur);
          input.value = result.rate.toFixed(2);
          info.textContent =
            `ç›®å‰åŒ¯ç‡ï¼š1 ${cur} â‰ˆ ${result.rate.toFixed(2)} TWDï¼ˆæ›´æ–°ï¼š${formatDateYYYYMMDDFromUtc(result.updatedAt)}ï¼‰`;
          const trip = getCurrentTrip();
          trip.fxBase = cur;
          trip.fxRate = result.rate;
          trip.fxUpdatedAt = result.updatedAt;
          saveRoot();
        } catch (err) {
          alert("åŒ¯ç‡æŸ¥è©¢å¤±æ•—ï¼šã€Œ" + err.message + "ã€");
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });

      document.getElementById("fxSaveBtn").addEventListener("click", () => {
        const input = document.getElementById("fxInput");
        const v = parseFloat(input.value);
        if (isNaN(v) || v <= 0) {
          alert("è«‹è¼¸å…¥æ­£ç¢ºçš„åŒ¯ç‡æ•¸å­—");
          return;
        }
        const trip = getCurrentTrip();
        trip.fxBase = cur;
        trip.fxRate = v;
        trip.fxUpdatedAt = new Date().toISOString();
        saveRoot();
        renderExpensesView();
      });

      renderExpenseList(trip);

      document.getElementById("addExpenseBtn").addEventListener("click", () => {
        const date = document.getElementById("expDate").value;
        const method = document.getElementById("expMethod").value;
        const amountRaw = document.getElementById("expAmount").value;
        const category = document.getElementById("expCategory").value.trim();
        const note = document.getElementById("expNote").value.trim();

        const amount = parseFloat(amountRaw);
        if (isNaN(amount)) return;

        trip.expenses.push({
          id: generateId("exp"),
          date,
          method,
          amount,
          category,
          note
        });
        saveRoot();
        renderExpensesView();
      });
    }

    function renderExpenseList(trip) {
      const container = document.getElementById("expenseList");
      if (!trip.expenses || trip.expenses.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„ã€‚</div>`;
        return;
      }
      const cur = trip.currency || "JPY";

      let html = `<div class="list">`;
      trip.expenses
        .slice()
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
        .forEach(e => {
          let methodLabel = "å…¶ä»–";
          if (e.method === "cash") methodLabel = "ç¾é‡‘";
          if (e.method === "card") methodLabel = "ä¿¡ç”¨å¡";
          html += `
            <div class="list-item">
              <div class="list-main">
                <div class="list-meta">${e.date ? formatDateMMDD(e.date) : ""}</div>
                <div class="list-title">
                  ${e.category || "æœªåˆ†é¡"} 
                  <span class="badge">${methodLabel}</span>
                  <span class="badge">${formatAmount(e.amount, cur)}</span>
                </div>
                ${e.note ? `<div class="list-note">${e.note}</div>` : ""}
              </div>
              <button class="btn btn-danger btn-icon" data-exp-del="${e.id}">âœ•</button>
            </div>
          `;
        });
      html += `</div>`;
      container.innerHTML = html;

      container.querySelectorAll("[data-exp-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-exp-del");
          trip.expenses = trip.expenses.filter(e => e.id !== id);
          saveRoot();
          renderExpensesView();
        });
      });
    }

    // ====== è³¼ç‰© Tab ======
    function renderShoppingView() {
      const trip = getCurrentTrip();
      const cur = trip.currency || "JPY";
      const totalPlan = trip.shopping.reduce((s, i) => s + (i.price || 0), 0);
      const totalBought = trip.shopping
        .filter(i => i.bought)
        .reduce((s, i) => s + (i.price || 0), 0);

      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">è³¼ç‰©æ¸…å–®</div>
          </div>
          <div>
            <div class="summary-row"><span>è¨ˆç•«è³¼ç‰©ç¸½é¡</span><strong>${formatAmount(totalPlan, cur)}</strong></div>
            <div class="summary-row"><span>å·²è³¼è²·é‡‘é¡</span><strong>${formatAmount(totalBought, cur)}</strong></div>
          </div>

          <div style="margin-top:10px;">
            <div class="small-label">æ–°å¢è³¼ç‰©é …ç›®</div>
            <input id="shopName" placeholder="å“é …åç¨±ï¼ˆä¾‹å¦‚ï¼šCEZANNE 101 è™Ÿå”‡è†ï¼‰" />
            <div class="row" style="margin-top:4px;">
              <div class="col">
                <input id="shopPrice" type="number" placeholder="åƒ¹æ ¼ï¼ˆ${cur}ï¼‰å¯ç•™ç™½" />
              </div>
              <div class="col">
                <input id="shopNote" placeholder="å‚™è¨»ï¼ˆåº—å®¶ã€è‰²è™Ÿâ€¦ï¼‰" />
              </div>
            </div>
            <div style="margin-top:8px; text-align:right;">
              <button class="btn btn-primary" id="addShopBtn">ï¼‹ æ–°å¢å“é …</button>
            </div>
          </div>

          <div style="margin-top:10px;" id="shopList"></div>
        </section>
      ";

      mainView.innerHTML = html;
      renderShopList(trip);

      document.getElementById("addShopBtn").addEventListener("click", () => {
        const name = document.getElementById("shopName").value.trim();
        const priceRaw = document.getElementById("shopPrice").value;
        const note = document.getElementById("shopNote").value.trim();
        if (!name && !note) return;
        const price = parseFloat(priceRaw);
        trip.shopping.push({
          id: generateId("shop"),
          name: name || "æœªå‘½åå“é …",
          price: isNaN(price) ? 0 : price,
          note,
          bought: false
        });
        saveRoot();
        renderShoppingView();
      });
    }

    function renderShopList(trip) {
      const container = document.getElementById("shopList");
      if (!trip.shopping || trip.shopping.length === 0) {
        container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è³¼ç‰©å“é …ã€‚</div>`;
        return;
      }
      const cur = trip.currency || "JPY";

      let html = `<div class="list">`;
      trip.shopping.forEach(item => {
        html += `
          <div class="list-item">
            <div class="list-main">
              <div class="list-title">
                ${item.name}
                ${item.bought ? `<span class="badge">å·²è³¼è²·</span>` : ""}
                ${item.price ? `<span class="badge">${formatAmount(item.price, cur)}</span>` : ""}
              </div>
              ${item.note ? `<div class="list-note">${item.note}</div>` : ""}
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;">
              <button class="btn btn-ghost btn-sm" data-shop-toggle="${item.id}">
                ${item.bought ? "å–æ¶ˆå·²è²·" : "æ¨™è¨˜å·²è²·"}
              </button>
              <button class="btn btn-danger btn-icon" data-shop-del="${item.id}">âœ•</button>
            </div>
          </div>
        `;
      });
      html += `</div>`;
      container.innerHTML = html;

      container.querySelectorAll("[data-shop-toggle]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-shop-toggle");
          const target = trip.shopping.find(i => i.id === id);
          if (target) {
            target.bought = !target.bought;
            saveRoot();
            renderShoppingView();
          }
        });
      });

      container.querySelectorAll("[data-shop-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-shop-del");
          trip.shopping = trip.shopping.filter(i => i.id !== id);
          saveRoot();
          renderShoppingView();
        });
      });
    }

    // ====== ä¸»ç•«é¢åˆ‡æ› ======
    function renderCurrentMainView() {
      if (currentTab === "itinerary") {
        renderItineraryView();
      } else if (currentTab === "prep") {
        renderPrepView();
      } else if (currentTab === "flights") {
        renderFlightsView();
      } else if (currentTab === "expenses") {
        renderExpensesView();
      } else if (currentTab === "shopping") {
        renderShoppingView();
      }
    }

    // ====== åˆå§‹åŒ– ======
    (function init() {
      const trip = getCurrentTrip();
      if (!trip.days || trip.days.length === 0) {
        regenerateDays(trip);
      }
      renderTripSelector();
      initTripInputs();
      renderHeader();
      renderCurrentMainView();
    })();
  </script>
</body>
</html>
