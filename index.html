<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.prod.js"></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="app" class="max-w-md mx-auto bg-white shadow-lg min-h-screen relative overflow-hidden">

    <!-- å·¦ä¸Šä¸‰ç·šé¸å–® -->
    <div class="absolute top-4 left-4 z-30">
      <button @click="toggleMenu" class="text-3xl">â˜°</button>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <transition name="slide">
      <div v-if="menuOpen" class="absolute top-0 left-0 w-72 h-full bg-white shadow-lg z-40 p-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">æˆ‘çš„æ—…ç¨‹</h2>
          <button @click="toggleMenu" class="text-xl">âœ•</button>
        </div>
        <button
          @click="createTrip"
          class="w-full border-2 border-dashed border-teal-400 text-teal-600 py-2 rounded mb-4"
        >
          ï¼‹ å»ºç«‹æ–°æ—…ç¨‹
        </button>
        <div v-for="(t,i) in trips" :key="i"
          @click="selectTrip(i)"
          class="p-3 mb-2 rounded cursor-pointer"
          :class="{'bg-teal-50': currentTripIndex === i}">
          <div class="font-bold">{{ t.name || 'æœªå‘½åæ—…ç¨‹' }}</div>
          <div class="text-sm text-gray-500">{{ t.daysCount }} å¤© | {{ t.startDate }}</div>
        </div>
      </div>
    </transition>

    <!-- ä¸»å…§å®¹ -->
    <div class="p-6 mt-10">
      <h1 class="text-2xl font-bold mb-2">{{ currentTrip.name || 'æ–°æ—…ç¨‹' }}</h1>
      <div class="text-sm text-gray-500 mb-4">{{ currentTrip.daysCount }} å¤©è¡Œç¨‹ | {{ currentTrip.startDate }}</div>

      <!-- æ—¥æœŸåˆ‡æ› -->
      <div class="flex space-x-2 overflow-x-auto mb-4">
        <button
          v-for="(d,idx) in currentTrip.days"
          :key="idx"
          @click="currentDayIndex = idx"
          class="px-4 py-2 rounded-lg font-semibold"
          :class="currentDayIndex === idx ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
        >
          D{{ idx+1 }} {{ d.date }}
        </button>
      </div>

      <!-- å¤©æ°£ -->
      <div class="mb-3">
        <h3 class="font-semibold mb-1">ç•¶æ—¥å¤©æ°£</h3>
        <div id="dailyWeather" class="text-sm text-gray-600"></div>
      </div>

      <!-- åœ°åœ– -->
      <div>
        <h3 class="font-semibold mb-1">ç•¶æ—¥è¡Œç¨‹åœ°åœ–</h3>
        <div id="dailyMap" class="w-full h-64 rounded-lg overflow-hidden shadow"></div>
      </div>

      <!-- è¡Œç¨‹é …ç›® -->
      <div class="mt-4">
        <h3 class="font-semibold mb-2">è¡Œç¨‹å®‰æ’</h3>
        <div v-for="(item,i) in currentDay.items" :key="i" class="p-2 bg-gray-50 rounded mb-2">
          <div class="text-sm">{{ item.time }} - {{ item.place }}</div>
        </div>

        <div class="flex space-x-2 mt-2">
          <input v-model="newItem.time" placeholder="æ™‚é–“" class="border px-2 py-1 w-1/3 rounded text-sm" />
          <input v-model="newItem.place" placeholder="åœ°é»" class="border px-2 py-1 w-2/3 rounded text-sm" />
        </div>
        <button
          @click="addItem"
          class="mt-2 bg-blue-500 text-white text-sm px-4 py-1 rounded"
        >
          æ–°å¢è¡Œç¨‹
        </button>
      </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2 shadow-lg">
      <button class="text-center text-sm font-semibold text-blue-600">è¡Œç¨‹</button>
      <button class="text-center text-sm text-gray-500">èˆªç­</button>
      <button class="text-center text-sm text-gray-500">è¨˜å¸³</button>
      <button class="text-center text-sm text-gray-500">è³¼ç‰©</button>
    </div>
  </div>

  <!-- JS -->
  <script>
    const { createApp, onMounted, watch } = Vue;

    createApp({
      data() {
        return {
          menuOpen: false,
          trips: [
            {
              name: 'è·æ¯”æ³•10æ—¥éŠ',
              startDate: '2025/11/19',
              daysCount: 10,
              days: Array.from({ length: 10 }, (_, i) => ({
                date: `11/${19 + i}`,
                items: []
              }))
            }
          ],
          currentTripIndex: 0,
          currentDayIndex: 0,
          newItem: { time: '', place: '' }
        };
      },
      computed: {
        currentTrip() { return this.trips[this.currentTripIndex]; },
        currentDay() { return this.currentTrip.days[this.currentDayIndex]; }
      },
      methods: {
        toggleMenu() { this.menuOpen = !this.menuOpen; },
        selectTrip(i) { this.currentTripIndex = i; this.menuOpen = false; this.updateMapAndWeather(); },
        createTrip() {
          this.trips.push({
            name: 'æ–°æ—…ç¨‹ ' + (this.trips.length + 1),
            startDate: new Date().toISOString().split('T')[0],
            daysCount: 4,
            days: Array.from({ length: 4 }, (_, i) => ({
              date: new Date(Date.now() + i * 86400000).toLocaleDateString('zh-TW'),
              items: []
            }))
          });
        },
        addItem() {
          if (!this.newItem.place.trim()) return;
          this.currentDay.items.push({ ...this.newItem });
          this.newItem = { time: '', place: '' };
          this.updateMapAndWeather();
        },
        async updateMapAndWeather() {
          const dayData = this.currentDay;
          const mapContainerId = "dailyMap";
          const weatherContainerId = "dailyWeather";
          renderDailyMapAndWeather(dayData, mapContainerId, weatherContainerId);
        }
      },
      mounted() {
        this.updateMapAndWeather();
        watch(() => this.currentDayIndex, () => this.updateMapAndWeather());
      }
    }).mount("#app");


    // ===== ä»¥ä¸‹æ˜¯åœ°åœ–èˆ‡å¤©æ°£æ•´åˆ =====
    let geoCache = {}, mapInstance = null, markersLayer = null;

    async function geocodeLocation(name) {
      if (!name.trim()) return null;
      if (geoCache[name]) return geoCache[name];
      const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=zh_TW&format=json`);
      const data = await res.json();
      if (!data.results || !data.results.length) return null;
      const r = data.results[0];
      return geoCache[name] = { lat: r.latitude, lon: r.longitude, name: r.name, country: r.country };
    }

    async function fetchWeather(lat, lon) {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`);
      const data = await res.json();
      return { max: data.daily.temperature_2m_max[0], min: data.daily.temperature_2m_min[0], code: data.daily.weathercode[0] };
    }

    const weatherIcons = {
      0: "â˜€ï¸ æ™´å¤©", 1: "ğŸŒ¤ å°‘é›²", 2: "â›… å¤šé›²", 3: "â˜ï¸ é™°å¤©", 45: "ğŸŒ« éœ§",
      48: "ğŸŒ« å‡éœ§", 51: "ğŸŒ¦ æ¯›æ¯›é›¨", 61: "ğŸŒ§ å°é›¨", 63: "ğŸŒ§ ä¸­é›¨", 65: "ğŸŒ§ å¤§é›¨",
      71: "â„ï¸ å°é›ª", 73: "â„ï¸ ä¸­é›ª", 75: "â„ï¸ å¤§é›ª", 95: "â›ˆ é›·é›¨"
    };

    async function renderDailyMapAndWeather(dayData, mapContainerId, weatherContainerId) {
      const mapContainer = document.getElementById(mapContainerId);
      const weatherEl = document.getElementById(weatherContainerId);
      mapContainer.innerHTML = "";
      weatherEl.innerHTML = "";

      if (!dayData || !dayData.items.length) {
        mapContainer.innerHTML = `<div class="text-gray-500 text-sm text-center py-4">å°šæœªå®‰æ’åœ°é»</div>`;
        weatherEl.innerHTML = `<div class="text-gray-500 text-sm text-center py-2">ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™</div>`;
        return;
      }

      const geocodedPlaces = [];
      for (const item of dayData.items) {
        const loc = await geocodeLocation(item.place);
        if (loc) geocodedPlaces.push(loc);
      }

      mapInstance = L.map(mapContainer).setView([48.8566, 2.3522], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap" }).addTo(mapInstance);
      markersLayer = L.layerGroup().addTo(mapInstance);

      if (geocodedPlaces.length > 0) {
        geocodedPlaces.forEach(p => L.marker([p.lat, p.lon]).addTo(markersLayer).bindPopup(`${p.name}`));
        mapInstance.fitBounds(L.latLngBounds(geocodedPlaces.map(p => [p.lat, p.lon])), { padding: [40, 40] });

        const w = await fetchWeather(geocodedPlaces[0].lat, geocodedPlaces[0].lon);
        if (w) weatherEl.innerHTML = `<div class="bg-blue-50 p-2 rounded text-sm">${weatherIcons[w.code] || "ğŸŒ"} ${w.min}Â° / ${w.max}Â°</div>`;
      } else {
        weatherEl.innerHTML = `<div class="text-gray-500 text-sm text-center py-2">ç„¡æ³•å–å¾—åœ°é»åº§æ¨™</div>`;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          L.circleMarker([latitude, longitude], { radius: 5, color: "#007bff", fillColor: "#007bff", fillOpacity: 0.8 })
            .addTo(markersLayer)
            .bindPopup("ğŸ“ ç›®å‰ä½ç½®");
        });
      }
    }
  </script>
</body>
</html>
