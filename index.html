<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Planner</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --primary: #3b82f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 20px;
      --radius-md: 14px;
    }

    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif; }

    body {
      margin: 0;
      background: linear-gradient(180deg, #c5e0ff 0%, #f5f7ff 40%, #ffffff 100%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px 16px 84px;
      position: relative;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 10px;
    }

    .header-left { display:flex; align-items:flex-start; gap:10px; min-width: 0; flex: 1; }
    .menu-btn { border: none; background: transparent; font-size: 24px; cursor: pointer; padding: 4px 6px; color: #111827; flex-shrink: 0; }

    .title-wrap { min-width: 0; }
    .title { display:flex; align-items:center; gap:8px; font-size: 20px; font-weight: 700; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .subtitle { font-size: 12px; color: var(--text-sub); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tag {
      font-size: 10px; padding: 2px 8px; border-radius: 999px;
      background: rgba(59,130,246,.12); color: #1d4ed8;
      flex-shrink: 0; max-width: 120px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .icon-btn {
      width: 34px; height: 34px; border-radius: 999px; border: none;
      cursor: pointer; background: rgba(59,130,246,0.14);
      display:flex; align-items:center; justify-content:center; flex-shrink:0;
    }
    .icon-btn svg { width: 18px; height: 18px; fill: #1d4ed8; }

    .top-info { text-align: right; font-size: 11px; color: var(--text-sub); flex-shrink: 0; }
    .top-info-rate { margin-top: 2px; font-size: 11px; color: #1d4ed8; }
    .top-info-rate span { display: inline-block; padding: 2px 6px; border-radius: 999px; background: rgba(59,130,246,0.08); white-space: nowrap; }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 12px 14px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08);
      margin-bottom: 12px;
    }
    .card-header { display:flex; justify-content:space-between; align-items:center; gap: 8px; margin-bottom: 8px; }
    .card-title { font-size: 14px; font-weight: 600; }
    .small-label { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; display: block; }

    input, select, textarea {
      width: 100%; font-size: 16px; padding: 7px 9px;
      border-radius: 999px; border: 1px solid #e5e7eb;
      outline: none; background: #f9fafb; box-sizing: border-box; height: 40px;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #ffffff; }
    textarea { border-radius: 12px; resize: vertical; min-height: 52px; height: auto; }

    .row { display:flex; gap: 8px; margin-bottom: 6px; }
    .row > .col { flex: 1; }

    .btn {
      border-radius: 999px; border: none; font-size: 13px;
      padding: 7px 14px; cursor: pointer; display: inline-flex;
      align-items: center; gap: 6px; white-space: nowrap;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-ghost { background: #eef2ff; color: #4f46e5; }
    .btn-danger { background: #fee2e2; color: #b91c1c; }
    .btn-icon { width: 28px; height: 28px; padding: 0; justify-content:center; }
    .btn-sm { font-size: 12px; padding: 5px 10px; }

    .pill {
      display:inline-flex; align-items:center; gap: 6px; padding: 6px 10px;
      border-radius: 999px; background: #eff6ff; font-size: 11px; color: #1d4ed8;
      max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0;
    }

    .day-chips { display:flex; overflow-x: auto; gap: 8px; padding-bottom: 6px; margin-bottom: 6px; }
    .chip {
      min-width: 68px; padding: 6px 8px; border-radius: 16px;
      background: #eff6ff; font-size: 11px; text-align:center; cursor:pointer; color: #1d4ed8; flex-shrink: 0;
    }
    .chip strong { display:block; font-size: 13px; margin-bottom: 2px; }
    .chip.active { background: #1d4ed8; color: #eff6ff; }

    .inner-tabs{
      display:flex; gap:6px; background:#f3f4f6; border-radius:999px;
      padding:4px; margin-top: 6px;
    }
    .inner-tab{
      flex:1; border:none; border-radius:999px; padding:8px 0;
      font-size:13px; background:transparent; color:#6b7280; cursor:pointer;
    }
    .inner-tab.active{ background:#111827; color:#fff; }

    .list { margin-top: 6px; }
    .list-item {
      background: #f9fafb; border-radius: var(--radius-md);
      padding: 8px 10px; font-size: 13px; margin-bottom: 6px;
      display:flex; justify-content: space-between; align-items:flex-start; gap: 6px;
    }
    .list-main { flex: 1; min-width: 0; }
    .list-title { font-weight: 600; margin-bottom: 2px; }
    .list-meta { font-size: 11px; color: var(--text-sub); margin-bottom: 2px; }
    .list-note { font-size: 12px; color: #4b5563; white-space: pre-wrap; }

    .empty { font-size: 12px; color: var(--text-sub); text-align:center; padding: 12px 4px 4px; }

    .map-container { width: 100%; height: 340px; border-radius: 16px; overflow: hidden; background: #e5e7eb; }

    .weather-box {
      width: 100%; border-radius: 16px; padding: 8px 10px;
      background: #eff6ff; margin-bottom: 10px; font-size: 13px;
      color: #1f2933; display:flex; align-items:center; justify-content: space-between; gap: 8px;
    }
    .weather-main { display:flex; align-items:center; gap: 8px; }
    .weather-emoji { font-size: 22px; }
    .weather-temp { font-size: 16px; font-weight: 600; }
    .weather-sub { font-size: 11px; color: #6b7280; }
    .weather-loading { font-size: 12px; color: #6b7280; }

    /* Stickyï¼šæ¯æ—¥è¡Œç¨‹æ¬„ä½å›ºå®š */
    .itinerary-card { padding: 0; overflow: hidden; }
    .it-sticky{
      position: sticky; top: 0; z-index: 30;
      background: var(--card-bg);
      padding: 12px 14px 10px;
      border-bottom: 1px solid #eef2f7;
    }
    .it-body{ padding: 12px 14px 14px; }

    /* Autocomplete */
    .ac-wrap { position: relative; }
    .ac-list{
      position: absolute; left: 0; right: 0; top: 44px;
      background: #ffffff; border: 1px solid #e5e7eb; border-radius: 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.12);
      z-index: 9998; overflow: hidden;
    }
    .ac-item{ padding: 10px 10px; cursor: pointer; font-size: 14px; line-height: 1.25; border-bottom: 1px solid #f3f4f6; }
    .ac-item:last-child{ border-bottom: none; }
    .ac-item:hover{ background: #f3f4f6; }
    .ac-main{ font-weight: 600; color:#111827; }
    .ac-sub{ font-size: 12px; color:#6b7280; margin-top: 2px; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed; left: 0; right: 0; bottom: 0;
      max-width: 480px; margin: 0 auto;
      padding: 8px 16px 12px;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(18px);
      border-top: 1px solid rgba(209,213,219,.8);
      z-index: 9999;
    }
    .bottom-tabs { display:flex; background: #f3f4f6; border-radius: 999px; padding: 4px; gap: 4px; }
    .bottom-tab {
      flex: 1; text-align:center; font-size: 11px; padding: 6px 0 4px;
      border-radius: 999px; color: #6b7280; cursor: pointer; user-select: none;
    }
    .bottom-tab span{ display:block; font-size: 16px; margin-bottom: 2px; }
    .bottom-tab.active{ background: #111827; color:#f9fafb; }

    /* Leaflet z-index */
    .leaflet-container{ z-index: 1 !important; }
    .leaflet-control-container{ z-index: 2 !important; }
    .leaflet-pane, .leaflet-top, .leaflet-bottom{ z-index: 1 !important; }

    /* Drawer */
    .drawer-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.4); display:none; z-index: 40; }
    .drawer-backdrop.show { display:block; }
    .drawer {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 280px; max-width: 80%;
      background: #ffffff;
      box-shadow: 10px 0 30px rgba(15,23,42,.35);
      transform: translateX(-100%);
      transition: transform .25s ease-out;
      z-index: 50;
      padding: 16px 14px 24px;
      display:flex; flex-direction: column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawer-title{ font-size:16px; font-weight:600; margin-bottom: 12px; }
    .drawer-trip-list{ flex:1; overflow-y:auto; padding-right: 4px; }
    .drawer-trip{ border-radius: 12px; padding: 8px 10px; margin-bottom: 6px; background: #f3f4f6; cursor:pointer; font-size: 13px; }
    .drawer-trip.active{ background: #dbeafe; border: 1px solid #3b82f6; }
    .drawer-trip-name{ font-weight:600; }
    .drawer-trip-sub{ font-size:11px; color: var(--text-sub); margin-top:2px; }
    .drawer-footer{ margin-top: 8px; font-size: 11px; color: var(--text-sub); }
    .drawer-close{ position:absolute; right: 12px; top: 10px; border:none; background: transparent; font-size: 20px; cursor:pointer; color: #6b7280; }

    /* Modal / Bottom Sheet */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(15,23,42,.45);
      display:none; z-index: 20000; padding: 16px;
    }
    .modal-backdrop.show{ display:flex; align-items:flex-end; justify-content:center; }
    .modal{
      width: 100%; max-width: 480px; background: #ffffff;
      border-radius: 22px; box-shadow: 0 24px 70px rgba(15,23,42,.35);
      overflow: hidden;
    }
    .modal-header{
      padding: 12px 14px; display:flex; justify-content: space-between; align-items:center;
      border-bottom: 1px solid #eef2f7;
    }
    .modal-title{ font-size: 14px; font-weight: 700; }
    .modal-body{ padding: 12px 14px 14px; }
    .modal-footer{
      padding: 12px 14px 14px; display:flex; justify-content: space-between; gap: 10px;
      border-top: 1px solid #eef2f7; background: #fafafa;
    }
    .modal-desc{ font-size: 11px; color: var(--text-sub); margin-top: 6px; line-height: 1.35; }

    @media (min-width: 768px) {
      .app { margin-top: 12px; }
      .modal-backdrop.show{ align-items:center; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Drawer -->
    <div id="drawerBackdrop" class="drawer-backdrop"></div>
    <div id="tripDrawer" class="drawer">
      <button class="drawer-close" id="drawerCloseBtn">âœ•</button>
      <div class="drawer-title">æˆ‘çš„æ—…ç¨‹</div>
      <div id="drawerTripList" class="drawer-trip-list"></div>
      <button class="btn btn-ghost btn-sm" id="drawerNewTripBtn">ï¼‹ å»ºç«‹æ–°æ—…ç¨‹</button>
      <button class="btn btn-danger btn-sm" id="drawerDeleteTripBtn" style="margin-top:6px;">åˆªé™¤ç›®å‰æ—…ç¨‹</button>
      <div class="drawer-footer">åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œé©åˆåˆªé™¤æ¸¬è©¦ç”¨æ—…ç¨‹</div>
    </div>

    <!-- Trip Settings Modal -->
    <div id="tripModalBackdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-label="æ—…ç¨‹è¨­å®š">
        <div class="modal-header">
          <div class="modal-title">æ—…ç¨‹è¨­å®š</div>
          <button class="btn btn-ghost btn-sm" id="tripModalCloseBtn">é—œé–‰</button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col">
              <label class="small-label">æ—…ç¨‹åç¨±</label>
              <input id="m_tripName" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯ 4 æ—¥è‡ªç”±è¡Œ" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label class="small-label">ç›®çš„åœ°åŸå¸‚ / å€åŸŸ</label>
              <input id="m_destination" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯ã€å·´é»â€¦" />
            </div>
            <div class="col">
              <label class="small-label">ä¸»è¦è²¨å¹£</label>
              <select id="m_currency">
                <option value="KRW">KRW éŸ“å…ƒ</option>
                <option value="JPY">JPY æ—¥åœ“</option>
                <option value="TWD">TWD æ–°å°å¹£</option>
                <option value="HKD">HKD æ¸¯å¹£</option>
                <option value="USD">USD ç¾å…ƒ</option>
                <option value="EUR">EUR æ­å…ƒ</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label class="small-label">å‡ºç™¼æ—¥æœŸ</label>
              <input type="date" id="m_startDate" />
            </div>
            <div class="col">
              <label class="small-label">å¤©æ•¸</label>
              <input type="number" id="m_days" min="1" max="30" value="4" />
            </div>
          </div>

          <div class="modal-desc">è®Šæ›´ç›®çš„åœ°æœƒæ¸…é™¤åœ°é»åº§æ¨™å¿«å–ï¼Œä»¥é¿å…é‡˜é¸éŒ¯èª¤ã€‚</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="m_clearTripBtn">æ¸…ç©ºæœ¬æ—…ç¨‹è³‡æ–™</button>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost" id="m_cancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="m_saveBtn">å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Itinerary Modal -->
    <div id="itModalBackdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-label="æ–°å¢è¡Œç¨‹">
        <div class="modal-header">
          <div class="modal-title" id="itModalTitle">æ–°å¢è¡Œç¨‹</div>
          <button class="btn btn-ghost btn-sm" id="itModalCloseBtn">é—œé–‰</button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col">
              <label class="small-label">æ™‚é–“</label>
              <input id="itTime" type="time" />
            </div>
            <div class="col ac-wrap">
              <label class="small-label">åœ°é» / åœ°æ¨™ / åœ°å€</label>
              <input id="itTitle" placeholder="åƒ Google Map æœå°‹ä¸€æ¨£è¼¸å…¥" autocomplete="off" />
              <div id="acList" class="ac-list" style="display:none;"></div>
            </div>
          </div>
          <label class="small-label">å‚™è¨»ï¼ˆäº¤é€šæ–¹å¼ã€é–€ç¥¨ç­‰ï¼Œå¯ç•™ç™½ï¼‰</label>
          <textarea id="itNote" placeholder="å¯ç•™ç©º"></textarea>
          <div class="modal-desc">æç¤ºï¼šé¸å–å»ºè­°æ¸…å–®å¾Œï¼Œæœƒè‡ªå‹•è¨˜éŒ„åº§æ¨™ï¼Œåœ°åœ–é æœƒä¾ç•¶æ—¥è¡Œç¨‹è‡ªå‹•é‡˜é¸ã€‚</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="itModalDeleteBtn" style="display:none;">åˆªé™¤</button>
          <div style="display:flex;gap:8px;margin-left:auto;">
            <button class="btn btn-ghost" id="itModalCancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="itModalSaveBtn">å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Flight Modal -->
    <div id="flModalBackdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-label="æ–°å¢èˆªç­">
        <div class="modal-header">
          <div class="modal-title">æ–°å¢èˆªç­</div>
          <button class="btn btn-ghost btn-sm" id="flModalCloseBtn">é—œé–‰</button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col">
              <label class="small-label">ç­æ©Ÿè™Ÿ</label>
              <input id="flNo" placeholder="ä¾‹å¦‚ï¼šBR87" />
            </div>
            <div class="col" style="display:flex;flex-direction:column;">
              <label class="small-label">èµ·é£›æ™‚é–“</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="flTime" type="time" style="flex:1;" />
                <button class="btn btn-ghost btn-sm" id="flAutoTimeBtn" title="ä¾ç­æ©Ÿè™Ÿè‡ªå‹•å¸¶å…¥æ™‚é–“">è‡ªå‹•å¸¶å…¥</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="small-label">å‡ºç™¼åœ°</label>
              <input id="flFrom" placeholder="ä¾‹å¦‚ï¼šTPE" />
            </div>
            <div class="col">
              <label class="small-label">æŠµé”åœ°</label>
              <input id="flTo" placeholder="ä¾‹å¦‚ï¼šHKG" />
            </div>
          </div>

          <label class="small-label">å‚™è¨»</label>
          <input id="flNote" placeholder="ä¾‹å¦‚ï¼šå»ç¨‹ / å›ç¨‹ / èˆªå»ˆâ€¦" />

          <div class="modal-desc" id="flAutoHint">
            è‡ªå‹•å¸¶å…¥æ™‚é–“éœ€è¦ä½ åŸæœ¬çš„èˆªç­è³‡æ–™ä¾†æºï¼ˆAPI / è§£æé‚è¼¯ï¼‰ã€‚æ­¤ç‰ˆå·²ä¿ç•™æŒ‰éˆ•èˆ‡æµç¨‹ï¼Œä½ å¯ç›´æ¥æŠŠèˆŠç‰ˆæŸ¥è©¢ç¨‹å¼è²¼å› <code>fetchFlightTimeByNumber()</code>ã€‚
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" id="flModalCancelBtn">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="flModalSaveBtn">å„²å­˜èˆªç­</button>
        </div>
      </div>
    </div>

    <header>
      <div class="header-left">
        <button id="menuButton" class="menu-btn" aria-label="åˆ‡æ›æ—…ç¨‹">â˜°</button>
        <div class="title-wrap">
          <div class="title">
            <span>Trip Planner</span>
            <span class="tag" id="destinationTag">æœªè¨­å®šç›®çš„åœ°</span>
            <button class="icon-btn" id="editTripBtn" aria-label="ç·¨è¼¯æ—…ç¨‹è¨­å®š">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l9.06-9.06.92.92L5.92 20.08zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
              </svg>
            </button>
          </div>
          <div class="subtitle" id="tripNameText">æœªå‘½åæ—…ç¨‹</div>
        </div>
      </div>

      <div class="top-info">
        <div id="dateInfoText">è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸</div>
        <div class="top-info-rate" id="rateInfoText"></div>
      </div>
    </header>

    <div id="mainView"></div>
  </div>

  <!-- åº•éƒ¨å°èˆª -->
  <nav class="bottom-nav">
    <div class="bottom-tabs">
      <div class="bottom-tab active" data-tab="itinerary">
        <span>ğŸ§³</span>è¡Œç¨‹
      </div>
      <div class="bottom-tab" data-tab="expenses">
        <span>ğŸ’°</span>è¨˜å¸³
      </div>
      <div class="bottom-tab" data-tab="shopping">
        <span>ğŸ›</span>è³¼ç‰©
      </div>
    </div>
  </nav>

  <script>
    /* ========= åŒ¯ç‡ API ========= */
    async function fetchRateToTWD(baseCurrency) {
      const base = (baseCurrency || "").toUpperCase();
      if (!base) throw new Error("å°šæœªè¨­å®šä¸»è¦è²¨å¹£");
      if (base === "TWD") throw new Error("ä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æ›ç®—");
      const url = "https://open.er-api.com/v6/latest/" + encodeURIComponent(base);
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data || data.result !== "success") throw new Error("API result=" + (data?.result || "unknown"));
      if (!data.rates || typeof data.rates.TWD !== "number") throw new Error("API ç„¡ TWD åŒ¯ç‡");
      return { rate: data.rates.TWD, updatedAt: data.time_last_update_utc || "" };
    }

    /* ========= Storage / Data ========= */
    const STORAGE_KEY = "tripPlanner_multi_v6_modalAdd";
    let currentTab = "itinerary";
    let itineraryInnerTab = "plan"; // plan | map

    // itinerary modal state
    let itModalMode = "add"; // add | edit
    let itModalDayId = null;
    let itEditingId = null;
    let selectedPlaceForItinerary = null;

    // flight modal state
    let flModalDayDate = null;

    function createEmptyTrip(name) {
      return {
        id: "trip_" + Math.random().toString(36).slice(2, 9),
        name: name || "æ–°æ—…ç¨‹",
        destination: "",
        currency: "JPY",
        startDate: "",
        daysCount: 4,
        days: [],
        activeDayId: null,
        itinerary: {},
        flights: [],
        checklist: [],
        expenses: [],
        shopping: [],
        exchangeRate: { base: "JPY", target: "TWD", rate: null, updatedAt: "" },
        geo: null,
        placeCache: {},
        flightTimeCache: {} // key: `${date}|${flightNo}` => "HH:MM"
      };
    }
    function ensureTripShape(trip) {
      if (!trip.itinerary) trip.itinerary = {};
      if (!trip.flights) trip.flights = [];
      if (!trip.checklist) trip.checklist = [];
      if (!trip.expenses) trip.expenses = [];
      if (!trip.shopping) trip.shopping = [];
      if (!trip.exchangeRate) trip.exchangeRate = { base: trip.currency || "JPY", target: "TWD", rate: null, updatedAt: "" };
      if (!trip.placeCache) trip.placeCache = {};
      if (!trip.flightTimeCache) trip.flightTimeCache = {};
    }

    function loadRoot() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(trip);
          return { trips: [trip], activeTripId: trip.id };
        }
        const obj = JSON.parse(raw);
        if (!obj.trips || !Array.isArray(obj.trips) || obj.trips.length === 0) {
          const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
          regenerateDays(trip);
          return { trips: [trip], activeTripId: trip.id };
        }
        obj.trips.forEach(ensureTripShape);
        return obj;
      } catch (e) {
        console.error(e);
        const trip = createEmptyTrip("æ–°æ—…ç¨‹ 1");
        regenerateDays(trip);
        return { trips: [trip], activeTripId: trip.id };
      }
    }

    let root = loadRoot();

    function saveRoot() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(root));
      renderHeader();
      renderDrawerTrips();
    }

    function getCurrentTrip() {
      let t = root.trips.find(trip => trip.id === root.activeTripId);
      if (!t) { t = root.trips[0]; root.activeTripId = t.id; }
      ensureTripShape(t);
      return t;
    }

    function regenerateDays(trip) {
      const start = trip.startDate ? new Date(trip.startDate) : null;
      const days = [];
      for (let i = 0; i < trip.daysCount; i++) {
        let dStr = "";
        if (start) {
          const d = new Date(start);
          d.setDate(d.getDate() + i);
          dStr = d.toISOString().substring(0, 10);
        }
        const id = "day" + (i + 1);
        days.push({ id, label: "Day " + (i + 1), date: dStr });
        if (!trip.itinerary[id]) trip.itinerary[id] = [];
      }
      trip.days = days;
      if (!trip.activeDayId && days.length) trip.activeDayId = days[0].id;
    }

    /* ========= Utils ========= */
    function formatDateMMDD(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return String(m).padStart(2, "0") + "/" + String(day).padStart(2, "0");
    }
    function generateId(prefix) { return prefix + "_" + Math.random().toString(36).slice(2, 9); }
    function parseTimeString(str) {
      if (!str) return "";
      let s = str.trim();
      if (/^\d{1,2}:\d{2}$/.test(s)) return s;
      s = s.replace(/[^\d]/g, "");
      if (!s) return "";
      if (s.length <= 2) return String(Math.min(parseInt(s,10),23)).padStart(2,"0") + ":00";
      if (s.length === 3) {
        const hh = Math.min(parseInt(s.slice(0,1),10),23);
        const mm = Math.min(parseInt(s.slice(1),10),59);
        return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
      }
      const hh = Math.min(parseInt(s.slice(0,2),10),23);
      const mm = Math.min(parseInt(s.slice(2,4),10),59);
      return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
    }
    function debounce(fn, wait) {
      let t = null;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }
    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
      }[m]));
    }

    /* ========= Geocoding / Autocomplete ========= */
    async function nominatimSearch(q, limit = 6) {
      const url =
        "https://nominatim.openstreetmap.org/search" +
        "?format=jsonv2&addressdetails=1&limit=" + encodeURIComponent(limit) +
        "&q=" + encodeURIComponent(q);

      const res = await fetch(url, { headers: { "Accept-Language": "zh-TW,zh;q=0.9,en;q=0.7" } });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    async function geocodePlace(place, cityHint) {
      const q = (cityHint ? `${place} ${cityHint}` : place).trim();
      if (!q) return null;
      const data = await nominatimSearch(q, 1);
      if (!data || !data.length) return null;
      return {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon),
        displayName: data[0].display_name || place
      };
    }

    async function getTripLatLon(trip) {
      if (trip.geo && typeof trip.geo.lat === "number" && typeof trip.geo.lon === "number") return trip.geo;
      const dest = (trip.destination || "").trim();
      if (!dest) return null;
      const geo = await geocodePlace(dest);
      if (!geo) return null;
      trip.geo = { lat: geo.lat, lon: geo.lon };
      saveRoot();
      return trip.geo;
    }

    /* ========= Weather ========= */
    const WEATHER_CODE_MAP = {
      0:{emoji:"â˜€ï¸",text:"æ™´æœ—"},1:{emoji:"ğŸŒ¤",text:"å¤§è‡´æ™´æœ—"},2:{emoji:"â›…ï¸",text:"å¤šé›²æ™‚æ™´"},3:{emoji:"â˜ï¸",text:"å¤šé›²"},
      45:{emoji:"ğŸŒ«",text:"æœ‰éœ§"},48:{emoji:"ğŸŒ«",text:"æœ‰éœ§"},
      51:{emoji:"ğŸŒ¦",text:"æ¯›æ¯›é›¨"},53:{emoji:"ğŸŒ¦",text:"æ¯›æ¯›é›¨"},55:{emoji:"ğŸŒ§",text:"æ¯›æ¯›é›¨"},
      61:{emoji:"ğŸŒ§",text:"å°é›¨"},63:{emoji:"ğŸŒ§",text:"ä¸­é›¨"},65:{emoji:"ğŸŒ§",text:"å¤§é›¨"},
      71:{emoji:"â„ï¸",text:"å°é›ª"},73:{emoji:"â„ï¸",text:"ä¸­é›ª"},75:{emoji:"â„ï¸",text:"å¤§é›ª"},
      80:{emoji:"ğŸŒ§",text:"çŸ­æš«é™£é›¨"},81:{emoji:"ğŸŒ§",text:"é™£é›¨"},82:{emoji:"ğŸŒ§",text:"å¤§é›·é›¨"},95:{emoji:"â›ˆ",text:"é›·é™£é›¨"}
    };

    async function updateDayWeather(trip, dayId) {
      const box = document.getElementById("dayWeatherBox");
      if (!box) return;
      const dayInfo = trip.days.find(d => d.id === dayId);
      if (!dayInfo || !dayInfo.date) { box.innerHTML = `<div class="weather-loading">æ­¤æ—¥å°šæœªè¨­å®šæ—¥æœŸï¼Œç„¡æ³•æŸ¥è©¢å¤©æ°£ã€‚</div>`; return; }
      if (!trip.destination || !trip.destination.trim()) { box.innerHTML = `<div class="weather-loading">è«‹å…ˆåœ¨æ—…ç¨‹è¨­å®šè¼¸å…¥ç›®çš„åœ°åŸå¸‚ï¼Œæ‰èƒ½å–å¾—å¤©æ°£è³‡è¨Šã€‚</div>`; return; }

      box.innerHTML = `<div class="weather-loading">è®€å–å¤©æ°£ä¸­â€¦</div>`;
      try {
        const geo = await getTripLatLon(trip);
        if (!geo) { box.innerHTML = `<div class="weather-loading">æ‰¾ä¸åˆ°ç›®çš„åœ°ä½ç½®ï¼Œè«‹ç¢ºèªç›®çš„åœ°åç¨±æ˜¯å¦æ­£ç¢ºã€‚</div>`; return; }

        const url =
          "https://api.open-meteo.com/v1/forecast" +
          `?latitude=${geo.lat}&longitude=${geo.lon}` +
          "&daily=temperature_2m_max,temperature_2m_min,weathercode" +
          "&timezone=auto" +
          `&start_date=${dayInfo.date}&end_date=${dayInfo.date}`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (!data.daily || !data.daily.time || data.daily.time.length === 0) {
          box.innerHTML = `<div class="weather-loading">æŸ¥ä¸åˆ°é€™ä¸€å¤©çš„å¤©æ°£ï¼ˆå¯èƒ½è¶…å‡ºå¯é å ±ç¯„åœï¼‰ã€‚</div>`; return;
        }
        const maxT = data.daily.temperature_2m_max[0];
        const minT = data.daily.temperature_2m_min[0];
        const code = data.daily.weathercode ? data.daily.weathercode[0] : null;
        const info = WEATHER_CODE_MAP[code] || { emoji: "ğŸŒ¡", text: "å¤©æ°£è³‡è¨Š" };

        box.innerHTML = `
          <div class="weather-main">
            <div class="weather-emoji">${info.emoji}</div>
            <div>
              <div class="weather-temp">${Math.round(minT)}Â° / ${Math.round(maxT)}Â°</div>
              <div class="weather-sub">${escapeHtml(trip.destination)} Â· ${info.text}</div>
            </div>
          </div>
          <div class="weather-sub">è³‡æ–™ä¾†æºï¼šOpen-Meteoï¼ˆæ¯æ—¥æ•´é«”é«˜ / ä½æº«ï¼‰</div>
        `;
      } catch (e) {
        console.error(e);
        box.innerHTML = `<div class="weather-loading">å–å¾—å¤©æ°£å¤±æ•—ï¼Œå¯ä»¥ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚</div>`;
      }
    }

    /* ========= Leaflet Mapï¼ˆåƒ…åœ¨ itineraryInnerTab=map æ™‚æ¸²æŸ“ï¼‰ ========= */
    let dayLeafletMap = null;
    let dayMarkerLayer = null;

    function initLeafletMap() {
      if (dayLeafletMap) return dayLeafletMap;
      dayLeafletMap = L.map("dayMap", { zoomControl: true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap"
      }).addTo(dayLeafletMap);
      dayMarkerLayer = L.layerGroup().addTo(dayLeafletMap);
      return dayLeafletMap;
    }

    async function updateDayMap(trip, dayId) {
      const container = document.getElementById("dayMap");
      if (!container) return;

      const map = initLeafletMap();
      setTimeout(() => map.invalidateSize(), 120);

      dayMarkerLayer.clearLayers();

      const items = (trip.itinerary[dayId] || []).filter(i => i.title && i.title.trim());
      const boundsPoints = [];

      for (const item of items) {
        const title = (item.title || "").trim();
        if (!title) continue;

        let geo = null;

        if (typeof item.lat === "number" && typeof item.lon === "number") {
          geo = { lat: item.lat, lon: item.lon, displayName: item.displayName || item.title };
        } else if (trip.placeCache && trip.placeCache[title]) {
          geo = trip.placeCache[title];
          item.lat = geo.lat; item.lon = geo.lon; item.displayName = geo.displayName || title;
        } else {
          try {
            const result = await geocodePlace(title, trip.destination);
            if (result) {
              geo = { lat: result.lat, lon: result.lon, displayName: result.displayName || title };
              item.lat = geo.lat; item.lon = geo.lon; item.displayName = geo.displayName;
              trip.placeCache[title] = geo;
              saveRoot();
            }
          } catch (e) {
            console.error("geocode å¤±æ•—:", title, e);
          }
        }

        if (geo && typeof geo.lat === "number" && typeof geo.lon === "number") {
          dayMarkerLayer.addLayer(L.marker([geo.lat, geo.lon]).bindPopup(escapeHtml(item.title || geo.displayName || "åœ°é»")));
          boundsPoints.push([geo.lat, geo.lon]);
        }
      }

      if (boundsPoints.length) {
        map.fitBounds(boundsPoints, { padding: [30, 30] });
        return;
      }

      const tripGeo = await getTripLatLon(trip);
      if (tripGeo) {
        dayMarkerLayer.addLayer(L.marker([tripGeo.lat, tripGeo.lon]).bindPopup(escapeHtml(trip.destination || "ç›®çš„åœ°")));
        map.setView([tripGeo.lat, tripGeo.lon], 11);
      } else {
        map.setView([23.5, 121], 6);
      }
    }

    /* ========= èˆªç­ï¼šè‡ªå‹•å¸¶å…¥æ™‚é–“ï¼ˆæŠŠä½ èˆŠç‰ˆé‚è¼¯è²¼å›ä¾†å³å¯ï¼‰ ========= */
    async function fetchFlightTimeByNumber({ flightNo, date, from, to }) {
      // ä½ åŸæœ¬èˆŠç‰ˆã€Œè‡ªå‹•å¸¶å…¥æ™‚é–“ã€æ‡‰è©²æ˜¯æŸ¥æŸå€‹ API æˆ–è§£ææŸå€‹ä¾†æºã€‚
      // è«‹æŠŠé‚£æ®µç¨‹å¼è²¼åˆ°é€™è£¡ï¼Œæœ€å¾Œå›å‚³å­—ä¸² "HH:MM"ï¼ˆä¾‹å¦‚ "09:35"ï¼‰ã€‚
      //
      // ä»¥ä¸‹æä¾›ã€Œå¿«å–å„ªå…ˆã€çµæ§‹ï¼ˆå·²åœ¨å¤–å±¤åšï¼‰ï¼Œé€™è£¡åªè² è²¬æŸ¥ä¸åˆ°æ™‚çš„æŸ¥è©¢ã€‚
      // ç›®å‰å…ˆå›å‚³ nullï¼ˆè¡¨ç¤ºæŸ¥ä¸åˆ°ï¼‰ã€‚
      return null;
    }

    /* ========= DOM ========= */
    const destinationTag = document.getElementById("destinationTag");
    const tripNameText = document.getElementById("tripNameText");
    const dateInfoText = document.getElementById("dateInfoText");
    const rateInfoText = document.getElementById("rateInfoText");
    const mainView = document.getElementById("mainView");

    // Drawer
    const menuButton = document.getElementById("menuButton");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const tripDrawer = document.getElementById("tripDrawer");
    const drawerTripList = document.getElementById("drawerTripList");
    const drawerNewTripBtn = document.getElementById("drawerNewTripBtn");
    const drawerDeleteTripBtn = document.getElementById("drawerDeleteTripBtn");
    const drawerCloseBtn = document.getElementById("drawerCloseBtn");

    // Trip modal
    const editTripBtn = document.getElementById("editTripBtn");
    const tripModalBackdrop = document.getElementById("tripModalBackdrop");
    const tripModalCloseBtn = document.getElementById("tripModalCloseBtn");
    const m_tripName = document.getElementById("m_tripName");
    const m_destination = document.getElementById("m_destination");
    const m_currency = document.getElementById("m_currency");
    const m_startDate = document.getElementById("m_startDate");
    const m_days = document.getElementById("m_days");
    const m_cancelBtn = document.getElementById("m_cancelBtn");
    const m_saveBtn = document.getElementById("m_saveBtn");
    const m_clearTripBtn = document.getElementById("m_clearTripBtn");

    // Itinerary modal
    const itModalBackdrop = document.getElementById("itModalBackdrop");
    const itModalTitle = document.getElementById("itModalTitle");
    const itModalCloseBtn = document.getElementById("itModalCloseBtn");
    const itModalCancelBtn = document.getElementById("itModalCancelBtn");
    const itModalSaveBtn = document.getElementById("itModalSaveBtn");
    const itModalDeleteBtn = document.getElementById("itModalDeleteBtn");
    const itTime = document.getElementById("itTime");
    const itTitle = document.getElementById("itTitle");
    const itNote = document.getElementById("itNote");
    const acList = document.getElementById("acList");

    // Flight modal
    const flModalBackdrop = document.getElementById("flModalBackdrop");
    const flModalCloseBtn = document.getElementById("flModalCloseBtn");
    const flModalCancelBtn = document.getElementById("flModalCancelBtn");
    const flModalSaveBtn = document.getElementById("flModalSaveBtn");
    const flAutoTimeBtn = document.getElementById("flAutoTimeBtn");
    const flNo = document.getElementById("flNo");
    const flTime = document.getElementById("flTime");
    const flFrom = document.getElementById("flFrom");
    const flTo = document.getElementById("flTo");
    const flNote = document.getElementById("flNote");
    const flAutoHint = document.getElementById("flAutoHint");

    /* ========= Header ========= */
    function renderHeader() {
      const trip = getCurrentTrip();
      tripNameText.textContent = trip.name || "æœªå‘½åæ—…ç¨‹";
      destinationTag.textContent = trip.destination || "æœªè¨­å®šç›®çš„åœ°";

      if (trip.startDate && trip.daysCount) {
        const start = new Date(trip.startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + trip.daysCount - 1);
        dateInfoText.textContent = `${trip.daysCount} å¤©è¡Œç¨‹ï½œ${formatDateMMDD(trip.startDate)} - ${formatDateMMDD(end.toISOString().substring(0,10))}`;
      } else {
        dateInfoText.textContent = "è«‹å…ˆè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸";
      }

      const ex = trip.exchangeRate;
      const cur = (trip.currency || "").toUpperCase();
      if (ex && ex.rate && typeof ex.rate === "number" && ex.base === cur && ex.target === "TWD") {
        rateInfoText.innerHTML = `<span>åŒ¯ç‡ï¼š1 ${ex.base} â‰ˆ ${ex.rate.toFixed(2)} TWD</span>`;
      } else {
        if (cur === "TWD") rateInfoText.innerHTML = `<span>åŒ¯ç‡ï¼šä¸»è¦è²¨å¹£ç‚º TWDï¼Œç„¡éœ€æ›ç®—</span>`;
        else rateInfoText.innerHTML = `<span>åŒ¯ç‡å°šæœªè¨­å®š</span>`;
      }
    }

    /* ========= Drawer ========= */
    function openDrawer() { tripDrawer.classList.add("open"); drawerBackdrop.classList.add("show"); renderDrawerTrips(); }
    function closeDrawer() { tripDrawer.classList.remove("open"); drawerBackdrop.classList.remove("show"); }

    menuButton.addEventListener("click", openDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);
    drawerCloseBtn.addEventListener("click", closeDrawer);

    function renderDrawerTrips() {
      const currentId = root.activeTripId;
      drawerTripList.innerHTML = "";
      root.trips.forEach(t => {
        ensureTripShape(t);
        const div = document.createElement("div");
        div.className = "drawer-trip" + (t.id === currentId ? " active" : "");
        div.innerHTML = `
          <div class="drawer-trip-name">${escapeHtml(t.name || "æœªå‘½åæ—…ç¨‹")}</div>
          <div class="drawer-trip-sub">${t.daysCount || 0} å¤© Â· ${t.startDate ? formatDateMMDD(t.startDate) : "æ—¥æœŸæœªè¨­å®š"}</div>
        `;
        div.addEventListener("click", () => {
          root.activeTripId = t.id;
          saveRoot();
          renderCurrentMainView();
          closeDrawer();
        });
        drawerTripList.appendChild(div);
      });
    }

    drawerNewTripBtn.addEventListener("click", () => {
      const name = "æ–°æ—…ç¨‹ " + (root.trips.length + 1);
      const trip = createEmptyTrip(name);
      regenerateDays(trip);
      root.trips.push(trip);
      root.activeTripId = trip.id;
      saveRoot();
      renderCurrentMainView();
      renderDrawerTrips();
    });

    drawerDeleteTripBtn.addEventListener("click", () => {
      if (root.trips.length <= 1) { alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹ï¼Œç„¡æ³•å…¨éƒ¨åˆªå…‰ã€‚"); return; }
      const trip = getCurrentTrip();
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${trip.name}ã€é€™å€‹æ—…ç¨‹å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) return;
      root.trips = root.trips.filter(t => t.id !== trip.id);
      root.activeTripId = root.trips[0].id;
      saveRoot();
      renderCurrentMainView();
      renderDrawerTrips();
    });

    /* ========= Trip Modal ========= */
    function openTripModal() {
      const trip = getCurrentTrip();
      m_tripName.value = trip.name || "";
      m_destination.value = trip.destination || "";
      m_currency.value = trip.currency || "JPY";
      m_startDate.value = trip.startDate || "";
      m_days.value = trip.daysCount || 4;
      tripModalBackdrop.classList.add("show");
    }
    function closeTripModal() { tripModalBackdrop.classList.remove("show"); }

    editTripBtn.addEventListener("click", openTripModal);
    tripModalCloseBtn.addEventListener("click", closeTripModal);
    m_cancelBtn.addEventListener("click", closeTripModal);
    tripModalBackdrop.addEventListener("click", (e) => { if (e.target === tripModalBackdrop) closeTripModal(); });

    m_clearTripBtn.addEventListener("click", () => {
      const trip = getCurrentTrip();
      if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ—…ç¨‹çš„è¡Œç¨‹ã€èˆªç­ã€è¨˜å¸³èˆ‡è³¼ç‰©è³‡æ–™å—ï¼Ÿ")) return;
      trip.itinerary = {};
      trip.flights = [];
      trip.checklist = [];
      trip.expenses = [];
      trip.shopping = [];
      trip.placeCache = {};
      trip.flightTimeCache = {};
      trip.geo = null;
      regenerateDays(trip);
      saveRoot();
      renderCurrentMainView();
      closeTripModal();
    });

    m_saveBtn.addEventListener("click", async () => {
      const trip = getCurrentTrip();
      const oldCurrency = trip.currency || "JPY";
      const oldDestination = trip.destination || "";

      trip.name = (m_tripName.value || "").trim() || "æœªå‘½åæ—…ç¨‹";
      trip.destination = (m_destination.value || "").trim();
      trip.currency = m_currency.value;
      trip.startDate = m_startDate.value;

      let n = parseInt(m_days.value, 10);
      if (isNaN(n)) n = 1;
      trip.daysCount = Math.max(1, Math.min(30, n));
      regenerateDays(trip);

      if (oldDestination !== trip.destination) { trip.geo = null; trip.placeCache = {}; }

      if (oldCurrency !== trip.currency) {
        trip.exchangeRate = { base: trip.currency, target: "TWD", rate: null, updatedAt: "" };
        if (trip.currency !== "TWD") {
          try {
            const result = await fetchRateToTWD(trip.currency);
            trip.exchangeRate = { base: trip.currency, target: "TWD", rate: result.rate, updatedAt: result.updatedAt };
          } catch (err) {
            console.error(err);
            alert("å·²å„²å­˜æ—…ç¨‹è¨­å®šï¼Œä½†è‡ªå‹•æŠ“åŒ¯ç‡å¤±æ•—ã€‚\nåŸå› ï¼š" + err.message);
          }
        }
      }

      saveRoot();
      renderCurrentMainView();
      closeTripModal();
    });

    /* ========= Sticky Day Header ========= */
    function renderDayHeader(trip, showInnerTabs) {
      if (!trip.days || trip.days.length === 0) return "";

      let chipsHtml = `
        <div class="day-chips" id="dayChips">
          <div class="chip ${trip.activeDayId === "prep" ? "active" : ""}" data-day-id="prep">
            <strong>è¡Œå‰</strong><span>å¾…è¾¦æ¸…å–®</span>
          </div>
      `;
      trip.days.forEach(d => {
        chipsHtml += `
          <div class="chip ${d.id === trip.activeDayId ? "active" : ""}" data-day-id="${d.id}">
            <strong>${escapeHtml(d.label)}</strong><span>${formatDateMMDD(d.date)}</span>
          </div>
        `;
      });
      chipsHtml += `</div>`;

      const innerTabsHtml = showInnerTabs ? `
        <div class="inner-tabs" id="itInnerTabs">
          <button class="inner-tab ${itineraryInnerTab === "plan" ? "active" : ""}" data-inner="plan">è¡Œç¨‹</button>
          <button class="inner-tab ${itineraryInnerTab === "map" ? "active" : ""}" data-inner="map">åœ°åœ–</button>
        </div>
      ` : "";

      return `
        <div class="it-sticky">
          <div class="card-header">
            <div class="card-title">æ¯æ—¥è¡Œç¨‹</div>
            <div class="pill"><span>ğŸ“</span><span>${escapeHtml(trip.destination || "ç›®çš„åœ°æœªè¨­å®š")}</span></div>
          </div>
          ${chipsHtml}
          ${innerTabsHtml}
        </div>
      `;
    }

    function bindDayHeaderEvents(trip, onChanged) {
      document.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const id = chip.getAttribute("data-day-id");
          trip.activeDayId = id;
          saveRoot();
          onChanged();
        });
      });

      const tabs = document.getElementById("itInnerTabs");
      if (tabs) {
        tabs.querySelectorAll("[data-inner]").forEach(btn => {
          btn.addEventListener("click", () => {
            const inner = btn.getAttribute("data-inner");
            if (inner === itineraryInnerTab) return;
            itineraryInnerTab = inner;
            saveRoot();
            onChanged();

            if (itineraryInnerTab === "map") {
              const dayId = trip.activeDayId;
              if (dayId && dayId !== "prep") {
                setTimeout(() => updateDayMap(trip, dayId), 150);
              }
            }
          });
        });
      }
    }

    /* ========= è¡Œå‰ ========= */
    function renderPrepList(trip) {
      const container = document.getElementById("prepList");
      if (!container) return;
      if (!trip.checklist || trip.checklist.length === 0) { container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰è¡Œå‰å¾…è¾¦ï¼Œå¯ä»¥åœ¨ä¸Šæ–¹æ–°å¢ã€‚</div>`; return; }

      container.innerHTML = trip.checklist.map(item => `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;">
          <input type="checkbox" data-prep-id="${item.id}" ${item.done ? "checked" : ""} style="width:18px;height:18px;"/>
          <div style="flex:1;${item.done ? "text-decoration:line-through;color:#9ca3af;" : ""}">${escapeHtml(item.text)}</div>
          <button class="btn btn-danger btn-icon" data-prep-del="${item.id}">âœ•</button>
        </div>
      `).join("");

      container.querySelectorAll("[data-prep-id]").forEach(cb => {
        cb.addEventListener("change", () => {
          const id = cb.getAttribute("data-prep-id");
          const target = trip.checklist.find(i => i.id === id);
          if (target) { target.done = cb.checked; saveRoot(); renderPrepList(trip); }
        });
      });
      container.querySelectorAll("[data-prep-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-prep-del");
          trip.checklist = trip.checklist.filter(i => i.id !== id);
          saveRoot();
          renderPrepList(trip);
        });
      });
    }

    /* ========= Itinerary Modal ========= */
    function openItineraryModalAdd(trip, dayId) {
      itModalMode = "add";
      itModalDayId = dayId;
      itEditingId = null;
      selectedPlaceForItinerary = null;

      itModalTitle.textContent = "æ–°å¢è¡Œç¨‹";
      itModalDeleteBtn.style.display = "none";
      itTime.value = "";
      itTitle.value = "";
      itNote.value = "";

      itModalBackdrop.classList.add("show");
      bindAutocomplete(trip); // é–‹å•Ÿæ™‚ç¶å®šå»ºè­°æœå°‹
      setTimeout(() => itTitle.focus(), 80);
    }

    function openItineraryModalEdit(trip, dayId, itemId) {
      const item = (trip.itinerary[dayId] || []).find(i => i.id === itemId);
      if (!item) return;
      itModalMode = "edit";
      itModalDayId = dayId;
      itEditingId = itemId;
      selectedPlaceForItinerary = null;

      itModalTitle.textContent = "ç·¨è¼¯è¡Œç¨‹";
      itModalDeleteBtn.style.display = "inline-flex";
      itTime.value = item.time || "";
      itTitle.value = item.title || "";
      itNote.value = item.note || "";

      itModalBackdrop.classList.add("show");
      bindAutocomplete(trip);
      setTimeout(() => itTitle.focus(), 80);
    }

    function closeItineraryModal() {
      itModalBackdrop.classList.remove("show");
      if (acList) { acList.style.display = "none"; acList.innerHTML = ""; }
    }

    itModalCloseBtn.addEventListener("click", closeItineraryModal);
    itModalCancelBtn.addEventListener("click", closeItineraryModal);
    itModalBackdrop.addEventListener("click", (e) => { if (e.target === itModalBackdrop) closeItineraryModal(); });

    itTime.addEventListener("blur", () => { if (itTime.value) itTime.value = parseTimeString(itTime.value); });

    itModalSaveBtn.addEventListener("click", async () => {
      const trip = getCurrentTrip();
      const dayId = itModalDayId;
      if (!dayId) return;

      const time = parseTimeString(itTime.value);
      const title = (itTitle.value || "").trim();
      const note = (itNote.value || "").trim();

      if (!title && !time && !note) { closeItineraryModal(); return; }

      let lat = null, lon = null, displayName = null;
      if (selectedPlaceForItinerary && selectedPlaceForItinerary.title === title) {
        lat = selectedPlaceForItinerary.lat; lon = selectedPlaceForItinerary.lon; displayName = selectedPlaceForItinerary.displayName;
      } else if (trip.placeCache && trip.placeCache[title]) {
        lat = trip.placeCache[title].lat; lon = trip.placeCache[title].lon; displayName = trip.placeCache[title].displayName;
      } else if (title) {
        try {
          const geo = await geocodePlace(title, trip.destination);
          if (geo) { lat = geo.lat; lon = geo.lon; displayName = geo.displayName || title; trip.placeCache[title] = { lat, lon, displayName }; }
        } catch (e) { console.error(e); }
      }

      if (!trip.itinerary[dayId]) trip.itinerary[dayId] = [];

      if (itModalMode === "edit" && itEditingId) {
        const target = trip.itinerary[dayId].find(i => i.id === itEditingId);
        if (target) {
          target.time = time;
          target.title = title || "æœªå‘½åè¡Œç¨‹";
          target.note = note;
          if (typeof lat === "number" && typeof lon === "number") {
            target.lat = lat; target.lon = lon; target.displayName = displayName || target.displayName || target.title;
          }
        }
      } else {
        trip.itinerary[dayId].push({
          id: generateId("it"),
          time,
          title: title || "æœªå‘½åè¡Œç¨‹",
          note,
          lat: (typeof lat === "number" ? lat : undefined),
          lon: (typeof lon === "number" ? lon : undefined),
          displayName: displayName || undefined
        });
      }

      saveRoot();
      closeItineraryModal();
      renderItineraryView();
    });

    itModalDeleteBtn.addEventListener("click", () => {
      const trip = getCurrentTrip();
      const dayId = itModalDayId;
      if (!dayId || !itEditingId) return;
      trip.itinerary[dayId] = (trip.itinerary[dayId] || []).filter(i => i.id !== itEditingId);
      saveRoot();
      closeItineraryModal();
      renderItineraryView();
    });

    /* ========= Autocompleteï¼ˆè¡Œç¨‹å½ˆçª—å…§ï¼‰ ========= */
    function bindAutocomplete(trip) {
      selectedPlaceForItinerary = null;
      const input = itTitle;
      const listEl = acList;
      if (!input || !listEl) return;

      const hideList = () => { listEl.style.display = "none"; listEl.innerHTML = ""; };
      const renderList = (items) => {
        if (!items || items.length === 0) { hideList(); return; }
        listEl.innerHTML = items.map(it => {
          const main = (it.display_name || "").split(",")[0] || it.display_name || "";
          const sub = it.display_name || "";
          return `
            <div class="ac-item" data-lat="${it.lat}" data-lon="${it.lon}"
                 data-display="${encodeURIComponent(it.display_name || main)}"
                 data-main="${encodeURIComponent(main)}">
              <div class="ac-main">${escapeHtml(main)}</div>
              <div class="ac-sub">${escapeHtml(sub)}</div>
            </div>
          `;
        }).join("");
        listEl.style.display = "block";

        listEl.querySelectorAll(".ac-item").forEach(row => {
          row.addEventListener("click", () => {
            const lat = parseFloat(row.getAttribute("data-lat"));
            const lon = parseFloat(row.getAttribute("data-lon"));
            const display = decodeURIComponent(row.getAttribute("data-display") || "");
            const main = decodeURIComponent(row.getAttribute("data-main") || "");

            input.value = main || display;
            selectedPlaceForItinerary = { lat, lon, title: (main || display || "").trim(), displayName: display || main };

            if (selectedPlaceForItinerary.title) {
              trip.placeCache[selectedPlaceForItinerary.title] = { lat, lon, displayName: selectedPlaceForItinerary.displayName };
              saveRoot();
            }
            hideList();
          });
        });
      };

      const doSearch = debounce(async () => {
        const keyword = (input.value || "").trim();
        if (!keyword) { hideList(); selectedPlaceForItinerary = null; return; }
        const hint = (trip.destination || "").trim();
        const q = hint ? `${keyword} ${hint}` : keyword;
        try {
          const data = await nominatimSearch(q, 6);
          renderList(data || []);
        } catch (e) { console.error(e); hideList(); }
      }, 220);

      input.oninput = () => { selectedPlaceForItinerary = null; doSearch(); };

      // é»å½ˆçª—å…§å…¶ä»–åœ°æ–¹é—œé–‰å»ºè­°æ¸…å–®
      itModalBackdrop.addEventListener("click", (e) => {
        if (e.target === itModalBackdrop) return;
        if (!listEl.contains(e.target) && e.target !== input) hideList();
      });
    }

    /* ========= Flight Modal ========= */
    function openFlightModal(trip, dayDate) {
      flModalDayDate = dayDate;
      flNo.value = "";
      flTime.value = "";
      flFrom.value = "";
      flTo.value = "";
      flNote.value = "";
      flModalBackdrop.classList.add("show");
      setTimeout(() => flNo.focus(), 80);
    }
    function closeFlightModal() { flModalBackdrop.classList.remove("show"); }

    flModalCloseBtn.addEventListener("click", closeFlightModal);
    flModalCancelBtn.addEventListener("click", closeFlightModal);
    flModalBackdrop.addEventListener("click", (e) => { if (e.target === flModalBackdrop) closeFlightModal(); });

    flTime.addEventListener("blur", () => { if (flTime.value) flTime.value = parseTimeString(flTime.value); });

    flAutoTimeBtn.addEventListener("click", async () => {
      const trip = getCurrentTrip();
      const date = flModalDayDate;
      const flightNo = (flNo.value || "").trim().toUpperCase();
      const from = (flFrom.value || "").trim().toUpperCase();
      const to = (flTo.value || "").trim().toUpperCase();

      if (!date) { alert("æ­¤æ—¥å°šæœªè¨­å®šæ—¥æœŸï¼Œç„¡æ³•è‡ªå‹•å¸¶å…¥æ™‚é–“ã€‚è«‹å…ˆåˆ°æ—…ç¨‹è¨­å®šè¼¸å…¥å‡ºç™¼æ—¥æœŸã€‚"); return; }
      if (!flightNo) { alert("è«‹å…ˆè¼¸å…¥ç­æ©Ÿè™Ÿã€‚"); return; }

      const cacheKey = `${date}|${flightNo}`;
      if (trip.flightTimeCache && trip.flightTimeCache[cacheKey]) {
        flTime.value = trip.flightTimeCache[cacheKey];
        return;
      }

      flAutoTimeBtn.disabled = true;
      flAutoTimeBtn.textContent = "è®€å–ä¸­â€¦";
      try {
        const t = await fetchFlightTimeByNumber({ flightNo, date, from, to });
        if (t && typeof t === "string") {
          const normalized = parseTimeString(t);
          flTime.value = normalized;
          trip.flightTimeCache[cacheKey] = normalized;
          saveRoot();
        } else {
          alert("æŸ¥ä¸åˆ°æ­¤ç­æ©Ÿçš„æ™‚é–“ã€‚è«‹æ‰‹å‹•è¼¸å…¥ï¼Œæˆ–æŠŠä½ èˆŠç‰ˆçš„æŸ¥è©¢ç¨‹å¼è²¼å› fetchFlightTimeByNumber()ã€‚");
        }
      } catch (e) {
        console.error(e);
        alert("è‡ªå‹•å¸¶å…¥æ™‚é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ‰‹å‹•è¼¸å…¥ã€‚");
      } finally {
        flAutoTimeBtn.disabled = false;
        flAutoTimeBtn.textContent = "è‡ªå‹•å¸¶å…¥";
      }
    });

    flModalSaveBtn.addEventListener("click", () => {
      const trip = getCurrentTrip();
      const dayDate = flModalDayDate;

      if (!dayDate) { alert("æ­¤æ—¥å°šæœªè¨­å®šæ—¥æœŸï¼Œç„¡æ³•æ–°å¢èˆªç­ã€‚è«‹å…ˆåˆ°æ—…ç¨‹è¨­å®šè¼¸å…¥å‡ºç™¼æ—¥æœŸã€‚"); return; }

      const flightNo = (flNo.value || "").trim().toUpperCase();
      const time = parseTimeString((flTime.value || "").trim());
      const from = (flFrom.value || "").trim().toUpperCase();
      const to = (flTo.value || "").trim().toUpperCase();
      const note = (flNote.value || "").trim();

      if (!flightNo && !from && !to && !time && !note) { closeFlightModal(); return; }

      trip.flights.push({ id: generateId("fl"), date: dayDate, flightNo, from, to, time, note });
      saveRoot();
      closeFlightModal();
      renderItineraryView();
    });

    /* ========= Itinerary View ========= */
    function renderItineraryView() {
      const trip = getCurrentTrip();
      if (!trip.days || trip.days.length === 0) {
        mainView.innerHTML = `<section class="card"><div class="empty">è«‹å…ˆåœ¨æ—…ç¨‹è¨­å®šè¨­å®šæ—¥æœŸèˆ‡å¤©æ•¸</div></section>`;
        return;
      }

      mainView.innerHTML = `
        <section class="card itinerary-card">
          ${renderDayHeader(trip, true)}
          <div class="it-body" id="dayContent"></div>
        </section>
      `;

      bindDayHeaderEvents(trip, () => renderItineraryView());
      renderDayContent(trip);
    }

    function renderDayContent(trip) {
      const container = document.getElementById("dayContent");
      if (!container) return;

      let dayId = trip.activeDayId;
      if (!dayId || (dayId !== "prep" && !trip.days.some(d => d.id === dayId))) {
        dayId = trip.days[0]?.id;
        trip.activeDayId = dayId;
      }

      // è¡Œå‰
      if (dayId === "prep") {
        container.innerHTML = `
          <div>
            <div class="small-label">æ–°å¢ä¸€é …è¡Œå‰æº–å‚™</div>
            <div class="row">
              <div class="col">
                <input id="prepInput" placeholder="ä¾‹å¦‚ï¼šè¾¦æ—…éŠä¿éšªã€æ›å¤–å¹£ã€è²·ç¶²å¡â€¦" />
              </div>
              <button class="btn btn-primary btn-icon" id="addPrepBtn">ï¼‹</button>
            </div>
            <div style="margin-top:10px;">
              <div class="small-label">è¡Œå‰æº–å‚™æ¸…å–®</div>
              <div id="prepList"></div>
            </div>
          </div>
        `;
        renderPrepList(trip);

        document.getElementById("addPrepBtn").addEventListener("click", () => {
          const input = document.getElementById("prepInput");
          const text = input.value.trim();
          if (!text) return;
          trip.checklist.push({ id: generateId("prep"), text, done: false });
          input.value = "";
          saveRoot();
          renderPrepList(trip);
        });
        return;
      }

      // å…±ç”¨ï¼šå¤©æ°£ + èˆªç­
      const dayInfo = trip.days.find(d => d.id === dayId);
      const dayDate = dayInfo?.date || "";
      const dayFlights = (trip.flights || []).filter(f => (f.date || "") === dayDate);

      if (itineraryInnerTab === "map") {
        container.innerHTML = `
          <div>
            <div class="small-label">ç•¶æ—¥å¤©æ°£</div>
            <div id="dayWeatherBox" class="weather-box"><div class="weather-loading">è®€å–å¤©æ°£ä¸­â€¦</div></div>

            <div class="small-label">ç•¶æ—¥è¡Œç¨‹åœ°åœ–ï¼ˆä¾è¡Œç¨‹è‡ªå‹•é‡˜é¸ï¼‰</div>
            <div id="dayMap" class="map-container"></div>

            <div style="margin-top:12px;">
              <div class="card-header" style="margin-bottom:6px;">
                <div class="card-title">ç•¶æ—¥èˆªç­</div>
                <div style="font-size:11px;color:var(--text-sub);">${dayDate ? formatDateMMDD(dayDate) : ""}</div>
              </div>

              ${
                dayFlights.length
                  ? `<div class="list">
                      ${dayFlights.map(f => `
                        <div class="list-item">
                          <div class="list-main">
                            <div class="list-meta">${escapeHtml(f.time || "")} ${f.flightNo ? "Â· " + escapeHtml(f.flightNo) : ""}</div>
                            <div class="list-title">${escapeHtml((f.from || "???") + " â†’ " + (f.to || "???"))}</div>
                            ${f.note ? `<div class="list-note">${escapeHtml(f.note)}</div>` : ""}
                          </div>
                          <div style="display:flex;gap:4px;">
                            <button class="btn btn-danger btn-icon" data-del-flight="${f.id}">âœ•</button>
                          </div>
                        </div>
                      `).join("")}
                    </div>`
                  : `<div class="empty" style="padding-top:6px;">æœ¬æ—¥å°šæœªæ–°å¢èˆªç­ã€‚</div>`
              }

              <div style="text-align:right;margin-top:8px;">
                <button class="btn btn-primary" id="openFlightModalBtn">ï¼‹ æ–°å¢èˆªç­</button>
              </div>
            </div>
          </div>
        `;

        updateDayWeather(trip, dayId);
        setTimeout(() => updateDayMap(trip, dayId), 160);

        container.querySelectorAll("[data-del-flight]").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-del-flight");
            trip.flights = (trip.flights || []).filter(f => f.id !== id);
            saveRoot();
            renderItineraryView();
          });
        });

        const addFlBtn = document.getElementById("openFlightModalBtn");
        addFlBtn?.addEventListener("click", () => openFlightModal(trip, dayDate));
        return;
      }

      // è¡Œç¨‹é ï¼šè®Šç°¡æ½”ï¼ˆä¸é¡¯ç¤ºè¼¸å…¥æ¬„ä½ï¼‰ï¼Œåªä¿ç•™ã€Œæ–°å¢è¡Œç¨‹ã€æŒ‰éˆ• + æ¸…å–®
      const list = (trip.itinerary[dayId] || []).slice().sort((a, b) => (a.time || "").localeCompare(b.time || ""));

      let listHtml = "";
      if (list.length === 0) listHtml = `<div class="empty">é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œé»ä¸‹æ–¹ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹æ–°å¢ï½</div>`;
      else {
        listHtml = `<div class="list">` + list.map(item => `
          <div class="list-item">
            <div class="list-main">
              <div class="list-meta">${escapeHtml(item.time || "æ™‚é–“æœªå¡«å¯«")}</div>
              <div class="list-title">${escapeHtml(item.title || "æœªå‘½åè¡Œç¨‹")}</div>
              ${item.note ? `<div class="list-note">${escapeHtml(item.note)}</div>` : ""}
            </div>
            <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
              <button class="btn btn-ghost btn-sm" data-open-map="${item.id}">å°èˆª</button>
              <button class="btn btn-ghost btn-sm" data-edit-it="${item.id}">ç·¨è¼¯</button>
              <button class="btn btn-danger btn-icon" data-del-it="${item.id}">âœ•</button>
            </div>
          </div>
        `).join("") + `</div>`;
      }

      container.innerHTML = `
        <div>
          <div class="small-label">ç•¶æ—¥å¤©æ°£</div>
          <div id="dayWeatherBox" class="weather-box"><div class="weather-loading">è®€å–å¤©æ°£ä¸­â€¦</div></div>

          <div class="card-header" style="margin-top:4px;">
            <div class="card-title">ç•¶æ—¥è¡Œç¨‹</div>
            <button class="btn btn-primary" id="openItModalBtn">ï¼‹ æ–°å¢è¡Œç¨‹</button>
          </div>

          ${listHtml}

          <div style="margin-top:12px;">
            <div class="card-header" style="margin-bottom:6px;">
              <div class="card-title">ç•¶æ—¥èˆªç­</div>
              <button class="btn btn-primary" id="openFlightModalBtn">ï¼‹ æ–°å¢èˆªç­</button>
            </div>

            ${
              dayFlights.length
                ? `<div class="list">
                    ${dayFlights.map(f => `
                      <div class="list-item">
                        <div class="list-main">
                          <div class="list-meta">${escapeHtml(f.time || "")} ${f.flightNo ? "Â· " + escapeHtml(f.flightNo) : ""}</div>
                          <div class="list-title">${escapeHtml((f.from || "???") + " â†’ " + (f.to || "???"))}</div>
                          ${f.note ? `<div class="list-note">${escapeHtml(f.note)}</div>` : ""}
                        </div>
                        <div style="display:flex;gap:4px;">
                          <button class="btn btn-danger btn-icon" data-del-flight="${f.id}">âœ•</button>
                        </div>
                      </div>
                    `).join("")}
                  </div>`
                : `<div class="empty" style="padding-top:6px;">æœ¬æ—¥å°šæœªæ–°å¢èˆªç­ã€‚</div>`
            }
          </div>
        </div>
      `;

      updateDayWeather(trip, dayId);

      // æ–°å¢è¡Œç¨‹ï¼šé–‹å½ˆçª—
      document.getElementById("openItModalBtn")?.addEventListener("click", () => openItineraryModalAdd(trip, dayId));

      // èˆªç­ï¼šé–‹å½ˆçª—
      document.getElementById("openFlightModalBtn")?.addEventListener("click", () => openFlightModal(trip, dayDate));

      // è¡Œç¨‹æ¸…å–®æ“ä½œ
      container.querySelectorAll("[data-del-it]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del-it");
          trip.itinerary[dayId] = (trip.itinerary[dayId] || []).filter(i => i.id !== id);
          saveRoot();
          renderItineraryView();
        });
      });
      container.querySelectorAll("[data-edit-it]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit-it");
          openItineraryModalEdit(trip, dayId, id);
        });
      });
      container.querySelectorAll("[data-open-map]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-open-map");
          const item = (trip.itinerary[dayId] || []).find(i => i.id === id);
          const q = encodeURIComponent(item?.title || trip.destination || "æ™¯é»");
          window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
        });
      });

      // èˆªç­åˆªé™¤
      container.querySelectorAll("[data-del-flight]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del-flight");
          trip.flights = (trip.flights || []).filter(f => f.id !== id);
          saveRoot();
          renderItineraryView();
        });
      });
    }

    /* ========= è¨˜å¸³ / è³¼ç‰©ï¼ˆç°¡ç‰ˆï¼‰ ========= */
    function renderExpensesView() {
      mainView.innerHTML = `
        <section class="card">
          <div class="card-header"><div class="card-title">è¨˜å¸³</div></div>
          <div class="empty">ï¼ˆæ­¤ç‰ˆä¿ç•™ç°¡åŒ–è¨˜å¸³é¡¯ç¤ºï¼›ä½ çš„æ—¢æœ‰è¨˜å¸³é‚è¼¯å¯å†ç§»å›ä¾†ï¼‰</div>
        </section>
      `;
    }
    function renderShoppingView() {
      mainView.innerHTML = `
        <section class="card">
          <div class="card-header"><div class="card-title">è³¼ç‰©</div></div>
          <div class="empty">ï¼ˆæ­¤ç‰ˆä¿ç•™ç°¡åŒ–è³¼ç‰©é¡¯ç¤ºï¼›ä½ çš„æ—¢æœ‰è³¼ç‰©é‚è¼¯å¯å†ç§»å›ä¾†ï¼‰</div>
        </section>
      `;
    }

    /* ========= Main Switch ========= */
    function renderCurrentMainView() {
      if (currentTab === "itinerary") renderItineraryView();
      else if (currentTab === "expenses") renderExpensesView();
      else if (currentTab === "shopping") renderShoppingView();
    }

    /* ========= Bottom Tabs ========= */
    document.querySelectorAll(".bottom-tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        currentTab = tab.getAttribute("data-tab");
        document.querySelectorAll(".bottom-tab").forEach(x=>x.classList.toggle("active", x===tab));
        renderCurrentMainView();
      });
    });

    /* ========= åˆå§‹åŒ– ========= */
    (function init() {
      const trip = getCurrentTrip();
      if (!trip.days || trip.days.length === 0) regenerateDays(trip);
      renderHeader();
      renderDrawerTrips();
      renderCurrentMainView();
    })();
  </script>

  <script>
    /* ========= Drawer eventsï¼ˆæ”¾æœ€å¾Œé¿å… hoist æ··äº‚ï¼‰ ========= */
    function openDrawer() { tripDrawer.classList.add("open"); drawerBackdrop.classList.add("show"); renderDrawerTrips(); }
    function closeDrawer() { tripDrawer.classList.remove("open"); drawerBackdrop.classList.remove("show"); }

    menuButton.addEventListener("click", openDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);
    drawerCloseBtn.addEventListener("click", closeDrawer);
  </script>
</body>
</html>
